<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Distributed Aggregation Protocol for Privacy Preserving Measurement</title>
<meta content="Tim Geoghegan" name="author">
<meta content="Christopher Patton" name="author">
<meta content="Brandon Pitman" name="author">
<meta content="Eric Rescorla" name="author">
<meta content="Christopher A. Wood" name="author">
<meta content="
       There are many situations in which it is desirable to take measurements of data
which people consider sensitive. In these cases, the entity taking the
measurement is usually not interested in people's individual responses but
rather in aggregated data. Conventional methods require collecting individual
responses and then aggregating them on some server, thus representing a threat
to user privacy and rendering many such measurements difficult and impractical.
This document describes a multi-party Distributed Aggregation Protocol (DAP) for
privacy preserving measurement which can be used to collect aggregate data
without revealing any individual contributor's data. 
    " name="description">
<meta content="xml2rfc 3.31.0" name="generator">
<meta content="draft-ietf-ppm-dap-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.31.0
    Python 3.12.12
    ConfigArgParse 1.7
    google-i18n-address 3.1.1
    intervaltree 3.2.1
    Jinja2 3.1.6
    lxml 6.0.2
    platformdirs 4.5.1
    pycountry 24.6.1
    PyYAML 6.0.3
    requests 2.32.5
    wcwidth 0.3.0
-->
<link href="draft-ietf-ppm-dap.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
}

@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: italic;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-greek.woff2') format('woff2');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Sofia Sans Semi Condensed';
  font-style: normal;
  font-weight: 1 1000;
  src: url('https://martinthomson.github.io/rfc-css/fonts/sofiasanssemicondensed-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  --font-title: "Sofia Sans Semi Condensed", sans-serif;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
section {
  clear: both;
}
.section-number {
  padding-right: 0.5em;
}
h1, h2, h3, h4, h5, h6 {
  font-family: var(--font-title);
  font-weight: 680;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
  vertical-align: top;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
  & :is(ol, ul) {
    margin-left: 1em;
  }
}
li {
  margin: 0 0 0.25em 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
  & li {
    margin-top: 0.5em;
  }
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  margin: 0 0 0 2em;
  & li {
    margin: 0;
    & :first-child { margin-top: 0; }
    & :last-child { margin-bottom: 0; }
  }
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
  &.olPercent {
    --indent: 5ch;
    & > dt {
      min-width: calc(var(--indent) - 2ch);
    }
  }
  &.olPercent > dt {
    float: none;
  }

  dl > dd > & {
    margin-top: 0.5em;
    margin-bottom: 0;
  }
}
dl:not(.dlNewline) > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
  & > :is(:first-child, .break:first-child + *) {
    margin-top: 0;
  }
  & > :is(:last-child) {
    margin-bottom: 0;
  }
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
  caption-side: bottom;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    /* In the horizontal direction, sometimes people make over-sized figures.
       Scrollbars for those is therefore necessary: auto adds them as necessary..
       In the vertical direction, the line-height can combine with the font
       asender/descender height to produce scrollbars: hidden avoids that. */
    overflow: auto hidden;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
  border-left: 2px var(--pilcrow-strong) solid;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: auto;
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
  &[href] {
    color: var(--pilcrow-weak);
    &:hover { text-decoration: none; }
  }
}
@media not print {
  :hover > a.pilcrow, a.pilcrow:focus {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
  & dt {
    width: var(--identifier-width);
    min-width: var(--identifier-width);
    clear: left;
    float: left;
    text-align: right;
    margin-right: 1ch;
  }
  & dd {
    margin: 0;
    margin-left: calc(1em + var(--identifier-width)) !important;
    min-width: 5em;
  }
  & .authors {
    & .author {
      display: inline-block;
      margin-right: 1.5em;
    }
    & .org {
      font-style: italic;
    }
  }
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;

  & nav {
    & ul {
      margin: 0 0.5em 0 0;
      padding: 0;
      list-style: none;
    }
    & li {
      line-height: 1.3em;
      margin: 2px 0;
      padding-left: 1.2em;
      text-indent: -1.2em;
    }
  }
  & a.xref {
    white-space: normal;
  }
}

.references {
  & > dt {
    text-align: right;
    font-weight: bold;
    min-width: 10ch;
    margin-right: 1.5ch;
    &:target::before {
      content: "⇒";
      margin: 0 10px 0 -25px;
    }
  }
  & > dd {
    margin-left: 12ch !important;
    overflow: visible;
    & .refInstance {
      margin-bottom: 0.8em;
    }
    & .ascii {
      margin-bottom: 0.25em;
    }
  }
}

#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  max-width: 20em;
  margin: 1em auto 1em 0;

  & .nameRole {
    font-weight: 700;
    margin-left: 0;
  }
  & .label {
    margin: 0.5em 0;
  }
  & .type {
    display: none;
  }
  & .alternative-contact {
    margin: 0.5em 0 0.25em 0;
  }
  & .non-ascii {
    margin: 0 0 0 2em;
  }
  & div.left {
    text-align: left;
  }
  & div.right {
    text-align: right;
  }
}

hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

/* Comments */
.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}

@media screen {
  #toc nav {
    font-family: var(--font-title);
    font-weight: 360;
    & > ul { margin-bottom: 2em; }
    & ul {
      margin: 0 0 0 4px;
      & :is(p, li) {
        margin: 2px 0;
      }
    }
  }
  #toc a.toplink {
    float: right;
  }
}
@media not screen {
  #toc a.toplink {
    display: none;
  }
}


/* TOC layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
    &::before { /* css hamburger */
      float: right;
      position: relative;
      width: 1em;
      height: 1px;
      left: -164px;
      margin: 8px 0 0 0;
      background: white none repeat scroll 0 0;
      box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
      content: "";
    }
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active {
    opacity: 1;
    & nav { display: block; }
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:is(:link, :focus, :hover),
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin: 2px 0.5em 0;
  }
}

/* TOC layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
  #toc a.toplink {
    margin: 8px 0.5em 0;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">DAP</td>
<td class="right">February 2026</td>
</tr></thead>
<tfoot><tr>
<td class="left">Geoghegan, et al.</td>
<td class="center">Expires 17 August 2026</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-ppm-dap-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2026-02-13" class="published">13 February 2026</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2026-08-17">17 August 2026</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">T. Geoghegan</div>
<div class="org">ISRG</div>
</div>
<div class="author">
      <div class="author-name">C. Patton</div>
<div class="org">Cloudflare</div>
</div>
<div class="author">
      <div class="author-name">B. Pitman</div>
<div class="org">ISRG</div>
</div>
<div class="author">
      <div class="author-name">E. Rescorla</div>
<div class="org">Independent</div>
</div>
<div class="author">
      <div class="author-name">C. A. Wood</div>
<div class="org">Cloudflare</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Distributed Aggregation Protocol for Privacy Preserving Measurement</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">There are many situations in which it is desirable to take measurements of data
which people consider sensitive. In these cases, the entity taking the
measurement is usually not interested in people's individual responses but
rather in aggregated data. Conventional methods require collecting individual
responses and then aggregating them on some server, thus representing a threat
to user privacy and rendering many such measurements difficult and impractical.
This document describes a multi-party Distributed Aggregation Protocol (DAP) for
privacy preserving measurement which can be used to collect aggregate data
without revealing any individual contributor's data.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://ietf-wg-ppm.github.io/draft-ietf-ppm-dap/draft-ietf-ppm-dap.html">https://ietf-wg-ppm.github.io/draft-ietf-ppm-dap/draft-ietf-ppm-dap.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-ietf-ppm-dap/">https://datatracker.ietf.org/doc/draft-ietf-ppm-dap/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        Privacy Preserving Measurement Working Group mailing list (<span><a href="mailto:ppm@ietf.org">mailto:ppm@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/ppm/">https://mailarchive.ietf.org/arch/browse/ppm/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/ppm/">https://www.ietf.org/mailman/listinfo/ppm/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/ietf-wg-ppm/draft-ietf-ppm-dap">https://github.com/ietf-wg-ppm/draft-ietf-ppm-dap</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 17 August 2026.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2026 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="auto internal xref">1.1</a>.  <a href="#name-change-log" class="internal xref">Change Log</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.2">
                <p id="section-toc.1-1.1.2.2.1" class="keepWithNext"><a href="#section-1.2" class="auto internal xref">1.2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.2.2.1">
                    <p id="section-toc.1-1.1.2.2.2.1.1" class="keepWithNext"><a href="#section-1.2.1" class="auto internal xref">1.2.1</a>.  <a href="#name-glossary-of-terms" class="internal xref">Glossary of Terms</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-overview" class="internal xref">Overview</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a href="#section-2.1" class="auto internal xref">2.1</a>.  <a href="#name-system-architecture" class="internal xref">System Architecture</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a href="#section-2.2" class="auto internal xref">2.2</a>.  <a href="#name-validating-measurements" class="internal xref">Validating Measurements</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a href="#section-2.3" class="auto internal xref">2.3</a>.  <a href="#name-replay-protection-and-doubl" class="internal xref">Replay Protection and Double Collection</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4">
                <p id="section-toc.1-1.2.2.4.1"><a href="#section-2.4" class="auto internal xref">2.4</a>.  <a href="#name-lifecycle-of-protocol-objec" class="internal xref">Lifecycle of Protocol Objects</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4.2.1">
                    <p id="section-toc.1-1.2.2.4.2.1.1"><a href="#section-2.4.1" class="auto internal xref">2.4.1</a>.  <a href="#name-the-upload-interaction" class="internal xref">The Upload Interaction</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4.2.2">
                    <p id="section-toc.1-1.2.2.4.2.2.1"><a href="#section-2.4.2" class="auto internal xref">2.4.2</a>.  <a href="#name-the-aggregation-interaction" class="internal xref">The Aggregation Interaction</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4.2.3">
                    <p id="section-toc.1-1.2.2.4.2.3.1"><a href="#section-2.4.3" class="auto internal xref">2.4.3</a>.  <a href="#name-the-collection-interaction" class="internal xref">The Collection Interaction</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-http-usage" class="internal xref">HTTP Usage</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-asynchronous-request-handli" class="internal xref">Asynchronous Request Handling</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-http-status-codes" class="internal xref">HTTP Status Codes</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-presentation-language" class="internal xref">Presentation Language</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4" class="auto internal xref">3.4</a>.  <a href="#name-request-authentication" class="internal xref">Request Authentication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.5">
                <p id="section-toc.1-1.3.2.5.1"><a href="#section-3.5" class="auto internal xref">3.5</a>.  <a href="#name-errors" class="internal xref">Errors</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-protocol-definition" class="internal xref">Protocol Definition</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-basic-type-definitions" class="internal xref">Basic Type Definitions</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.1">
                    <p id="section-toc.1-1.4.2.1.2.1.1"><a href="#section-4.1.1" class="auto internal xref">4.1.1</a>.  <a href="#name-times-durations-and-interva" class="internal xref">Times, Durations and Intervals</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.2">
                    <p id="section-toc.1-1.4.2.1.2.2.1"><a href="#section-4.1.2" class="auto internal xref">4.1.2</a>.  <a href="#name-vdaf-types" class="internal xref">VDAF Types</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-task-configuration" class="internal xref">Task Configuration</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2.2.1">
                    <p id="section-toc.1-1.4.2.2.2.1.1"><a href="#section-4.2.1" class="auto internal xref">4.2.1</a>.  <a href="#name-batch-modes-batches-and-que" class="internal xref">Batch Modes, Batches, and Queries</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="auto internal xref">4.3</a>.  <a href="#name-aggregation-parameter-valid" class="internal xref">Aggregation Parameter Validation</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="auto internal xref">4.4</a>.  <a href="#name-uploading-reports" class="internal xref">Uploading Reports</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.1">
                    <p id="section-toc.1-1.4.2.4.2.1.1"><a href="#section-4.4.1" class="auto internal xref">4.4.1</a>.  <a href="#name-hpke-configuration-request" class="internal xref">HPKE Configuration Request</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.2">
                    <p id="section-toc.1-1.4.2.4.2.2.1"><a href="#section-4.4.2" class="auto internal xref">4.4.2</a>.  <a href="#name-upload-request" class="internal xref">Upload Request</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.3">
                    <p id="section-toc.1-1.4.2.4.2.3.1"><a href="#section-4.4.3" class="auto internal xref">4.4.3</a>.  <a href="#name-report-extensions" class="internal xref">Report Extensions</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a href="#section-4.5" class="auto internal xref">4.5</a>.  <a href="#name-verifying-and-aggregating-r" class="internal xref">Verifying and Aggregating Reports</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.1">
                    <p id="section-toc.1-1.4.2.5.2.1.1"><a href="#section-4.5.1" class="auto internal xref">4.5.1</a>.  <a href="#name-eager-aggregation" class="internal xref">Eager Aggregation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.2">
                    <p id="section-toc.1-1.4.2.5.2.2.1"><a href="#section-4.5.2" class="auto internal xref">4.5.2</a>.  <a href="#name-aggregate-initialization" class="internal xref">Aggregate Initialization</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.3">
                    <p id="section-toc.1-1.4.2.5.2.3.1"><a href="#section-4.5.3" class="auto internal xref">4.5.3</a>.  <a href="#name-aggregate-continuation" class="internal xref">Aggregate Continuation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.4">
                    <p id="section-toc.1-1.4.2.5.2.4.1"><a href="#section-4.5.4" class="auto internal xref">4.5.4</a>.  <a href="#name-aggregation-job-abandonment" class="internal xref">Aggregation Job Abandonment and Deletion</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6">
                <p id="section-toc.1-1.4.2.6.1"><a href="#section-4.6" class="auto internal xref">4.6</a>.  <a href="#name-collecting-results" class="internal xref">Collecting Results</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.1">
                    <p id="section-toc.1-1.4.2.6.2.1.1"><a href="#section-4.6.1" class="auto internal xref">4.6.1</a>.  <a href="#name-collection-job-initializati" class="internal xref">Collection Job Initialization</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.2">
                    <p id="section-toc.1-1.4.2.6.2.2.1"><a href="#section-4.6.2" class="auto internal xref">4.6.2</a>.  <a href="#name-collection-job-deletion" class="internal xref">Collection Job Deletion</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.3">
                    <p id="section-toc.1-1.4.2.6.2.3.1"><a href="#section-4.6.3" class="auto internal xref">4.6.3</a>.  <a href="#name-obtaining-aggregate-shares" class="internal xref">Obtaining Aggregate Shares</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.4">
                    <p id="section-toc.1-1.4.2.6.2.4.1"><a href="#section-4.6.4" class="auto internal xref">4.6.4</a>.  <a href="#name-aggregate-share-deletion" class="internal xref">Aggregate Share Deletion</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.5">
                    <p id="section-toc.1-1.4.2.6.2.5.1"><a href="#section-4.6.5" class="auto internal xref">4.6.5</a>.  <a href="#name-collection-job-finalization" class="internal xref">Collection Job Finalization</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.6.2.6">
                    <p id="section-toc.1-1.4.2.6.2.6.1"><a href="#section-4.6.6" class="auto internal xref">4.6.6</a>.  <a href="#name-aggregate-share-encryption" class="internal xref">Aggregate Share Encryption</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-batch-modes" class="internal xref">Batch Modes</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-time-interval" class="internal xref">Time Interval</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1.2.1">
                    <p id="section-toc.1-1.5.2.1.2.1.1"><a href="#section-5.1.1" class="auto internal xref">5.1.1</a>.  <a href="#name-query-configuration" class="internal xref">Query Configuration</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1.2.2">
                    <p id="section-toc.1-1.5.2.1.2.2.1"><a href="#section-5.1.2" class="auto internal xref">5.1.2</a>.  <a href="#name-partial-batch-selector-conf" class="internal xref">Partial Batch Selector Configuration</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1.2.3">
                    <p id="section-toc.1-1.5.2.1.2.3.1"><a href="#section-5.1.3" class="auto internal xref">5.1.3</a>.  <a href="#name-batch-selector-configuratio" class="internal xref">Batch Selector Configuration</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1.2.4">
                    <p id="section-toc.1-1.5.2.1.2.4.1"><a href="#section-5.1.4" class="auto internal xref">5.1.4</a>.  <a href="#name-batch-buckets-2" class="internal xref">Batch Buckets</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-leader-selected-batch-mode" class="internal xref">Leader-selected Batch Mode</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.1">
                    <p id="section-toc.1-1.5.2.2.2.1.1"><a href="#section-5.2.1" class="auto internal xref">5.2.1</a>.  <a href="#name-query-configuration-2" class="internal xref">Query Configuration</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.2">
                    <p id="section-toc.1-1.5.2.2.2.2.1"><a href="#section-5.2.2" class="auto internal xref">5.2.2</a>.  <a href="#name-partial-batch-selector-confi" class="internal xref">Partial Batch Selector Configuration</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.3">
                    <p id="section-toc.1-1.5.2.2.2.3.1"><a href="#section-5.2.3" class="auto internal xref">5.2.3</a>.  <a href="#name-batch-selector-configuration" class="internal xref">Batch Selector Configuration</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2.2.4">
                    <p id="section-toc.1-1.5.2.2.2.4.1"><a href="#section-5.2.4" class="auto internal xref">5.2.4</a>.  <a href="#name-batch-buckets-3" class="internal xref">Batch Buckets</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-operational-considerations" class="internal xref">Operational Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-protocol-participant-capabi" class="internal xref">Protocol Participant Capabilities</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.1">
                    <p id="section-toc.1-1.6.2.1.2.1.1"><a href="#section-6.1.1" class="auto internal xref">6.1.1</a>.  <a href="#name-client-capabilities" class="internal xref">Client Capabilities</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.2">
                    <p id="section-toc.1-1.6.2.1.2.2.1"><a href="#section-6.1.2" class="auto internal xref">6.1.2</a>.  <a href="#name-aggregator-capabilities" class="internal xref">Aggregator Capabilities</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1.2.3">
                    <p id="section-toc.1-1.6.2.1.2.3.1"><a href="#section-6.1.3" class="auto internal xref">6.1.3</a>.  <a href="#name-collector-capabilities" class="internal xref">Collector Capabilities</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-vdafs-and-compute-requireme" class="internal xref">VDAFs and Compute Requirements</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="auto internal xref">6.3</a>.  <a href="#name-aggregation-utility-and-sof" class="internal xref">Aggregation Utility and Soft Batch Deadlines</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4">
                <p id="section-toc.1-1.6.2.4.1"><a href="#section-6.4" class="auto internal xref">6.4</a>.  <a href="#name-protocol-specific-optimizat" class="internal xref">Protocol-specific Optimizations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4.2.1">
                    <p id="section-toc.1-1.6.2.4.2.1.1"><a href="#section-6.4.1" class="auto internal xref">6.4.1</a>.  <a href="#name-reducing-storage-requiremen" class="internal xref">Reducing Storage Requirements</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4.2.2">
                    <p id="section-toc.1-1.6.2.4.2.2.1"><a href="#section-6.4.2" class="auto internal xref">6.4.2</a>.  <a href="#name-distributed-systems-and-syn" class="internal xref">Distributed Systems and Synchronization Concerns</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4.2.3">
                    <p id="section-toc.1-1.6.2.4.2.3.1"><a href="#section-6.4.3" class="auto internal xref">6.4.3</a>.  <a href="#name-streaming-messages" class="internal xref">Streaming Messages</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-compliance-requirements" class="internal xref">Compliance Requirements</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="auto internal xref">8.1</a>.  <a href="#name-sybil-attacks" class="internal xref">Sybil Attacks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="auto internal xref">8.2</a>.  <a href="#name-batch-selection-attacks" class="internal xref">Batch-selection Attacks</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.3">
                <p id="section-toc.1-1.8.2.3.1"><a href="#section-8.3" class="auto internal xref">8.3</a>.  <a href="#name-client-authentication" class="internal xref">Client Authentication</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.4">
                <p id="section-toc.1-1.8.2.4.1"><a href="#section-8.4" class="auto internal xref">8.4</a>.  <a href="#name-anonymizing-proxies" class="internal xref">Anonymizing Proxies</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.5">
                <p id="section-toc.1-1.8.2.5.1"><a href="#section-8.5" class="auto internal xref">8.5</a>.  <a href="#name-differential-privacy" class="internal xref">Differential Privacy</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.6">
                <p id="section-toc.1-1.8.2.6.1"><a href="#section-8.6" class="auto internal xref">8.6</a>.  <a href="#name-task-parameters" class="internal xref">Task Parameters</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.6.2.1">
                    <p id="section-toc.1-1.8.2.6.2.1.1"><a href="#section-8.6.1" class="auto internal xref">8.6.1</a>.  <a href="#name-predictable-or-enumerable-t" class="internal xref">Predictable or Enumerable Task IDs</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.6.2.2">
                    <p id="section-toc.1-1.8.2.6.2.2.1"><a href="#section-8.6.2" class="auto internal xref">8.6.2</a>.  <a href="#name-vdaf-verification-key-requi" class="internal xref">VDAF Verification Key Requirements</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.6.2.3">
                    <p id="section-toc.1-1.8.2.6.2.3.1"><a href="#section-8.6.3" class="auto internal xref">8.6.3</a>.  <a href="#name-batch-parameters" class="internal xref">Batch Parameters</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.6.2.4">
                    <p id="section-toc.1-1.8.2.6.2.4.1"><a href="#section-8.6.4" class="auto internal xref">8.6.4</a>.  <a href="#name-relaxing-report-processing-" class="internal xref">Relaxing Report Processing Rules</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.6.2.5">
                    <p id="section-toc.1-1.8.2.6.2.5.1"><a href="#section-8.6.5" class="auto internal xref">8.6.5</a>.  <a href="#name-task-configuration-agreemen" class="internal xref">Task Configuration Agreement and Consistency</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.7">
                <p id="section-toc.1-1.8.2.7.1"><a href="#section-8.7" class="auto internal xref">8.7</a>.  <a href="#name-infrastructure-diversity" class="internal xref">Infrastructure Diversity</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="auto internal xref">9.1</a>.  <a href="#name-protocol-message-media-type" class="internal xref">Protocol Message Media Type</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="auto internal xref">9.2</a>.  <a href="#name-dap-type-registries" class="internal xref">DAP Type Registries</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2.2.1">
                    <p id="section-toc.1-1.9.2.2.2.1.1"><a href="#section-9.2.1" class="auto internal xref">9.2.1</a>.  <a href="#name-batch-modes-registry" class="internal xref">Batch Modes Registry</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2.2.2">
                    <p id="section-toc.1-1.9.2.2.2.2.1"><a href="#section-9.2.2" class="auto internal xref">9.2.2</a>.  <a href="#name-report-extension-registry" class="internal xref">Report Extension Registry</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2.2.3">
                    <p id="section-toc.1-1.9.2.2.2.3.1"><a href="#section-9.2.3" class="auto internal xref">9.2.3</a>.  <a href="#name-report-error-registry" class="internal xref">Report Error Registry</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.2.2.4">
                    <p id="section-toc.1-1.9.2.2.2.4.1"><a href="#section-9.2.4" class="auto internal xref">9.2.4</a>.  <a href="#name-guidance-for-designated-exp" class="internal xref">Guidance for Designated Experts</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9.2.3">
                <p id="section-toc.1-1.9.2.3.1"><a href="#section-9.3" class="auto internal xref">9.3</a>.  <a href="#name-urn-sub-namespace-for-dap-u" class="internal xref">URN Sub-namespace for DAP (urn:ietf:params:ppm:dap)</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-extending-this-document" class="internal xref">Extending this Document</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-references" class="internal xref">References</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="auto internal xref">11.1</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2" class="auto internal xref">11.2</a>.  <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#appendix-A" class="auto internal xref">Appendix A</a>.  <a href="#name-http-resources-reference" class="internal xref">HTTP Resources Reference</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#appendix-A.1" class="auto internal xref">A.1</a>.  <a href="#name-aggregator" class="internal xref">Aggregator</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.1.2.1">
                    <p id="section-toc.1-1.12.2.1.2.1.1"><a href="#appendix-A.1.1" class="auto internal xref">A.1.1</a>.  <a href="#name-hpke-configurations" class="internal xref">HPKE Configurations</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#appendix-A.2" class="auto internal xref">A.2</a>.  <a href="#name-leader" class="internal xref">Leader</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.1">
                    <p id="section-toc.1-1.12.2.2.2.1.1"><a href="#appendix-A.2.1" class="auto internal xref">A.2.1</a>.  <a href="#name-reports" class="internal xref">Reports</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.2.2.2">
                    <p id="section-toc.1-1.12.2.2.2.2.1"><a href="#appendix-A.2.2" class="auto internal xref">A.2.2</a>.  <a href="#name-collection-jobs" class="internal xref">Collection Jobs</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.3">
                <p id="section-toc.1-1.12.2.3.1"><a href="#appendix-A.3" class="auto internal xref">A.3</a>.  <a href="#name-helper" class="internal xref">Helper</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.3.2.1">
                    <p id="section-toc.1-1.12.2.3.2.1.1"><a href="#appendix-A.3.1" class="auto internal xref">A.3.1</a>.  <a href="#name-aggregation-jobs" class="internal xref">Aggregation Jobs</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12.2.3.2.2">
                    <p id="section-toc.1-1.12.2.3.2.2.1"><a href="#appendix-A.3.2" class="auto internal xref">A.3.2</a>.  <a href="#name-aggregate-shares" class="internal xref">Aggregate Shares</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-contributors" class="internal xref">Contributors</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#appendix-C" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">This document describes the Distributed Aggregation Protocol (DAP) for privacy
preserving measurement. The protocol is executed by a large set of clients and
two aggregation servers. The aggregators' goal is to compute some aggregate
statistic over measurements generated by clients without learning the
measurements themselves. This is made possible by distributing the computation
among the aggregators in such a way that, as long as at least one of them
executes the protocol honestly, no measurement is ever seen in the clear by any
aggregator.<a href="#section-1-1" class="pilcrow">¶</a></p>
<div id="change-log">
<section id="section-1.1">
        <h3 id="name-change-log">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-change-log" class="section-name selfRef">Change Log</a>
        </h3>
<p id="section-1.1-1">(RFC EDITOR: Remove this section.)<a href="#section-1.1-1" class="pilcrow">¶</a></p>
<p id="section-1.1-2">18:<a href="#section-1.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-3.1">
            <p id="section-1.1-3.1.1">Add verification key ID to aggregation jobs to enable but not require
verification key management. (*) (#766)<a href="#section-1.1-3.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-4">17:<a href="#section-1.1-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-5.1">
            <p id="section-1.1-5.1.1">Bump version tag from "dap-16" to "dap-17". (*)<a href="#section-1.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.2">
            <p id="section-1.1-5.2.1">Align IANA considerations with RFC 8126 and
https://www.iana.org/help/protocol-registration.<a href="#section-1.1-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.3">
            <p id="section-1.1-5.3.1">Add RFC Editor notes to change domain separation tags from "dap-17" to "dap"
on RFC publication.<a href="#section-1.1-5.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.4">
            <p id="section-1.1-5.4.1">Fix definitions of time types. (#759)<a href="#section-1.1-5.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.5">
            <p id="section-1.1-5.5.1">Rename VDAF preparation to verification. (#752)<a href="#section-1.1-5.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.6">
            <p id="section-1.1-5.6.1">Simplify media types. (*) (#748)<a href="#section-1.1-5.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-5.7">
            <p id="section-1.1-5.7.1">Bump draft-irtf-cfrg-vdaf to -18 (<span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>).<a href="#section-1.1-5.7.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-6">16:<a href="#section-1.1-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-7.1">
            <p id="section-1.1-7.1.1">Bump draft-irtf-cfrg-vdaf-13 to 15 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span> and adopt changes to the
ping-pong API. (#705, #718)<a href="#section-1.1-7.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-7.2">
            <p id="section-1.1-7.2.1">Allow many reports to be uploaded at once. (*) (#686)<a href="#section-1.1-7.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-7.3">
            <p id="section-1.1-7.3.1">Remove TLS presentation language syntax extensions. (#707)<a href="#section-1.1-7.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-7.4">
            <p id="section-1.1-7.4.1">Use HTTP message content length to determine length of vectors in
<code>AggregationJobInitReq</code>, <code>AggregationJobResp</code> and <code>AggregationJobContinueReq</code>
messages. (*) (#717)<a href="#section-1.1-7.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-7.5">
            <p id="section-1.1-7.5.1">Represent the Time and Duration types as a number of time_precision
intervals, rather than seconds (*) (#720).<a href="#section-1.1-7.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-7.6">
            <p id="section-1.1-7.6.1">Discuss the property of "verifiability" instead of "robustness" to match
recent VDAF changes (https://github.com/cfrg/draft-irtf-cfrg-vdaf/pull/558).
(#725)<a href="#section-1.1-7.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-7.7">
            <p id="section-1.1-7.7.1">Bump version tag from "dap-15" to "dap-16". (*)<a href="#section-1.1-7.7.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-8">15:<a href="#section-1.1-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-9.1">
            <p id="section-1.1-9.1.1">Specify body of responses to aggregation job GET requests. (#651)<a href="#section-1.1-9.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.2">
            <p id="section-1.1-9.2.1">Add diagram illustrating object lifecycles and relationships. (#655)<a href="#section-1.1-9.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.3">
            <p id="section-1.1-9.3.1">Use aasvg for prettier diagrams. (#657)<a href="#section-1.1-9.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.4">
            <p id="section-1.1-9.4.1">Add more precise description of time and intervals. (#658)<a href="#section-1.1-9.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.5">
            <p id="section-1.1-9.5.1">Reorganize text for clarity and flow. (#659, #660, #661, #663, #665, #666,
#668, #672, #678, #680, #684, #653, #654)<a href="#section-1.1-9.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.6">
            <p id="section-1.1-9.6.1">Align with RFC 9205 recommendations. (*) (#673, #683)<a href="#section-1.1-9.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.7">
            <p id="section-1.1-9.7.1">Define consistent semantics for long-running interactions: aggregation jobs,
collection jobs and aggregate shares. (*) (#674, #675, #677)<a href="#section-1.1-9.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.8">
            <p id="section-1.1-9.8.1">Add security consideration for predictable task IDs. (#679)<a href="#section-1.1-9.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-9.9">
            <p id="section-1.1-9.9.1">Bump version tag from "dap-14" to "dap-15". (*)<a href="#section-1.1-9.9.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-10">14:<a href="#section-1.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-11.1">
            <p id="section-1.1-11.1.1">Enforce VDAF aggregation parameter validity. This is not relevant for Prio3,
which requires only that reports be aggregated at most once. It is relevant
for VDAFs for which validity depends on how many times a report might be
aggregated (at most once in DAP). (*)<a href="#section-1.1-11.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-11.2">
            <p id="section-1.1-11.2.1">Require all timestamps to be truncated by <code>time_precision</code>. (*)<a href="#section-1.1-11.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-11.3">
            <p id="section-1.1-11.3.1">Bump draft-irtf-cfrg-vdaf-13 to 14 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>. There are no functional or
breaking changes in this draft.<a href="#section-1.1-11.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-11.4">
            <p id="section-1.1-11.4.1">Clarify conditions for rejecting reports based on the report metadata,
including the timestamp and public and private extensions.<a href="#section-1.1-11.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-11.5">
            <p id="section-1.1-11.5.1">Clarify that the Helper responds with 202 Accepted to an aggregation
continuation request.<a href="#section-1.1-11.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-11.6">
            <p id="section-1.1-11.6.1">Bump version tag from "dap-13" to "dap-14". (*)<a href="#section-1.1-11.6.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-12">13:<a href="#section-1.1-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-13.1">
            <p id="section-1.1-13.1.1">Bump draft-irtf-cfrg-vdaf-12 to 13 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span> and adopt the streaming
aggregation interface. Accordingly, clarify that DAP is only compatible with
VDAFs for which aggregation is order insensitive.<a href="#section-1.1-13.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.2">
            <p id="section-1.1-13.2.1">Add public extensions to report metadata. (*)<a href="#section-1.1-13.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.3">
            <p id="section-1.1-13.3.1">Improve extension points for batch modes. (*)<a href="#section-1.1-13.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.4">
            <p id="section-1.1-13.4.1">During the upload interaction, allow the Leader to indicate to the Client
which set of report extensions it doesn't support.<a href="#section-1.1-13.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.5">
            <p id="section-1.1-13.5.1">Add a start time to task parameters and require rejection of reports outside
of the time validity window. Incidentally, replace the task end time with a
task duration parameter.<a href="#section-1.1-13.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.6">
            <p id="section-1.1-13.6.1">Clarify underspecified behavior around aggregation skew recovery.<a href="#section-1.1-13.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.7">
            <p id="section-1.1-13.7.1">Improve IANA considerations and add guidelines for extending DAP.<a href="#section-1.1-13.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.8">
            <p id="section-1.1-13.8.1">Rename "upload extension" to "report extension", and "prepare error" to
"report error", to better align the names of these types with their
functionality.<a href="#section-1.1-13.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-13.9">
            <p id="section-1.1-13.9.1">Bump version tag from "dap-12" to "dap-13". (*)<a href="#section-1.1-13.9.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-14">12:<a href="#section-1.1-14" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-15.1">
            <p id="section-1.1-15.1.1">Bump draft-irtf-cfrg-vdaf-08 to 12 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>, and specify the newly-defined
application context string to be a concatenation of the DAP version in use
with the task ID. (*)<a href="#section-1.1-15.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.2">
            <p id="section-1.1-15.2.1">Add support for "asynchronous" aggregation, based on the Leader polling the
Helper for the result of each step of aggregation. (*)<a href="#section-1.1-15.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.3">
            <p id="section-1.1-15.3.1">Update collection semantics to match the new aggregation semantics introduced
in support of asynchronous aggregation. (*)<a href="#section-1.1-15.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.4">
            <p id="section-1.1-15.4.1">Clarify the requirements around report replay protection, defining when and
how report IDs must be checked and stored in order to correctly detect
replays.<a href="#section-1.1-15.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.5">
            <p id="section-1.1-15.5.1">Remove support for per-task HPKE configurations. (*)<a href="#section-1.1-15.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.6">
            <p id="section-1.1-15.6.1">Rename "query type" to "batch mode", to align the name of this configuration
value with its functionality.<a href="#section-1.1-15.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.7">
            <p id="section-1.1-15.7.1">Rename the "fixed-size" batch mode to "leader-selected", to align the name
with the behavior of this query type.<a href="#section-1.1-15.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.8">
            <p id="section-1.1-15.8.1">Remove the <code>max_batch_size</code> parameter of the "fixed-size" batch mode.<a href="#section-1.1-15.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.9">
            <p id="section-1.1-15.9.1">Restore the <code>part_batch_selector</code> field of the <code>Collection</code> structure, which
was removed in draft 11, as it is required to decrypt collection results in
some cases. (*)<a href="#section-1.1-15.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.10">
            <p id="section-1.1-15.10.1">Update <code>PrepareError</code> allocations in order to remove an unused value and to
reserve the zero value for testing. (*)<a href="#section-1.1-15.10.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.11">
            <p id="section-1.1-15.11.1">Document distributed-system and synchronization concerns in the operational
considerations section.<a href="#section-1.1-15.11.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.12">
            <p id="section-1.1-15.12.1">Document additional storage and runtime requirements in the operational
considerations section.<a href="#section-1.1-15.12.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.13">
            <p id="section-1.1-15.13.1">Document deviations from the presentation language of <span><a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a> of [<a href="#RFC8446" class="cite xref">RFC8446</a>]</span> for structures described in this specification.<a href="#section-1.1-15.13.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.14">
            <p id="section-1.1-15.14.1">Clarify that differential privacy mitigations can help with privacy, rather
than robustness, in the operational considerations section.<a href="#section-1.1-15.14.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-15.15">
            <p id="section-1.1-15.15.1">Bump version tag from "dap-11" to "dap-12". (*)<a href="#section-1.1-15.15.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-16">11:<a href="#section-1.1-16" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-17.1">
            <p id="section-1.1-17.1.1">Remove support for multi-collection of batches, as well as the fixed-size
query type's <code>by_batch_id</code> query. (*)<a href="#section-1.1-17.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-17.2">
            <p id="section-1.1-17.2.1">Clarify purpose of report ID uniqueness.<a href="#section-1.1-17.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-17.3">
            <p id="section-1.1-17.3.1">Bump version tag from "dap-10" to "dap-11". (*)<a href="#section-1.1-17.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-18">10:<a href="#section-1.1-18" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-19.1">
            <p id="section-1.1-19.1.1">Editorial changes from httpdir early review.<a href="#section-1.1-19.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-19.2">
            <p id="section-1.1-19.2.1">Poll collection jobs with HTTP GET instead of POST. (*)<a href="#section-1.1-19.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-19.3">
            <p id="section-1.1-19.3.1">Upload reports with HTTP POST instead of PUT. (*)<a href="#section-1.1-19.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-19.4">
            <p id="section-1.1-19.4.1">Clarify requirements for problem documents.<a href="#section-1.1-19.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-19.5">
            <p id="section-1.1-19.5.1">Provide guidance on batch sizes when running VDAFs with non-trivial
aggregation parameters.<a href="#section-1.1-19.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-19.6">
            <p id="section-1.1-19.6.1">Bump version tag from "dap-09" to "dap-10". (*)<a href="#section-1.1-19.6.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-20">09:<a href="#section-1.1-20" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-21.1">
            <p id="section-1.1-21.1.1">Fixed-size queries: make the maximum batch size optional.<a href="#section-1.1-21.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-21.2">
            <p id="section-1.1-21.2.1">Fixed-size queries: require current-batch queries to return distinct batches.<a href="#section-1.1-21.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-21.3">
            <p id="section-1.1-21.3.1">Clarify requirements for compatible VDAFs.<a href="#section-1.1-21.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-21.4">
            <p id="section-1.1-21.4.1">Clarify rules around creating and abandoning aggregation jobs.<a href="#section-1.1-21.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-21.5">
            <p id="section-1.1-21.5.1">Recommend that all task parameters are visible to all parties.<a href="#section-1.1-21.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-21.6">
            <p id="section-1.1-21.6.1">Revise security considerations section.<a href="#section-1.1-21.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-21.7">
            <p id="section-1.1-21.7.1">Bump draft-irtf-cfrg-vdaf-07 to 08 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>. (*)<a href="#section-1.1-21.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-21.8">
            <p id="section-1.1-21.8.1">Bump version tag from "dap-07" to "dap-09". (*)<a href="#section-1.1-21.8.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-22">08:<a href="#section-1.1-22" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-23.1">
            <p id="section-1.1-23.1.1">Clarify requirements for initializing aggregation jobs.<a href="#section-1.1-23.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-23.2">
            <p id="section-1.1-23.2.1">Add more considerations for Sybil attacks.<a href="#section-1.1-23.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-23.3">
            <p id="section-1.1-23.3.1">Expand guidance around choosing the VDAF verification key.<a href="#section-1.1-23.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-23.4">
            <p id="section-1.1-23.4.1">Add an error type registry for the aggregation sub-protocol.<a href="#section-1.1-23.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-24">07:<a href="#section-1.1-24" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-25.1">
            <p id="section-1.1-25.1.1">Bump version tag from "dap-06" to "dap-07". This is a bug-fix revision: the
editors overlooked some changes we intended to pick up in the previous
version. (*)<a href="#section-1.1-25.1.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-26">06:<a href="#section-1.1-26" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-27.1">
            <p id="section-1.1-27.1.1">Bump draft-irtf-cfrg-vdaf-06 to 07 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>. (*)<a href="#section-1.1-27.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-27.2">
            <p id="section-1.1-27.2.1">Overhaul security considerations (#488).<a href="#section-1.1-27.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-27.3">
            <p id="section-1.1-27.3.1">Adopt revised ping-pong interface in draft-irtf-cfrg-vdaf-07 (#494).<a href="#section-1.1-27.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-27.4">
            <p id="section-1.1-27.4.1">Add aggregation parameter to <code>AggregateShareAad</code> (#498). (*)<a href="#section-1.1-27.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-27.5">
            <p id="section-1.1-27.5.1">Bump version tag from "dap-05" to "dap-06". (*)<a href="#section-1.1-27.5.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-28">05:<a href="#section-1.1-28" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-29.1">
            <p id="section-1.1-29.1.1">Bump draft-irtf-cfrg-vdaf-05 to 06 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>. (*)<a href="#section-1.1-29.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-29.2">
            <p id="section-1.1-29.2.1">Specialize the protocol for two-party VDAFs (i.e., one Leader and One
Helper). Accordingly, update the aggregation sub-protocol to use the new
"ping-pong" interface for two-party VDAFs introduced in
draft-irtf-cfrg-vdaf-06. (*)<a href="#section-1.1-29.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-29.3">
            <p id="section-1.1-29.3.1">Allow the following actions to be safely retried: aggregation job creation,
collection job creation, and requesting the Helper's aggregate share.<a href="#section-1.1-29.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-29.4">
            <p id="section-1.1-29.4.1">Merge error types that are related.<a href="#section-1.1-29.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-29.5">
            <p id="section-1.1-29.5.1">Drop recommendation to generate IDs using a cryptographically secure
pseudorandom number generator wherever pseudorandomness is not required.<a href="#section-1.1-29.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-29.6">
            <p id="section-1.1-29.6.1">Require HPKE config identifiers to be unique.<a href="#section-1.1-29.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-29.7">
            <p id="section-1.1-29.7.1">Bump version tag from "dap-04" to "dap-05". (*)<a href="#section-1.1-29.7.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-30">04:<a href="#section-1.1-30" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-31.1">
            <p id="section-1.1-31.1.1">Introduce resource oriented HTTP API. (#278, #398, #400) (*)<a href="#section-1.1-31.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-31.2">
            <p id="section-1.1-31.2.1">Clarify security requirements for choosing VDAF verify key. (#407, #411)<a href="#section-1.1-31.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-31.3">
            <p id="section-1.1-31.3.1">Require Clients to provide nonce and random input when sharding inputs. (#394,
#425) (*)<a href="#section-1.1-31.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-31.4">
            <p id="section-1.1-31.4.1">Add interval of time spanned by constituent reports to Collection message.
(#397, #403) (*)<a href="#section-1.1-31.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-31.5">
            <p id="section-1.1-31.5.1">Update share validation requirements based on latest security analysis. (#408,
#410)<a href="#section-1.1-31.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-31.6">
            <p id="section-1.1-31.6.1">Bump draft-irtf-cfrg-vdaf-03 to 05 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>. (#429) (*)<a href="#section-1.1-31.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-31.7">
            <p id="section-1.1-31.7.1">Bump version tag from "dap-03" to "dap-04". (#424) (*)<a href="#section-1.1-31.7.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-32">03:<a href="#section-1.1-32" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-33.1">
            <p id="section-1.1-33.1.1">Enrich the "fixed_size" query type to allow the Collector to request a
recently aggregated batch without knowing the batch ID in advance. ID
discovery was previously done out-of-band. (*)<a href="#section-1.1-33.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.2">
            <p id="section-1.1-33.2.1">Allow Aggregators to advertise multiple HPKE configurations. (*)<a href="#section-1.1-33.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.3">
            <p id="section-1.1-33.3.1">Clarify requirements for enforcing anti-replay. Namely, while it is sufficient
to detect repeated report IDs, it is also enough to detect repeated IDs and
timestamps.<a href="#section-1.1-33.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.4">
            <p id="section-1.1-33.4.1">Remove the extensions from the Report and add extensions to the plaintext
payload of each ReportShare. (*)<a href="#section-1.1-33.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.5">
            <p id="section-1.1-33.5.1">Clarify that extensions are mandatory to implement: If an Aggregator does not
recognize a ReportShare's extension, it must reject it.<a href="#section-1.1-33.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.6">
            <p id="section-1.1-33.6.1">Clarify that Aggregators must reject any ReportShare with repeated extension
types.<a href="#section-1.1-33.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.7">
            <p id="section-1.1-33.7.1">Specify explicitly how to serialize the Additional Authenticated Data (AAD)
string for HPKE encryption. This clarifies an ambiguity in the previous
version. (*)<a href="#section-1.1-33.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.8">
            <p id="section-1.1-33.8.1">Change the length tag for the aggregation parameter to 32 bits. (*)<a href="#section-1.1-33.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.9">
            <p id="section-1.1-33.9.1">Use the same prefix ("application") for all media types. (*)<a href="#section-1.1-33.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.10">
            <p id="section-1.1-33.10.1">Make input share validation more explicit, including adding a new
ReportShareError variant, "report_too_early", for handling reports too far in
the future. (*)<a href="#section-1.1-33.10.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.11">
            <p id="section-1.1-33.11.1">Improve alignment of problem details usage with <span>[<a href="#RFC7807" class="cite xref">RFC7807</a>]</span>. Replace
"reportTooLate" problem document type with "repjortRejected" and clarify
handling of rejected reports in the upload sub-protocol. (*)<a href="#section-1.1-33.11.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-33.12">
            <p id="section-1.1-33.12.1">Bump version tag from "dap-02" to "dap-03". (*)<a href="#section-1.1-33.12.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-1.1-34">02:<a href="#section-1.1-34" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-1.1-35.1">
            <p id="section-1.1-35.1.1">Define a new task configuration parameter, called the "query type", that
allows tasks to partition reports into batches in different ways. In the
current draft, the Collector specifies a "query", which the Aggregators use to
guide selection of the batch. Two query types are defined: the "time_interval"
type captures the semantics of draft 01; and the "fixed_size" type allows the
Leader to partition the reports arbitrarily, subject to the constraint that
each batch is roughly the same size. (*)<a href="#section-1.1-35.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.2">
            <p id="section-1.1-35.2.1">Define a new task configuration parameter, called the task "expiration", that
defines the lifetime of a given task.<a href="#section-1.1-35.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.3">
            <p id="section-1.1-35.3.1">Specify requirements for HTTP request authentication rather than a concrete
scheme. (Draft 01 required the use of the <code>DAP-Auth-Token</code> header; this is now
optional.)<a href="#section-1.1-35.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.4">
            <p id="section-1.1-35.4.1">Make "task_id" an optional parameter of the "/hpke_config" endpoint.<a href="#section-1.1-35.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.5">
            <p id="section-1.1-35.5.1">Add report count to CollectResp message. (*)<a href="#section-1.1-35.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.6">
            <p id="section-1.1-35.6.1">Increase message payload sizes to accommodate VDAFs with input and aggregate
shares larger than 2^16-1 bytes. (*)<a href="#section-1.1-35.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.7">
            <p id="section-1.1-35.7.1">Bump draft-irtf-cfrg-vdaf-01 to 03 <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>. (*)<a href="#section-1.1-35.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.8">
            <p id="section-1.1-35.8.1">Bump version tag from "dap-01" to "dap-02". (*)<a href="#section-1.1-35.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.9">
            <p id="section-1.1-35.9.1">Rename the report nonce to the "report ID" and move it to the top of the
structure. (*)<a href="#section-1.1-35.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-1.1-35.10">
            <p id="section-1.1-35.10.1">Clarify when it is safe for an Aggregator to evict various data artifacts from
long-term storage.<a href="#section-1.1-35.10.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-1.2">
        <h3 id="name-conventions-and-definitions">
<a href="#section-1.2" class="section-number selfRef">1.2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
        </h3>
<p id="section-1.2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-1.2-1" class="pilcrow">¶</a></p>
<p id="section-1.2-2">All examples in this document wrap long lines using the Single Backslash
Strategy of <span>[<a href="#RFC8792" class="cite xref">RFC8792</a>], <a href="https://rfc-editor.org/rfc/rfc8792#section-7" class="relref">Section 7</a></span>.<a href="#section-1.2-2" class="pilcrow">¶</a></p>
<div id="glossary-of-terms">
<section id="section-1.2.1">
          <h4 id="name-glossary-of-terms">
<a href="#section-1.2.1" class="section-number selfRef">1.2.1. </a><a href="#name-glossary-of-terms" class="section-name selfRef">Glossary of Terms</a>
          </h4>
<span class="break"></span><dl class="dlParallel" id="section-1.2.1-1">
            <dt id="section-1.2.1-1.1">Aggregate result:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.2">
              <p id="section-1.2.1-1.2.1">The output of the aggregation function. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.2.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.3">Aggregate share:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.4">
              <p id="section-1.2.1-1.4.1">A secret share of the aggregate result computed by each Aggregator and
transmitted to the Collector. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.4.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.5">Aggregation function:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.6">
              <p id="section-1.2.1-1.6.1">The function computed over the measurements generated by the Clients and the
aggregation parameter selected by the Collector. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.6.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.7">Aggregation parameter:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.8">
              <p id="section-1.2.1-1.8.1">Parameter selected by the Collector used to refine a batch of measurements
for aggregation. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.8.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.9">Aggregator:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.10">
              <p id="section-1.2.1-1.10.1">The party that receives report shares from Clients and validates and
aggregates them with the help of the other Aggregator, producing aggregate
shares for the Collector. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.10.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.11">Batch:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.12">
              <p id="section-1.2.1-1.12.1">A set of reports (i.e., measurements) that are aggregated into an aggregate
result. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.12.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.13">Batch bucket:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.14">
              <p id="section-1.2.1-1.14.1">State associated with a given batch allowing the aggregators to perform
incremental aggregation. Depending on the batch mode, there may be many batch
buckets tracking the state of a single batch.<a href="#section-1.2.1-1.14.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.15">Batch interval:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.16">
              <p id="section-1.2.1-1.16.1">A parameter of a query issued by the Collector that specifies the time range
of the reports in the batch.<a href="#section-1.2.1-1.16.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.17">Client:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.18">
              <p id="section-1.2.1-1.18.1">The party that generates a measurement and uploads a report, as defined in
<span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>. Note the distinction between a DAP Client (distinguished in this
document by the capital "C") and an HTTP client (distinguished in this
document by the phrase "HTTP client"), as the DAP Client is not the only role
that sometimes acts as an HTTP client.<a href="#section-1.2.1-1.18.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.19">Collector:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.20">
              <p id="section-1.2.1-1.20.1">The party that selects the aggregation parameter and assembles the aggregate
result from the aggregate shares constructed by the Aggregators. As defined in
<span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.20.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.21">Helper:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.22">
              <p id="section-1.2.1-1.22.1">The Aggregator that executes the aggregation and collection interactions
initiated by the Leader.<a href="#section-1.2.1-1.22.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.23">Input share:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.24">
              <p id="section-1.2.1-1.24.1">An Aggregator's share of a measurement. The input shares are output by the
VDAF sharding algorithm. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.24.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.25">Output share:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.26">
              <p id="section-1.2.1-1.26.1">An Aggregator's share of the refined measurement resulting from successful
execution of VDAF verification. Many output shares are combined into an
aggregate share during VDAF aggregation. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.26.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.27">Leader:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.28">
              <p id="section-1.2.1-1.28.1">The Aggregator that coordinates aggregation and collection with the Helper.<a href="#section-1.2.1-1.28.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.29">Measurement:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.30">
              <p id="section-1.2.1-1.30.1">A plaintext input emitted by a Client (e.g., a count, summand, or string),
before any encryption or secret sharing is applied. Depending on the VDAF in
use, multiple values may be grouped into a single measurement. As defined in
<span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.30.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.31">Minimum batch size:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.32">
              <p id="section-1.2.1-1.32.1">The minimum number of reports that must be aggregated before a batch can be
collected.<a href="#section-1.2.1-1.32.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.33">Public share:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.34">
              <p id="section-1.2.1-1.34.1">An output of the VDAF sharding algorithm transmitted to each of the
Aggregators. As defined in <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>.<a href="#section-1.2.1-1.34.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.35">Report:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.36">
              <p id="section-1.2.1-1.36.1">A cryptographically protected measurement uploaded to the Leader by a Client.
Includes a public share and a pair of report shares, one for each Aggregator.<a href="#section-1.2.1-1.36.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.37">Report share:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.38">
              <p id="section-1.2.1-1.38.1">An input share encrypted under the HPKE public key of an Aggregator <span>[<a href="#HPKE" class="cite xref">HPKE</a>]</span>.
The report share also includes some associated data used for processing the
report.<a href="#section-1.2.1-1.38.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-1.2.1-1.39">Task:</dt>
            <dd style="margin-left: 1.5em" id="section-1.2.1-1.40">
              <p id="section-1.2.1-1.40.1">A set of measurements of an understood type which will be reported by the
Clients, aggregated by the Aggregators and received by the Collector. Many
collections can be performed in the course of a single task.<a href="#section-1.2.1-1.40.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="overview">
<section id="section-2">
      <h2 id="name-overview">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
      </h2>
<p id="section-2-1">The protocol is executed by a large set of Clients and a pair of Aggregators.
Each Client's input to the protocol is its measurement (or set of measurements,
e.g., counts of some user behavior). Given a set of measurements
<code>meas_1, ..., meas_N</code> held by the Clients, and an "aggregation parameter"
<code>agg_param</code> shared by the Aggregators, the goal of DAP is to compute
<code>agg_result = F(agg_param, meas_1, ..., meas_N)</code> for some function <code>F</code> while
revealing nothing else about the measurements. We call <code>F</code> the "aggregation
function" and <code>agg_result</code> the "aggregate result".<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">(RFC EDITOR: Please update the normative reference to VDAF in the next paragraph
to the VDAF RFC during AUTH48. We hope that VDAF will have been published by
then.)<a href="#section-2-2" class="pilcrow">¶</a></p>
<p id="section-2-3">DAP is extensible in that it allows for the addition of new cryptographic
schemes that compute different aggregation functions, determined by the
Verifiable Distributed Aggregation Function, or
<span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span>, used to compute it.<a href="#section-2-3" class="pilcrow">¶</a></p>
<p id="section-2-4">VDAFs rely on secret sharing to protect the privacy of the measurements. Rather
than sending its measurement in the clear, each Client shards its measurement
into a pair of "input shares" and sends an input share to each of the
Aggregators. This scheme has two important properties:<a href="#section-2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2-5.1">
          <p id="section-2-5.1.1">Given only one of the input shares, it is impossible to deduce the plaintext
measurement from which it was generated.<a href="#section-2-5.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-5.2">
          <p id="section-2-5.2.1">Aggregators can compute secret shares of the aggregate result by aggregating
their shares locally into "aggregate shares", which may later be merged into
the aggregate result.<a href="#section-2-5.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-2-6">DAP is not compatible with all VDAFs. DAP only supports VDAFs whose aggregation
results are independent of the order in which measurements are aggregated (see
<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-4.4.1" class="relref">Section 4.4.1</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>). Some VDAFs may involve three or more Aggregators,
but DAP requires exactly two Aggregators. Some VDAFs allow measurements to be
aggregated multiple times with a different aggregation parameter. DAP may be
compatible with such VDAFs, but only allows each measurement to be aggregated
once.<a href="#section-2-6" class="pilcrow">¶</a></p>
<div id="system-architecture">
<section id="section-2.1">
        <h3 id="name-system-architecture">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-system-architecture" class="section-name selfRef">System Architecture</a>
        </h3>
<p id="section-2.1-1">The basic unit of DAP operation is the <em>task</em> (<a href="#task-configuration" class="auto internal xref">Section 4.2</a>), which
corresponds to a set of measurements of a single type. A given task may result
in multiple aggregated reported results, for instance when measurements are
collected over a long time period and broken up into multiple batches according
to different time windows.<a href="#section-2.1-1" class="pilcrow">¶</a></p>
<span id="name-dap-architecture"></span><div id="dap-topology">
<figure id="figure-1">
          <div id="section-2.1-2.1">
            <div class="alignLeft art-svg artwork" id="section-2.1-2.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="336" width="456" viewBox="0 0 456 336" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,32 L 8,96" fill="none" stroke="black"></path>
                <path d="M 8,128 L 8,192" fill="none" stroke="black"></path>
                <path d="M 8,256 L 8,320" fill="none" stroke="black"></path>
                <path d="M 80,32 L 80,96" fill="none" stroke="black"></path>
                <path d="M 80,128 L 80,192" fill="none" stroke="black"></path>
                <path d="M 80,256 L 80,320" fill="none" stroke="black"></path>
                <path d="M 120,64 L 120,128" fill="none" stroke="black"></path>
                <path d="M 120,192 L 120,288" fill="none" stroke="black"></path>
                <path d="M 168,112 L 168,208" fill="none" stroke="black"></path>
                <path d="M 168,256 L 168,320" fill="none" stroke="black"></path>
                <path d="M 216,216 L 216,248" fill="none" stroke="black"></path>
                <path d="M 272,112 L 272,208" fill="none" stroke="black"></path>
                <path d="M 272,256 L 272,320" fill="none" stroke="black"></path>
                <path d="M 352,128 L 352,192" fill="none" stroke="black"></path>
                <path d="M 448,128 L 448,192" fill="none" stroke="black"></path>
                <path d="M 8,32 L 80,32" fill="none" stroke="black"></path>
                <path d="M 80,64 L 120,64" fill="none" stroke="black"></path>
                <path d="M 8,96 L 80,96" fill="none" stroke="black"></path>
                <path d="M 168,112 L 272,112" fill="none" stroke="black"></path>
                <path d="M 8,128 L 80,128" fill="none" stroke="black"></path>
                <path d="M 120,128 L 160,128" fill="none" stroke="black"></path>
                <path d="M 352,128 L 448,128" fill="none" stroke="black"></path>
                <path d="M 80,160 L 160,160" fill="none" stroke="black"></path>
                <path d="M 280,160 L 352,160" fill="none" stroke="black"></path>
                <path d="M 8,192 L 80,192" fill="none" stroke="black"></path>
                <path d="M 120,192 L 160,192" fill="none" stroke="black"></path>
                <path d="M 352,192 L 448,192" fill="none" stroke="black"></path>
                <path d="M 168,208 L 272,208" fill="none" stroke="black"></path>
                <path d="M 8,256 L 80,256" fill="none" stroke="black"></path>
                <path d="M 168,256 L 272,256" fill="none" stroke="black"></path>
                <path d="M 80,288 L 120,288" fill="none" stroke="black"></path>
                <path d="M 8,320 L 80,320" fill="none" stroke="black"></path>
                <path d="M 168,320 L 272,320" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="288,160 276,154.4 276,165.6" fill="black" transform="rotate(180,280,160)"></polygon>
                <polygon class="arrowhead" points="224,248 212,242.4 212,253.6" fill="black" transform="rotate(90,216,248)"></polygon>
                <polygon class="arrowhead" points="168,192 156,186.4 156,197.6" fill="black" transform="rotate(0,160,192)"></polygon>
                <polygon class="arrowhead" points="168,160 156,154.4 156,165.6" fill="black" transform="rotate(0,160,160)"></polygon>
                <polygon class="arrowhead" points="168,128 156,122.4 156,133.6" fill="black" transform="rotate(0,160,128)"></polygon>
                <g class="text">
                  <text x="44" y="68">Client</text>
                  <text x="44" y="164">Client</text>
                  <text x="220" y="164">Leader</text>
                  <text x="400" y="164">Collector</text>
                  <text x="136" y="180">...</text>
                  <text x="40" y="228">...</text>
                  <text x="44" y="292">Client</text>
                  <text x="220" y="292">Helper</text>
                </g>
              </svg><a href="#section-2.1-2.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-dap-architecture" class="selfRef">DAP architecture</a>
          </figcaption></figure>
</div>
<p id="section-2.1-3">The main participants in the protocol are as follows:<a href="#section-2.1-3" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2.1-4">
          <dt id="section-2.1-4.1">Collector:</dt>
          <dd style="margin-left: 1.5em" id="section-2.1-4.2">
            <p id="section-2.1-4.2.1">The party which wants to obtain the aggregate result over the measurements
generated by the Clients. A task will have a single Collector.<a href="#section-2.1-4.2.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-2.1-4.3">Clients:</dt>
          <dd style="margin-left: 1.5em" id="section-2.1-4.4">
            <p id="section-2.1-4.4.1">The parties which take the measurements and report them to the Aggregators.
In order to provide reasonable levels of privacy, there must be a large number
of Clients.<a href="#section-2.1-4.4.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-2.1-4.5">Leader:</dt>
          <dd style="margin-left: 1.5em" id="section-2.1-4.6">
            <p id="section-2.1-4.6.1">The Aggregator responsible for coordinating the protocol. It receives the
reports from Clients, aggregates them with the assistance of the Helper, and
it orchestrates the process of computing the aggregate result as requested by
the Collector. Each task has a single Leader.<a href="#section-2.1-4.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-2.1-4.7">Helper:</dt>
          <dd style="margin-left: 1.5em" id="section-2.1-4.8">
            <p id="section-2.1-4.8.1">The Aggregator assisting the Leader with the computation. The protocol is
designed so that the Helper is relatively lightweight, with most of the
operational burden borne by the Leader. Each task has a single Helper.<a href="#section-2.1-4.8.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
<p id="section-2.1-5"><a href="#dap-topology" class="auto internal xref">Figure 1</a> illustrates which participants exchange HTTP messages. Arrows
go from HTTP clients to HTTP servers. Some DAP participants may be HTTP clients
sometimes but HTTP servers at other times. It is even possible for a single
entity to perform multiple DAP roles. For example, the Collector could also be
one of the Aggregators.<a href="#section-2.1-5" class="pilcrow">¶</a></p>
<p id="section-2.1-6">In the course of a measurement task, each Client records its own measurement,
packages it up into a report, and sends it to the Leader. Each share is
encrypted to only one of the two Aggregators so that even though both pass
through the Leader, the Leader is unable to see or modify the Helper's share.
Depending on the task, the Client may only send one report or may send many
reports over time.<a href="#section-2.1-6" class="pilcrow">¶</a></p>
<p id="section-2.1-7">The Leader distributes the shares to the Helper and orchestrates the process of
verifying them and assembling them into a aggregate shares for the Collector.
Depending on the VDAF, it may be possible to process each report as it is
uploaded, or it may be necessary to wait until the Collector initializes a
collection job before processing can begin.<a href="#section-2.1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="validating-inputs">
<section id="section-2.2">
        <h3 id="name-validating-measurements">
<a href="#section-2.2" class="section-number selfRef">2.2. </a><a href="#name-validating-measurements" class="section-name selfRef">Validating Measurements</a>
        </h3>
<p id="section-2.2-1">An essential goal of any data collection pipeline is ensuring that the data
being aggregated is "valid". For example, each measurement might be expected to
be a number between 0 and 10. In DAP, input validation is complicated by the
fact that none of the entities other than the Client ever sees that Client's
plaintext measurement. To an Aggregator, a secret share of a valid measurement
is indistinguishable from a secret share of an invalid measurement.<a href="#section-2.2-1" class="pilcrow">¶</a></p>
<p id="section-2.2-2">DAP validates inputs using an interactive computation between the Leader and
Helper. At the beginning of this computation, each Aggregator holds an input
share uploaded by the Client. At the end of the computation, each Aggregator
either obtains an output share that is ready to be aggregated or rejects the
report as invalid.<a href="#section-2.2-2" class="pilcrow">¶</a></p>
<p id="section-2.2-3">This process is known as "verification" and is specified by the VDAF itself
(<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.2" class="relref">Section 5.2</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>). The report generated by the Client includes
information used by the Aggregators to verify the report. For example, Prio3
(<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-7" class="relref">Section 7</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>) includes a zero-knowledge proof of the measurement's
validity (<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-7.1" class="relref">Section 7.1</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>). Verifying this proof reveals nothing about
the underlying measurement but its validity.<a href="#section-2.2-3" class="pilcrow">¶</a></p>
<p id="section-2.2-4">The specific properties attested to by the proof depend on the measurement being
taken. For instance, if the task is measuring the latency of some operation, the
proof might demonstrate that the value reported was between 0 and 60 seconds.
But to report which of <code>N</code> options a user selected, the report might contain <code>N</code>
integers and the proof would demonstrate that <code>N-1</code> of them were <code>0</code> and the
other was <code>1</code>.<a href="#section-2.2-4" class="pilcrow">¶</a></p>
<p id="section-2.2-5">"Validity" is distinct from "correctness". For instance, the user might have
spent <code>30</code> seconds on a task but might report <code>60</code> seconds. This is a problem
with any measurement system and DAP does not attempt to address it. DAP merely
ensures that the data is within the chosen limits, so the Client could not
report <code>10^6</code>  or <code>-20</code> seconds.<a href="#section-2.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="replay-protection">
<section id="section-2.3">
        <h3 id="name-replay-protection-and-doubl">
<a href="#section-2.3" class="section-number selfRef">2.3. </a><a href="#name-replay-protection-and-doubl" class="section-name selfRef">Replay Protection and Double Collection</a>
        </h3>
<p id="section-2.3-1">Another goal of DAP is to mitigate replay attacks in which a report is
aggregated in multiple batches or multiple times in a single batch. This would
allow the attacker to learn more information about the underlying measurement
than it would otherwise.<a href="#section-2.3-1" class="pilcrow">¶</a></p>
<p id="section-2.3-2">When a Client generates a report, it also generates a random nonce, called the
"report ID". Each Aggregator is responsible for storing the IDs of reports it
has aggregated and rejecting replayed reports.<a href="#section-2.3-2" class="pilcrow">¶</a></p>
<p id="section-2.3-3">DAP must also ensure that any batch is only collected once, even if new reports
arrive that would fall into that batch. Otherwise, comparing the new aggregate
result to the previous aggregate result can violate the privacy of the added
reports.<a href="#section-2.3-3" class="pilcrow">¶</a></p>
<p id="section-2.3-4">Aggregators are responsible for refusing new reports if the batch they fall into
has been collected (<a href="#collect-flow" class="auto internal xref">Section 4.6</a>).<a href="#section-2.3-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="lifecycle-of-protocol-objects">
<section id="section-2.4">
        <h3 id="name-lifecycle-of-protocol-objec">
<a href="#section-2.4" class="section-number selfRef">2.4. </a><a href="#name-lifecycle-of-protocol-objec" class="section-name selfRef">Lifecycle of Protocol Objects</a>
        </h3>
<p id="section-2.4-1">The following diagrams illustrate how the various objects in the protocol are
constructed or transformed into other protocol objects. Oval nodes are verbs or
actions which process, transform or combine one or more objects into one or more
other objects.<a href="#section-2.4-1" class="pilcrow">¶</a></p>
<p id="section-2.4-2">The diagrams in this section do not necessarily illustrate how participants
communicate. In particular, the processing of aggregation jobs happens in
distinct, non-colluding parties.<a href="#section-2.4-2" class="pilcrow">¶</a></p>
<div id="the-upload-interaction">
<section id="section-2.4.1">
          <h4 id="name-the-upload-interaction">
<a href="#section-2.4.1" class="section-number selfRef">2.4.1. </a><a href="#name-the-upload-interaction" class="section-name selfRef">The Upload Interaction</a>
          </h4>
<p id="section-2.4.1-1">Reports are 1 to 1 with measurements. In this illustration, <code>i</code> distinct Clients
upload <code>i</code> distinct reports, but a single Client could upload multiple reports
to a task (see <a href="#sybil" class="auto internal xref">Section 8.1</a> for some implications of this). The process of sharding
measurements, constructing reports and uploading them is specified in
<a href="#upload-flow" class="auto internal xref">Section 4.4</a>.<a href="#section-2.4.1-1" class="pilcrow">¶</a></p>
<span id="name-lifecycles-of-protocol-obje"></span><div id="object-lifecycle-upload">
<figure id="figure-2">
            <div id="section-2.4.1-2.1">
              <div class="alignLeft art-svg artwork" id="section-2.4.1-2.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="528" width="576" viewBox="0 0 576 528" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                  <path d="M 56,144 L 56,160" fill="none" stroke="black"></path>
                  <path d="M 56,192 L 56,320" fill="none" stroke="black"></path>
                  <path d="M 200,48 L 200,64" fill="none" stroke="black"></path>
                  <path d="M 200,96 L 200,160" fill="none" stroke="black"></path>
                  <path d="M 200,192 L 200,208" fill="none" stroke="black"></path>
                  <path d="M 200,240 L 200,272" fill="none" stroke="black"></path>
                  <path d="M 200,304 L 200,352" fill="none" stroke="black"></path>
                  <path d="M 200,384 L 200,400" fill="none" stroke="black"></path>
                  <path d="M 200,432 L 200,496" fill="none" stroke="black"></path>
                  <path d="M 216,448 L 216,496" fill="none" stroke="black"></path>
                  <path d="M 264,464 L 264,496" fill="none" stroke="black"></path>
                  <path d="M 352,368 L 352,384" fill="none" stroke="black"></path>
                  <path d="M 352,416 L 352,448" fill="none" stroke="black"></path>
                  <path d="M 408,144 L 408,160" fill="none" stroke="black"></path>
                  <path d="M 408,192 L 408,208" fill="none" stroke="black"></path>
                  <path d="M 408,240 L 408,272" fill="none" stroke="black"></path>
                  <path d="M 408,304 L 408,320" fill="none" stroke="black"></path>
                  <path d="M 512,368 L 512,384" fill="none" stroke="black"></path>
                  <path d="M 512,416 L 512,464" fill="none" stroke="black"></path>
                  <path d="M 184,64 L 216,64" fill="none" stroke="black"></path>
                  <path d="M 184,96 L 216,96" fill="none" stroke="black"></path>
                  <path d="M 56,144 L 408,144" fill="none" stroke="black"></path>
                  <path d="M 136,208 L 264,208" fill="none" stroke="black"></path>
                  <path d="M 344,208 L 472,208" fill="none" stroke="black"></path>
                  <path d="M 136,240 L 264,240" fill="none" stroke="black"></path>
                  <path d="M 344,240 L 472,240" fill="none" stroke="black"></path>
                  <path d="M 56,320 L 408,320" fill="none" stroke="black"></path>
                  <path d="M 328,384 L 368,384" fill="none" stroke="black"></path>
                  <path d="M 488,384 L 528,384" fill="none" stroke="black"></path>
                  <path d="M 176,400 L 216,400" fill="none" stroke="black"></path>
                  <path d="M 328,416 L 368,416" fill="none" stroke="black"></path>
                  <path d="M 488,416 L 528,416" fill="none" stroke="black"></path>
                  <path d="M 176,432 L 216,432" fill="none" stroke="black"></path>
                  <path d="M 216,448 L 352,448" fill="none" stroke="black"></path>
                  <path d="M 264,464 L 512,464" fill="none" stroke="black"></path>
                  <path d="M 184,64 C 175.16936,64 168,71.16936 168,80" fill="none" stroke="black"></path>
                  <path d="M 216,64 C 224.83064,64 232,71.16936 232,80" fill="none" stroke="black"></path>
                  <path d="M 184,96 C 175.16936,96 168,88.83064 168,80" fill="none" stroke="black"></path>
                  <path d="M 216,96 C 224.83064,96 232,88.83064 232,80" fill="none" stroke="black"></path>
                  <path d="M 136,208 C 127.16936,208 120,215.16936 120,224" fill="none" stroke="black"></path>
                  <path d="M 264,208 C 272.83064,208 280,215.16936 280,224" fill="none" stroke="black"></path>
                  <path d="M 344,208 C 335.16936,208 328,215.16936 328,224" fill="none" stroke="black"></path>
                  <path d="M 472,208 C 480.83064,208 488,215.16936 488,224" fill="none" stroke="black"></path>
                  <path d="M 136,240 C 127.16936,240 120,232.83064 120,224" fill="none" stroke="black"></path>
                  <path d="M 264,240 C 272.83064,240 280,232.83064 280,224" fill="none" stroke="black"></path>
                  <path d="M 344,240 C 335.16936,240 328,232.83064 328,224" fill="none" stroke="black"></path>
                  <path d="M 472,240 C 480.83064,240 488,232.83064 488,224" fill="none" stroke="black"></path>
                  <path d="M 328,384 C 319.16936,384 312,391.16936 312,400" fill="none" stroke="black"></path>
                  <path d="M 368,384 C 376.83064,384 384,391.16936 384,400" fill="none" stroke="black"></path>
                  <path d="M 488,384 C 479.16936,384 472,391.16936 472,400" fill="none" stroke="black"></path>
                  <path d="M 528,384 C 536.83064,384 544,391.16936 544,400" fill="none" stroke="black"></path>
                  <path d="M 176,400 C 167.16936,400 160,407.16936 160,416" fill="none" stroke="black"></path>
                  <path d="M 216,400 C 224.83064,400 232,407.16936 232,416" fill="none" stroke="black"></path>
                  <path d="M 328,416 C 319.16936,416 312,408.83064 312,400" fill="none" stroke="black"></path>
                  <path d="M 368,416 C 376.83064,416 384,408.83064 384,400" fill="none" stroke="black"></path>
                  <path d="M 488,416 C 479.16936,416 472,408.83064 472,400" fill="none" stroke="black"></path>
                  <path d="M 528,416 C 536.83064,416 544,408.83064 544,400" fill="none" stroke="black"></path>
                  <path d="M 176,432 C 167.16936,432 160,424.83064 160,416" fill="none" stroke="black"></path>
                  <path d="M 216,432 C 224.83064,432 232,424.83064 232,416" fill="none" stroke="black"></path>
                  <polygon class="arrowhead" points="416,272 404,266.4 404,277.6" fill="black" transform="rotate(90,408,272)"></polygon>
                  <polygon class="arrowhead" points="272,496 260,490.4 260,501.6" fill="black" transform="rotate(90,264,496)"></polygon>
                  <polygon class="arrowhead" points="224,496 212,490.4 212,501.6" fill="black" transform="rotate(90,216,496)"></polygon>
                  <polygon class="arrowhead" points="208,496 196,490.4 196,501.6" fill="black" transform="rotate(90,200,496)"></polygon>
                  <polygon class="arrowhead" points="208,352 196,346.4 196,357.6" fill="black" transform="rotate(90,200,352)"></polygon>
                  <polygon class="arrowhead" points="208,272 196,266.4 196,277.6" fill="black" transform="rotate(90,200,272)"></polygon>
                  <polygon class="arrowhead" points="208,136 196,130.4 196,141.6" fill="black" transform="rotate(90,200,136)"></polygon>
                  <g class="text">
                    <text x="192" y="36">measurement</text>
                    <text x="248" y="36">1</text>
                    <text x="200" y="84">shard</text>
                    <text x="28" y="180">public</text>
                    <text x="80" y="180">share</text>
                    <text x="148" y="180">Leader</text>
                    <text x="200" y="180">input</text>
                    <text x="248" y="180">share</text>
                    <text x="364" y="180">Helper</text>
                    <text x="416" y="180">input</text>
                    <text x="464" y="180">share</text>
                    <text x="160" y="228">encrypt</text>
                    <text x="204" y="228">to</text>
                    <text x="244" y="228">Leader</text>
                    <text x="368" y="228">encrypt</text>
                    <text x="412" y="228">to</text>
                    <text x="452" y="228">Helper</text>
                    <text x="148" y="292">Leader</text>
                    <text x="204" y="292">report</text>
                    <text x="256" y="292">share</text>
                    <text x="356" y="292">Helper</text>
                    <text x="412" y="292">report</text>
                    <text x="464" y="292">share</text>
                    <text x="316" y="356">Client</text>
                    <text x="352" y="356">2</text>
                    <text x="388" y="356">report</text>
                    <text x="432" y="356">...</text>
                    <text x="476" y="356">Client</text>
                    <text x="512" y="356">i</text>
                    <text x="548" y="356">report</text>
                    <text x="164" y="372">Client</text>
                    <text x="200" y="372">1</text>
                    <text x="236" y="372">report</text>
                    <text x="348" y="404">upload</text>
                    <text x="508" y="404">upload</text>
                    <text x="196" y="420">upload</text>
                    <text x="240" y="500">...</text>
                    <text x="108" y="516">to</text>
                    <text x="168" y="516">aggregation</text>
                    <text x="232" y="516">job</text>
                    <text x="296" y="516">interaction</text>
                  </g>
                </svg><a href="#section-2.4.1-2.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-lifecycles-of-protocol-obje" class="selfRef">Lifecycles of protocol objects in the upload interaction</a>
            </figcaption></figure>
</div>
</section>
</div>
<div id="agg-job-lifecycle">
<section id="section-2.4.2">
          <h4 id="name-the-aggregation-interaction">
<a href="#section-2.4.2" class="section-number selfRef">2.4.2. </a><a href="#name-the-aggregation-interaction" class="section-name selfRef">The Aggregation Interaction</a>
          </h4>
<p id="section-2.4.2-1">Reports are many to 1 with aggregation jobs. The Leader assigns each of the <code>i</code>
reports into one of <code>j</code> different aggregation jobs, which can be run in parallel
by the Aggregators. Each aggregation job verifies <code>k</code> reports, outputting <code>k</code>
output shares. <code>k</code> is roughly <code>i / j</code>, but it is not necessary for aggregation
jobs to have uniform size.<a href="#section-2.4.2-1" class="pilcrow">¶</a></p>
<p id="section-2.4.2-2">See <a href="#aggregate-flow" class="auto internal xref">Section 4.5</a> for the specification of aggregation jobs and
<a href="#operational-capabilities" class="auto internal xref">Section 6</a> for some discussion of aggregation job scheduling
strategies and their performance implications.<a href="#section-2.4.2-2" class="pilcrow">¶</a></p>
<p id="section-2.4.2-3">Output shares are accumulated into <code>m</code> batch buckets, and so have a many to 1
relationship. Aggregation jobs and batch buckets are not necessarily 1 to 1. A
single aggregation job may contribute to multiple batch buckets, and multiple
aggregation jobs may contribute to the same batch bucket.<a href="#section-2.4.2-3" class="pilcrow">¶</a></p>
<p id="section-2.4.2-4">The assignation of output shares to batch buckets is specified in
<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>.<a href="#section-2.4.2-4" class="pilcrow">¶</a></p>
<span id="name-lifecycles-of-protocol-objec"></span><div id="object-lifecycle-many-agg-job">
<figure id="figure-3">
            <div id="section-2.4.2-5.1">
              <div class="alignLeft art-svg artwork" id="section-2.4.2-5.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="720" width="512" viewBox="0 0 512 720" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                  <path d="M 8,464 L 8,480" fill="none" stroke="black"></path>
                  <path d="M 56,64 L 56,96" fill="none" stroke="black"></path>
                  <path d="M 56,128 L 56,144" fill="none" stroke="black"></path>
                  <path d="M 56,336 L 56,448" fill="none" stroke="black"></path>
                  <path d="M 56,496 L 56,528" fill="none" stroke="black"></path>
                  <path d="M 56,560 L 56,576" fill="none" stroke="black"></path>
                  <path d="M 56,608 L 56,624" fill="none" stroke="black"></path>
                  <path d="M 56,656 L 56,672" fill="none" stroke="black"></path>
                  <path d="M 64,256 L 64,288" fill="none" stroke="black"></path>
                  <path d="M 72,336 L 72,368" fill="none" stroke="black"></path>
                  <path d="M 72,400 L 72,448" fill="none" stroke="black"></path>
                  <path d="M 80,496 L 80,528" fill="none" stroke="black"></path>
                  <path d="M 80,560 L 80,576" fill="none" stroke="black"></path>
                  <path d="M 80,608 L 80,624" fill="none" stroke="black"></path>
                  <path d="M 80,656 L 80,672" fill="none" stroke="black"></path>
                  <path d="M 120,192 L 120,208" fill="none" stroke="black"></path>
                  <path d="M 120,416 L 120,448" fill="none" stroke="black"></path>
                  <path d="M 128,496 L 128,528" fill="none" stroke="black"></path>
                  <path d="M 128,560 L 128,576" fill="none" stroke="black"></path>
                  <path d="M 128,608 L 128,624" fill="none" stroke="black"></path>
                  <path d="M 128,656 L 128,672" fill="none" stroke="black"></path>
                  <path d="M 176,464 L 176,480" fill="none" stroke="black"></path>
                  <path d="M 192,144 L 192,176" fill="none" stroke="black"></path>
                  <path d="M 192,336 L 192,360" fill="none" stroke="black"></path>
                  <path d="M 192,376 L 192,400" fill="none" stroke="black"></path>
                  <path d="M 200,224 L 200,288" fill="none" stroke="black"></path>
                  <path d="M 208,48 L 208,96" fill="none" stroke="black"></path>
                  <path d="M 208,128 L 208,176" fill="none" stroke="black"></path>
                  <path d="M 208,336 L 208,352" fill="none" stroke="black"></path>
                  <path d="M 216,672 L 216,688" fill="none" stroke="black"></path>
                  <path d="M 256,144 L 256,176" fill="none" stroke="black"></path>
                  <path d="M 264,464 L 264,480" fill="none" stroke="black"></path>
                  <path d="M 296,192 L 296,208" fill="none" stroke="black"></path>
                  <path d="M 304,496 L 304,528" fill="none" stroke="black"></path>
                  <path d="M 304,560 L 304,576" fill="none" stroke="black"></path>
                  <path d="M 304,608 L 304,672" fill="none" stroke="black"></path>
                  <path d="M 320,368 L 320,408" fill="none" stroke="black"></path>
                  <path d="M 320,424 L 320,448" fill="none" stroke="black"></path>
                  <path d="M 328,496 L 328,528" fill="none" stroke="black"></path>
                  <path d="M 328,560 L 328,576" fill="none" stroke="black"></path>
                  <path d="M 328,608 L 328,624" fill="none" stroke="black"></path>
                  <path d="M 328,656 L 328,672" fill="none" stroke="black"></path>
                  <path d="M 336,352 L 336,408" fill="none" stroke="black"></path>
                  <path d="M 336,424 L 336,448" fill="none" stroke="black"></path>
                  <path d="M 368,256 L 368,288" fill="none" stroke="black"></path>
                  <path d="M 368,336 L 368,416" fill="none" stroke="black"></path>
                  <path d="M 376,496 L 376,528" fill="none" stroke="black"></path>
                  <path d="M 376,560 L 376,576" fill="none" stroke="black"></path>
                  <path d="M 376,608 L 376,624" fill="none" stroke="black"></path>
                  <path d="M 376,656 L 376,672" fill="none" stroke="black"></path>
                  <path d="M 384,336 L 384,448" fill="none" stroke="black"></path>
                  <path d="M 400,64 L 400,96" fill="none" stroke="black"></path>
                  <path d="M 400,128 L 400,144" fill="none" stroke="black"></path>
                  <path d="M 424,464 L 424,480" fill="none" stroke="black"></path>
                  <path d="M 56,64 L 400,64" fill="none" stroke="black"></path>
                  <path d="M 56,144 L 192,144" fill="none" stroke="black"></path>
                  <path d="M 256,144 L 400,144" fill="none" stroke="black"></path>
                  <path d="M 136,176 L 280,176" fill="none" stroke="black"></path>
                  <path d="M 296,192 L 328,192" fill="none" stroke="black"></path>
                  <path d="M 136,224 L 280,224" fill="none" stroke="black"></path>
                  <path d="M 64,256 L 368,256" fill="none" stroke="black"></path>
                  <path d="M 208,352 L 336,352" fill="none" stroke="black"></path>
                  <path d="M 72,368 L 320,368" fill="none" stroke="black"></path>
                  <path d="M 72,400 L 192,400" fill="none" stroke="black"></path>
                  <path d="M 120,416 L 368,416" fill="none" stroke="black"></path>
                  <path d="M 24,448 L 160,448" fill="none" stroke="black"></path>
                  <path d="M 280,448 L 408,448" fill="none" stroke="black"></path>
                  <path d="M 24,496 L 160,496" fill="none" stroke="black"></path>
                  <path d="M 280,496 L 408,496" fill="none" stroke="black"></path>
                  <path d="M 56,672 L 376,672" fill="none" stroke="black"></path>
                  <path d="M 136,176 C 127.16936,176 120,183.16936 120,192" fill="none" stroke="black"></path>
                  <path d="M 280,176 C 288.83064,176 296,183.16936 296,192" fill="none" stroke="black"></path>
                  <path d="M 136,224 C 127.16936,224 120,216.83064 120,208" fill="none" stroke="black"></path>
                  <path d="M 280,224 C 288.83064,224 296,216.83064 296,208" fill="none" stroke="black"></path>
                  <path d="M 24,448 C 15.16936,448 8,455.16936 8,464" fill="none" stroke="black"></path>
                  <path d="M 160,448 C 168.83064,448 176,455.16936 176,464" fill="none" stroke="black"></path>
                  <path d="M 280,448 C 271.16936,448 264,455.16936 264,464" fill="none" stroke="black"></path>
                  <path d="M 408,448 C 416.83064,448 424,455.16936 424,464" fill="none" stroke="black"></path>
                  <path d="M 24,496 C 15.16936,496 8,488.83064 8,480" fill="none" stroke="black"></path>
                  <path d="M 160,496 C 168.83064,496 176,488.83064 176,480" fill="none" stroke="black"></path>
                  <path d="M 280,496 C 271.16936,496 264,488.83064 264,480" fill="none" stroke="black"></path>
                  <path d="M 408,496 C 416.83064,496 424,488.83064 424,480" fill="none" stroke="black"></path>
                  <polygon class="arrowhead" points="408,96 396,90.4 396,101.6" fill="black" transform="rotate(90,400,96)"></polygon>
                  <polygon class="arrowhead" points="384,624 372,618.4 372,629.6" fill="black" transform="rotate(90,376,624)"></polygon>
                  <polygon class="arrowhead" points="376,288 364,282.4 364,293.6" fill="black" transform="rotate(90,368,288)"></polygon>
                  <polygon class="arrowhead" points="336,576 324,570.4 324,581.6" fill="black" transform="rotate(90,328,576)"></polygon>
                  <polygon class="arrowhead" points="312,528 300,522.4 300,533.6" fill="black" transform="rotate(90,304,528)"></polygon>
                  <polygon class="arrowhead" points="224,688 212,682.4 212,693.6" fill="black" transform="rotate(90,216,688)"></polygon>
                  <polygon class="arrowhead" points="216,96 204,90.4 204,101.6" fill="black" transform="rotate(90,208,96)"></polygon>
                  <polygon class="arrowhead" points="208,288 196,282.4 196,293.6" fill="black" transform="rotate(90,200,288)"></polygon>
                  <polygon class="arrowhead" points="136,624 124,618.4 124,629.6" fill="black" transform="rotate(90,128,624)"></polygon>
                  <polygon class="arrowhead" points="88,576 76,570.4 76,581.6" fill="black" transform="rotate(90,80,576)"></polygon>
                  <polygon class="arrowhead" points="72,288 60,282.4 60,293.6" fill="black" transform="rotate(90,64,288)"></polygon>
                  <polygon class="arrowhead" points="64,528 52,522.4 52,533.6" fill="black" transform="rotate(90,56,528)"></polygon>
                  <polygon class="arrowhead" points="64,96 52,90.4 52,101.6" fill="black" transform="rotate(90,56,96)"></polygon>
                  <g class="text">
                    <text x="132" y="36">from</text>
                    <text x="180" y="36">upload</text>
                    <text x="256" y="36">interaction</text>
                    <text x="28" y="116">Client</text>
                    <text x="84" y="116">report</text>
                    <text x="120" y="116">1</text>
                    <text x="180" y="116">Client</text>
                    <text x="236" y="116">report</text>
                    <text x="272" y="116">2</text>
                    <text x="312" y="116">...</text>
                    <text x="372" y="116">Client</text>
                    <text x="428" y="116">report</text>
                    <text x="464" y="116">i</text>
                    <text x="232" y="164">...</text>
                    <text x="180" y="196">assign</text>
                    <text x="240" y="196">reports</text>
                    <text x="384" y="196">aggregation</text>
                    <text x="472" y="196">parameter</text>
                    <text x="140" y="212">to</text>
                    <text x="200" y="212">aggregation</text>
                    <text x="268" y="212">jobs</text>
                    <text x="372" y="212">chosen</text>
                    <text x="412" y="212">by</text>
                    <text x="464" y="212">Collector</text>
                    <text x="64" y="308">aggregation</text>
                    <text x="200" y="308">aggregation</text>
                    <text x="288" y="308">...</text>
                    <text x="368" y="308">aggregation</text>
                    <text x="56" y="324">job</text>
                    <text x="80" y="324">1</text>
                    <text x="192" y="324">job</text>
                    <text x="216" y="324">2</text>
                    <text x="368" y="324">job</text>
                    <text x="392" y="324">j</text>
                    <text x="96" y="436">...</text>
                    <text x="360" y="436">...</text>
                    <text x="60" y="468">accumulate</text>
                    <text x="132" y="468">Leader</text>
                    <text x="316" y="468">accumulate</text>
                    <text x="388" y="468">Helper</text>
                    <text x="60" y="484">output</text>
                    <text x="116" y="484">shares</text>
                    <text x="316" y="484">output</text>
                    <text x="372" y="484">shares</text>
                    <text x="104" y="516">...</text>
                    <text x="352" y="516">...</text>
                    <text x="28" y="548">Leader</text>
                    <text x="80" y="548">batch</text>
                    <text x="132" y="548">bucket</text>
                    <text x="168" y="548">1</text>
                    <text x="292" y="548">Helper</text>
                    <text x="344" y="548">batch</text>
                    <text x="396" y="548">bucket</text>
                    <text x="432" y="548">1</text>
                    <text x="44" y="596">Leader</text>
                    <text x="96" y="596">batch</text>
                    <text x="148" y="596">bucket</text>
                    <text x="184" y="596">2</text>
                    <text x="308" y="596">Helper</text>
                    <text x="360" y="596">batch</text>
                    <text x="412" y="596">bucket</text>
                    <text x="448" y="596">2</text>
                    <text x="60" y="644">Leader</text>
                    <text x="112" y="644">batch</text>
                    <text x="164" y="644">bucket</text>
                    <text x="200" y="644">m</text>
                    <text x="340" y="644">Helper</text>
                    <text x="392" y="644">batch</text>
                    <text x="444" y="644">bucket</text>
                    <text x="480" y="644">m</text>
                    <text x="104" y="660">...</text>
                    <text x="352" y="660">...</text>
                    <text x="124" y="708">to</text>
                    <text x="180" y="708">collection</text>
                    <text x="272" y="708">interaction</text>
                  </g>
                </svg><a href="#section-2.4.2-5.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-lifecycles-of-protocol-objec" class="selfRef">Lifecycles of protocol objects in the aggregation job interaction</a>
            </figcaption></figure>
</div>
<p id="section-2.4.2-6">Each aggregation job verifies <code>k</code> reports (each consisting of a public share,
Leader report share and Helper report share) into <code>k</code> Leader output shares and
<code>k</code> Helper output shares. The aggregation parameter is chosen by the Collector
(or in some settings it may be known prior to the Collector's involvement, as
discussed in <a href="#eager-aggregation" class="auto internal xref">Section 4.5.1</a>) and is used to verify all the reports in
one or more aggregation jobs.<a href="#section-2.4.2-6" class="pilcrow">¶</a></p>
<span id="name-detail-of-an-individual-agg"></span><div id="object-lifecycle-agg-job">
<figure id="figure-4">
            <div id="section-2.4.2-7.1">
              <div class="alignLeft art-svg artwork" id="section-2.4.2-7.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="256" width="496" viewBox="0 0 496 256" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                  <path d="M 48,48 L 48,80" fill="none" stroke="black"></path>
                  <path d="M 48,112 L 48,144" fill="none" stroke="black"></path>
                  <path d="M 72,48 L 72,80" fill="none" stroke="black"></path>
                  <path d="M 80,112 L 80,144" fill="none" stroke="black"></path>
                  <path d="M 80,192 L 80,208" fill="none" stroke="black"></path>
                  <path d="M 184,48 L 184,80" fill="none" stroke="black"></path>
                  <path d="M 184,112 L 184,144" fill="none" stroke="black"></path>
                  <path d="M 208,48 L 208,80" fill="none" stroke="black"></path>
                  <path d="M 216,112 L 216,144" fill="none" stroke="black"></path>
                  <path d="M 216,192 L 216,208" fill="none" stroke="black"></path>
                  <path d="M 344,48 L 344,80" fill="none" stroke="black"></path>
                  <path d="M 344,112 L 344,144" fill="none" stroke="black"></path>
                  <path d="M 368,48 L 368,80" fill="none" stroke="black"></path>
                  <path d="M 376,112 L 376,144" fill="none" stroke="black"></path>
                  <path d="M 376,192 L 376,208" fill="none" stroke="black"></path>
                  <path d="M 72,48 L 176,48" fill="none" stroke="black"></path>
                  <path d="M 192,48 L 336,48" fill="none" stroke="black"></path>
                  <path d="M 352,48 L 392,48" fill="none" stroke="black"></path>
                  <path d="M 24,80 L 112,80" fill="none" stroke="black"></path>
                  <path d="M 168,80 L 256,80" fill="none" stroke="black"></path>
                  <path d="M 336,80 L 424,80" fill="none" stroke="black"></path>
                  <path d="M 24,112 L 112,112" fill="none" stroke="black"></path>
                  <path d="M 168,112 L 256,112" fill="none" stroke="black"></path>
                  <path d="M 336,112 L 424,112" fill="none" stroke="black"></path>
                  <path d="M 24,80 C 15.16936,80 8,87.16936 8,96" fill="none" stroke="black"></path>
                  <path d="M 112,80 C 120.83064,80 128,87.16936 128,96" fill="none" stroke="black"></path>
                  <path d="M 168,80 C 159.16936,80 152,87.16936 152,96" fill="none" stroke="black"></path>
                  <path d="M 256,80 C 264.83064,80 272,87.16936 272,96" fill="none" stroke="black"></path>
                  <path d="M 336,80 C 327.16936,80 320,87.16936 320,96" fill="none" stroke="black"></path>
                  <path d="M 424,80 C 432.83064,80 440,87.16936 440,96" fill="none" stroke="black"></path>
                  <path d="M 24,112 C 15.16936,112 8,104.83064 8,96" fill="none" stroke="black"></path>
                  <path d="M 112,112 C 120.83064,112 128,104.83064 128,96" fill="none" stroke="black"></path>
                  <path d="M 168,112 C 159.16936,112 152,104.83064 152,96" fill="none" stroke="black"></path>
                  <path d="M 256,112 C 264.83064,112 272,104.83064 272,96" fill="none" stroke="black"></path>
                  <path d="M 336,112 C 327.16936,112 320,104.83064 320,96" fill="none" stroke="black"></path>
                  <path d="M 424,112 C 432.83064,112 440,104.83064 440,96" fill="none" stroke="black"></path>
                  <polygon class="arrowhead" points="384,208 372,202.4 372,213.6" fill="black" transform="rotate(90,376,208)"></polygon>
                  <polygon class="arrowhead" points="352,144 340,138.4 340,149.6" fill="black" transform="rotate(90,344,144)"></polygon>
                  <polygon class="arrowhead" points="224,208 212,202.4 212,213.6" fill="black" transform="rotate(90,216,208)"></polygon>
                  <polygon class="arrowhead" points="192,144 180,138.4 180,149.6" fill="black" transform="rotate(90,184,144)"></polygon>
                  <polygon class="arrowhead" points="88,208 76,202.4 76,213.6" fill="black" transform="rotate(90,80,208)"></polygon>
                  <polygon class="arrowhead" points="56,144 44,138.4 44,149.6" fill="black" transform="rotate(90,48,144)"></polygon>
                  <g class="text">
                    <text x="44" y="36">report</text>
                    <text x="80" y="36">1</text>
                    <text x="180" y="36">report</text>
                    <text x="216" y="36">2</text>
                    <text x="264" y="36">...</text>
                    <text x="340" y="36">report</text>
                    <text x="376" y="36">k</text>
                    <text x="448" y="52">aggregation</text>
                    <text x="448" y="68">parameter</text>
                    <text x="68" y="100">verification</text>
                    <text x="212" y="100">verification</text>
                    <text x="296" y="100">...</text>
                    <text x="380" y="100">verification</text>
                    <text x="36" y="164">leader</text>
                    <text x="92" y="164">output</text>
                    <text x="172" y="164">leader</text>
                    <text x="228" y="164">output</text>
                    <text x="280" y="164">...</text>
                    <text x="332" y="164">leader</text>
                    <text x="388" y="164">output</text>
                    <text x="56" y="180">share</text>
                    <text x="88" y="180">1</text>
                    <text x="192" y="180">share</text>
                    <text x="224" y="180">2</text>
                    <text x="352" y="180">share</text>
                    <text x="384" y="180">k</text>
                    <text x="52" y="228">helper</text>
                    <text x="108" y="228">output</text>
                    <text x="188" y="228">helper</text>
                    <text x="244" y="228">output</text>
                    <text x="296" y="228">...</text>
                    <text x="348" y="228">helper</text>
                    <text x="404" y="228">output</text>
                    <text x="72" y="244">share</text>
                    <text x="104" y="244">1</text>
                    <text x="208" y="244">share</text>
                    <text x="240" y="244">2</text>
                    <text x="368" y="244">share</text>
                    <text x="400" y="244">k</text>
                  </g>
                </svg><a href="#section-2.4.2-7.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-detail-of-an-individual-agg" class="selfRef">Detail of an individual aggregation job</a>
            </figcaption></figure>
</div>
<p id="section-2.4.2-8">Report shares, input shares and output shares have a 1 to 1 to 1 relationship.
Report shares are decrypted into input shares and then refined into output
shares during VDAF verification.<a href="#section-2.4.2-8" class="pilcrow">¶</a></p>
<span id="name-detail-of-verification-of-a"></span><div id="object-lifecycle-report-verify">
<figure id="figure-5">
            <div id="section-2.4.2-9.1">
              <div class="alignLeft art-svg artwork" id="section-2.4.2-9.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="384" width="456" viewBox="0 0 456 384" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                  <path d="M 48,64 L 48,80" fill="none" stroke="black"></path>
                  <path d="M 48,128 L 48,144" fill="none" stroke="black"></path>
                  <path d="M 48,176 L 48,208" fill="none" stroke="black"></path>
                  <path d="M 48,256 L 48,272" fill="none" stroke="black"></path>
                  <path d="M 56,304 L 56,336" fill="none" stroke="black"></path>
                  <path d="M 176,48 L 176,80" fill="none" stroke="black"></path>
                  <path d="M 176,128 L 176,144" fill="none" stroke="black"></path>
                  <path d="M 176,176 L 176,208" fill="none" stroke="black"></path>
                  <path d="M 176,256 L 176,272" fill="none" stroke="black"></path>
                  <path d="M 184,304 L 184,336" fill="none" stroke="black"></path>
                  <path d="M 280,64 L 280,80" fill="none" stroke="black"></path>
                  <path d="M 280,128 L 280,272" fill="none" stroke="black"></path>
                  <path d="M 368,48 L 368,288" fill="none" stroke="black"></path>
                  <path d="M 48,64 L 280,64" fill="none" stroke="black"></path>
                  <path d="M 24,144 L 72,144" fill="none" stroke="black"></path>
                  <path d="M 152,144 L 200,144" fill="none" stroke="black"></path>
                  <path d="M 24,176 L 72,176" fill="none" stroke="black"></path>
                  <path d="M 152,176 L 200,176" fill="none" stroke="black"></path>
                  <path d="M 24,272 L 280,272" fill="none" stroke="black"></path>
                  <path d="M 296,288 L 368,288" fill="none" stroke="black"></path>
                  <path d="M 24,304 L 280,304" fill="none" stroke="black"></path>
                  <path d="M 24,144 C 15.16936,144 8,151.16936 8,160" fill="none" stroke="black"></path>
                  <path d="M 72,144 C 80.83064,144 88,151.16936 88,160" fill="none" stroke="black"></path>
                  <path d="M 152,144 C 143.16936,144 136,151.16936 136,160" fill="none" stroke="black"></path>
                  <path d="M 200,144 C 208.83064,144 216,151.16936 216,160" fill="none" stroke="black"></path>
                  <path d="M 24,176 C 15.16936,176 8,168.83064 8,160" fill="none" stroke="black"></path>
                  <path d="M 72,176 C 80.83064,176 88,168.83064 88,160" fill="none" stroke="black"></path>
                  <path d="M 152,176 C 143.16936,176 136,168.83064 136,160" fill="none" stroke="black"></path>
                  <path d="M 200,176 C 208.83064,176 216,168.83064 216,160" fill="none" stroke="black"></path>
                  <path d="M 24,272 C 15.16936,272 8,279.16936 8,288" fill="none" stroke="black"></path>
                  <path d="M 280,272 C 288.83064,272 296,279.16936 296,288" fill="none" stroke="black"></path>
                  <path d="M 24,304 C 15.16936,304 8,296.83064 8,288" fill="none" stroke="black"></path>
                  <path d="M 280,304 C 288.83064,304 296,296.83064 296,288" fill="none" stroke="black"></path>
                  <polygon class="arrowhead" points="192,336 180,330.4 180,341.6" fill="black" transform="rotate(90,184,336)"></polygon>
                  <polygon class="arrowhead" points="184,208 172,202.4 172,213.6" fill="black" transform="rotate(90,176,208)"></polygon>
                  <polygon class="arrowhead" points="64,336 52,330.4 52,341.6" fill="black" transform="rotate(90,56,336)"></polygon>
                  <polygon class="arrowhead" points="56,208 44,202.4 44,213.6" fill="black" transform="rotate(90,48,208)"></polygon>
                  <g class="text">
                    <text x="172" y="36">report</text>
                    <text x="328" y="36">aggregation</text>
                    <text x="416" y="36">parameter</text>
                    <text x="44" y="100">Leader</text>
                    <text x="148" y="100">Helper</text>
                    <text x="204" y="100">report</text>
                    <text x="284" y="100">public</text>
                    <text x="28" y="116">report</text>
                    <text x="80" y="116">share</text>
                    <text x="176" y="116">share</text>
                    <text x="280" y="116">share</text>
                    <text x="48" y="164">decrypt</text>
                    <text x="176" y="164">decrypt</text>
                    <text x="52" y="228">Leader</text>
                    <text x="180" y="228">Helper</text>
                    <text x="24" y="244">input</text>
                    <text x="72" y="244">share</text>
                    <text x="152" y="244">input</text>
                    <text x="200" y="244">share</text>
                    <text x="100" y="292">verify</text>
                    <text x="152" y="292">input</text>
                    <text x="200" y="292">share</text>
                    <text x="28" y="356">Leader</text>
                    <text x="84" y="356">output</text>
                    <text x="156" y="356">Helper</text>
                    <text x="212" y="356">output</text>
                    <text x="56" y="372">share</text>
                    <text x="184" y="372">share</text>
                  </g>
                </svg><a href="#section-2.4.2-9.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-detail-of-verification-of-a" class="selfRef">Detail of verification of an individual report</a>
            </figcaption></figure>
</div>
</section>
</div>
<div id="the-collection-interaction">
<section id="section-2.4.3">
          <h4 id="name-the-collection-interaction">
<a href="#section-2.4.3" class="section-number selfRef">2.4.3. </a><a href="#name-the-collection-interaction" class="section-name selfRef">The Collection Interaction</a>
          </h4>
<p id="section-2.4.3-1">Using the Collector's query, each Aggregator will merge one or more batch
buckets together into its aggregate share, meaning batch buckets are many to 1
with aggregate shares.<a href="#section-2.4.3-1" class="pilcrow">¶</a></p>
<p id="section-2.4.3-2">The Leader and Helper finally deliver their encrypted aggregate shares to the
Collector to be decrypted and then unsharded into the aggregate result. Since
there are always exactly two Aggregators, aggregate shares are 2 to 1 with
aggregate results. The collection interaction is specified in <a href="#collect-flow" class="auto internal xref">Section 4.6</a>.<a href="#section-2.4.3-2" class="pilcrow">¶</a></p>
<p id="section-2.4.3-3">There can be many aggregate results for a single task. The Collection process
may occur multiple times for each task, with the Collector obtaining multiple
aggregate results. For example, imagine tasks where the Collector obtains
aggregate results once an hour, or every time 10,000,000 reports are uploaded.<a href="#section-2.4.3-3" class="pilcrow">¶</a></p>
<span id="name-lifecycles-of-protocol-object"></span><div id="object-lifecycle-collection">
<figure id="figure-6">
            <div id="section-2.4.3-4.1">
              <div class="alignLeft art-svg artwork" id="section-2.4.3-4.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="752" width="488" viewBox="0 0 488 752" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                  <path d="M 40,288 L 40,304" fill="none" stroke="black"></path>
                  <path d="M 72,64 L 72,96" fill="none" stroke="black"></path>
                  <path d="M 72,128 L 72,144" fill="none" stroke="black"></path>
                  <path d="M 72,176 L 72,192" fill="none" stroke="black"></path>
                  <path d="M 72,224 L 72,264" fill="none" stroke="black"></path>
                  <path d="M 88,64 L 88,96" fill="none" stroke="black"></path>
                  <path d="M 88,128 L 88,144" fill="none" stroke="black"></path>
                  <path d="M 88,176 L 88,192" fill="none" stroke="black"></path>
                  <path d="M 88,224 L 88,264" fill="none" stroke="black"></path>
                  <path d="M 104,320 L 104,352" fill="none" stroke="black"></path>
                  <path d="M 104,384 L 104,400" fill="none" stroke="black"></path>
                  <path d="M 104,432 L 104,464" fill="none" stroke="black"></path>
                  <path d="M 104,512 L 104,528" fill="none" stroke="black"></path>
                  <path d="M 104,560 L 104,592" fill="none" stroke="black"></path>
                  <path d="M 104,624 L 104,640" fill="none" stroke="black"></path>
                  <path d="M 136,64 L 136,96" fill="none" stroke="black"></path>
                  <path d="M 136,128 L 136,144" fill="none" stroke="black"></path>
                  <path d="M 136,176 L 136,192" fill="none" stroke="black"></path>
                  <path d="M 136,224 L 136,264" fill="none" stroke="black"></path>
                  <path d="M 168,288 L 168,304" fill="none" stroke="black"></path>
                  <path d="M 216,48 L 216,64" fill="none" stroke="black"></path>
                  <path d="M 232,272 L 232,304" fill="none" stroke="black"></path>
                  <path d="M 232,640 L 232,672" fill="none" stroke="black"></path>
                  <path d="M 232,704 L 232,720" fill="none" stroke="black"></path>
                  <path d="M 296,288 L 296,304" fill="none" stroke="black"></path>
                  <path d="M 328,64 L 328,96" fill="none" stroke="black"></path>
                  <path d="M 328,128 L 328,144" fill="none" stroke="black"></path>
                  <path d="M 328,176 L 328,192" fill="none" stroke="black"></path>
                  <path d="M 328,224 L 328,264" fill="none" stroke="black"></path>
                  <path d="M 344,64 L 344,96" fill="none" stroke="black"></path>
                  <path d="M 344,128 L 344,144" fill="none" stroke="black"></path>
                  <path d="M 344,176 L 344,192" fill="none" stroke="black"></path>
                  <path d="M 344,224 L 344,264" fill="none" stroke="black"></path>
                  <path d="M 360,320 L 360,352" fill="none" stroke="black"></path>
                  <path d="M 360,384 L 360,400" fill="none" stroke="black"></path>
                  <path d="M 360,432 L 360,464" fill="none" stroke="black"></path>
                  <path d="M 360,512 L 360,528" fill="none" stroke="black"></path>
                  <path d="M 360,560 L 360,592" fill="none" stroke="black"></path>
                  <path d="M 360,624 L 360,640" fill="none" stroke="black"></path>
                  <path d="M 392,64 L 392,96" fill="none" stroke="black"></path>
                  <path d="M 392,128 L 392,144" fill="none" stroke="black"></path>
                  <path d="M 392,176 L 392,192" fill="none" stroke="black"></path>
                  <path d="M 392,224 L 392,264" fill="none" stroke="black"></path>
                  <path d="M 424,288 L 424,304" fill="none" stroke="black"></path>
                  <path d="M 72,64 L 392,64" fill="none" stroke="black"></path>
                  <path d="M 56,272 L 152,272" fill="none" stroke="black"></path>
                  <path d="M 312,272 L 408,272" fill="none" stroke="black"></path>
                  <path d="M 168,304 L 296,304" fill="none" stroke="black"></path>
                  <path d="M 56,320 L 152,320" fill="none" stroke="black"></path>
                  <path d="M 312,320 L 408,320" fill="none" stroke="black"></path>
                  <path d="M 40,400 L 192,400" fill="none" stroke="black"></path>
                  <path d="M 296,400 L 448,400" fill="none" stroke="black"></path>
                  <path d="M 40,432 L 192,432" fill="none" stroke="black"></path>
                  <path d="M 296,432 L 448,432" fill="none" stroke="black"></path>
                  <path d="M 80,528 L 128,528" fill="none" stroke="black"></path>
                  <path d="M 336,528 L 384,528" fill="none" stroke="black"></path>
                  <path d="M 80,560 L 128,560" fill="none" stroke="black"></path>
                  <path d="M 336,560 L 384,560" fill="none" stroke="black"></path>
                  <path d="M 104,640 L 360,640" fill="none" stroke="black"></path>
                  <path d="M 208,672 L 256,672" fill="none" stroke="black"></path>
                  <path d="M 208,704 L 256,704" fill="none" stroke="black"></path>
                  <path d="M 56,272 C 47.16936,272 40,279.16936 40,288" fill="none" stroke="black"></path>
                  <path d="M 152,272 C 160.83064,272 168,279.16936 168,288" fill="none" stroke="black"></path>
                  <path d="M 312,272 C 303.16936,272 296,279.16936 296,288" fill="none" stroke="black"></path>
                  <path d="M 408,272 C 416.83064,272 424,279.16936 424,288" fill="none" stroke="black"></path>
                  <path d="M 56,320 C 47.16936,320 40,312.83064 40,304" fill="none" stroke="black"></path>
                  <path d="M 152,320 C 160.83064,320 168,312.83064 168,304" fill="none" stroke="black"></path>
                  <path d="M 312,320 C 303.16936,320 296,312.83064 296,304" fill="none" stroke="black"></path>
                  <path d="M 408,320 C 416.83064,320 424,312.83064 424,304" fill="none" stroke="black"></path>
                  <path d="M 40,400 C 31.16936,400 24,407.16936 24,416" fill="none" stroke="black"></path>
                  <path d="M 192,400 C 200.83064,400 208,407.16936 208,416" fill="none" stroke="black"></path>
                  <path d="M 296,400 C 287.16936,400 280,407.16936 280,416" fill="none" stroke="black"></path>
                  <path d="M 448,400 C 456.83064,400 464,407.16936 464,416" fill="none" stroke="black"></path>
                  <path d="M 40,432 C 31.16936,432 24,424.83064 24,416" fill="none" stroke="black"></path>
                  <path d="M 192,432 C 200.83064,432 208,424.83064 208,416" fill="none" stroke="black"></path>
                  <path d="M 296,432 C 287.16936,432 280,424.83064 280,416" fill="none" stroke="black"></path>
                  <path d="M 448,432 C 456.83064,432 464,424.83064 464,416" fill="none" stroke="black"></path>
                  <path d="M 80,528 C 71.16936,528 64,535.16936 64,544" fill="none" stroke="black"></path>
                  <path d="M 128,528 C 136.83064,528 144,535.16936 144,544" fill="none" stroke="black"></path>
                  <path d="M 336,528 C 327.16936,528 320,535.16936 320,544" fill="none" stroke="black"></path>
                  <path d="M 384,528 C 392.83064,528 400,535.16936 400,544" fill="none" stroke="black"></path>
                  <path d="M 80,560 C 71.16936,560 64,552.83064 64,544" fill="none" stroke="black"></path>
                  <path d="M 128,560 C 136.83064,560 144,552.83064 144,544" fill="none" stroke="black"></path>
                  <path d="M 336,560 C 327.16936,560 320,552.83064 320,544" fill="none" stroke="black"></path>
                  <path d="M 384,560 C 392.83064,560 400,552.83064 400,544" fill="none" stroke="black"></path>
                  <path d="M 208,672 C 199.16936,672 192,679.16936 192,688" fill="none" stroke="black"></path>
                  <path d="M 256,672 C 264.83064,672 272,679.16936 272,688" fill="none" stroke="black"></path>
                  <path d="M 208,704 C 199.16936,704 192,696.83064 192,688" fill="none" stroke="black"></path>
                  <path d="M 256,704 C 264.83064,704 272,696.83064 272,688" fill="none" stroke="black"></path>
                  <polygon class="arrowhead" points="400,264 388,258.4 388,269.6" fill="black" transform="rotate(90,392,264)"></polygon>
                  <polygon class="arrowhead" points="400,192 388,186.4 388,197.6" fill="black" transform="rotate(90,392,192)"></polygon>
                  <polygon class="arrowhead" points="368,592 356,586.4 356,597.6" fill="black" transform="rotate(90,360,592)"></polygon>
                  <polygon class="arrowhead" points="368,464 356,458.4 356,469.6" fill="black" transform="rotate(90,360,464)"></polygon>
                  <polygon class="arrowhead" points="368,352 356,346.4 356,357.6" fill="black" transform="rotate(90,360,352)"></polygon>
                  <polygon class="arrowhead" points="352,264 340,258.4 340,269.6" fill="black" transform="rotate(90,344,264)"></polygon>
                  <polygon class="arrowhead" points="352,144 340,138.4 340,149.6" fill="black" transform="rotate(90,344,144)"></polygon>
                  <polygon class="arrowhead" points="336,264 324,258.4 324,269.6" fill="black" transform="rotate(90,328,264)"></polygon>
                  <polygon class="arrowhead" points="336,96 324,90.4 324,101.6" fill="black" transform="rotate(90,328,96)"></polygon>
                  <polygon class="arrowhead" points="240,720 228,714.4 228,725.6" fill="black" transform="rotate(90,232,720)"></polygon>
                  <polygon class="arrowhead" points="144,264 132,258.4 132,269.6" fill="black" transform="rotate(90,136,264)"></polygon>
                  <polygon class="arrowhead" points="144,192 132,186.4 132,197.6" fill="black" transform="rotate(90,136,192)"></polygon>
                  <polygon class="arrowhead" points="112,592 100,586.4 100,597.6" fill="black" transform="rotate(90,104,592)"></polygon>
                  <polygon class="arrowhead" points="112,464 100,458.4 100,469.6" fill="black" transform="rotate(90,104,464)"></polygon>
                  <polygon class="arrowhead" points="112,352 100,346.4 100,357.6" fill="black" transform="rotate(90,104,352)"></polygon>
                  <polygon class="arrowhead" points="96,264 84,258.4 84,269.6" fill="black" transform="rotate(90,88,264)"></polygon>
                  <polygon class="arrowhead" points="96,144 84,138.4 84,149.6" fill="black" transform="rotate(90,88,144)"></polygon>
                  <polygon class="arrowhead" points="80,264 68,258.4 68,269.6" fill="black" transform="rotate(90,72,264)"></polygon>
                  <polygon class="arrowhead" points="80,96 68,90.4 68,101.6" fill="black" transform="rotate(90,72,96)"></polygon>
                  <g class="text">
                    <text x="116" y="36">from</text>
                    <text x="184" y="36">aggregation</text>
                    <text x="280" y="36">interaction</text>
                    <text x="28" y="116">Leader</text>
                    <text x="80" y="116">batch</text>
                    <text x="132" y="116">bucket</text>
                    <text x="168" y="116">1</text>
                    <text x="292" y="116">Helper</text>
                    <text x="344" y="116">batch</text>
                    <text x="396" y="116">bucket</text>
                    <text x="432" y="116">1</text>
                    <text x="44" y="164">Leader</text>
                    <text x="96" y="164">batch</text>
                    <text x="148" y="164">bucket</text>
                    <text x="184" y="164">2</text>
                    <text x="308" y="164">Helper</text>
                    <text x="360" y="164">batch</text>
                    <text x="412" y="164">bucket</text>
                    <text x="448" y="164">2</text>
                    <text x="60" y="212">Leader</text>
                    <text x="112" y="212">batch</text>
                    <text x="164" y="212">bucket</text>
                    <text x="200" y="212">m</text>
                    <text x="340" y="212">Helper</text>
                    <text x="392" y="212">batch</text>
                    <text x="444" y="212">bucket</text>
                    <text x="480" y="212">m</text>
                    <text x="200" y="244">query</text>
                    <text x="252" y="244">chosen</text>
                    <text x="112" y="260">...</text>
                    <text x="188" y="260">by</text>
                    <text x="240" y="260">Collector</text>
                    <text x="368" y="260">...</text>
                    <text x="80" y="292">merge</text>
                    <text x="132" y="292">Leader</text>
                    <text x="328" y="292">merge</text>
                    <text x="380" y="292">Helper</text>
                    <text x="72" y="308">batch</text>
                    <text x="128" y="308">buckets</text>
                    <text x="328" y="308">batch</text>
                    <text x="384" y="308">buckets</text>
                    <text x="44" y="372">Leader</text>
                    <text x="112" y="372">aggregate</text>
                    <text x="176" y="372">share</text>
                    <text x="300" y="372">Helper</text>
                    <text x="368" y="372">aggregate</text>
                    <text x="432" y="372">share</text>
                    <text x="64" y="420">encrypt</text>
                    <text x="108" y="420">to</text>
                    <text x="160" y="420">Collector</text>
                    <text x="320" y="420">encrypt</text>
                    <text x="364" y="420">to</text>
                    <text x="416" y="420">Collector</text>
                    <text x="80" y="484">encrypted</text>
                    <text x="148" y="484">Leader</text>
                    <text x="336" y="484">encrypted</text>
                    <text x="404" y="484">Helper</text>
                    <text x="88" y="500">aggregate</text>
                    <text x="152" y="500">share</text>
                    <text x="336" y="500">aggregate</text>
                    <text x="400" y="500">share</text>
                    <text x="104" y="548">decrypt</text>
                    <text x="360" y="548">decrypt</text>
                    <text x="44" y="612">Leader</text>
                    <text x="112" y="612">aggregate</text>
                    <text x="176" y="612">share</text>
                    <text x="300" y="612">Helper</text>
                    <text x="368" y="612">aggregate</text>
                    <text x="432" y="612">share</text>
                    <text x="232" y="692">unshard</text>
                    <text x="208" y="740">aggregate</text>
                    <text x="276" y="740">result</text>
                  </g>
                </svg><a href="#section-2.4.3-4.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-6" class="selfRef">Figure 6</a>:
<a href="#name-lifecycles-of-protocol-object" class="selfRef">Lifecycles of protocol objects in the collection interaction</a>
            </figcaption></figure>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="http-usage">
<section id="section-3">
      <h2 id="name-http-usage">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-http-usage" class="section-name selfRef">HTTP Usage</a>
      </h2>
<p id="section-3-1">DAP is defined in terms of HTTP <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span> resources. These are HPKE
configurations (<a href="#hpke-config" class="auto internal xref">Section 4.4.1</a>), reports (<a href="#upload-flow" class="auto internal xref">Section 4.4</a>), aggregation jobs
(<a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>), collection jobs (<a href="#collect-flow" class="auto internal xref">Section 4.6</a>), and aggregate shares
(<a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a>).<a href="#section-3-1" class="pilcrow">¶</a></p>
<p id="section-3-2">Each resource has a URL. Resource URLs are specified as string literals
containing variables. Variables are expanded into strings according to the
following rules:<a href="#section-3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-3.1">
          <p id="section-3-3.1.1">Variables <code>{leader}</code> and <code>{helper}</code> are replaced with the base API URL of the
Leader and Helper respectively.<a href="#section-3-3.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-3-3.2">
          <p id="section-3-3.2.1">Variables <code>{task-id}</code>, <code>{aggregation-job-id}</code>, <code>{aggregate-share-id}</code>, and
<code>{collection-job-id}</code> are replaced with the task ID (<a href="#task-configuration" class="auto internal xref">Section 4.2</a>),
aggregation job ID (<a href="#agg-init" class="auto internal xref">Section 4.5.2</a>), aggregate share ID (<a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a>)
and collection job ID (<a href="#collect-init" class="auto internal xref">Section 4.6.1</a>) respectively. The value <span class="bcp14">MUST</span> be
encoded in its URL-safe, unpadded Base 64 representation as specified in
Sections <a href="https://rfc-editor.org/rfc/rfc4648#section-5" class="relref">5</a> and <a href="https://rfc-editor.org/rfc/rfc4648#section-3.2" class="relref">3.2</a> of <span>[<a href="#RFC4648" class="cite xref">RFC4648</a>]</span>.<a href="#section-3-3.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-3-4">For example, given a helper URL "https://example.com/api/dap", task ID "f0 16 34
47 36 4c cf 1b c0 e3 af fc ca 68 73 c9 c3 81 f6 4a cd f9 02 06 62 f8 3f 46 c0 72
19 e7" and an aggregation job ID "95 ce da 51 e1 a9 75 23 68 b0 d9 61 f9 46 61
28" (32 and 16 byte octet strings, represented in hexadecimal), resource URL
<code>{helper}/tasks/{task-id}/aggregation_jobs/{aggregation-job-id}</code> would be
expanded into
<code>https://example.com/api/dap/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA</code>.<a href="#section-3-4" class="pilcrow">¶</a></p>
<p id="section-3-5">Protocol participants act on resources using HTTP requests, which follow the
semantics laid out in <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>, in particular with regard to safety and
idempotence of HTTP methods (Sections <a href="https://rfc-editor.org/rfc/rfc9110#section-9.2.1" class="relref">9.2.1</a> and <a href="https://rfc-editor.org/rfc/rfc9110#section-9.2.2" class="relref">9.2.2</a> of <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>,
respectively).<a href="#section-3-5" class="pilcrow">¶</a></p>
<p id="section-3-6">The use of HTTPS is <span class="bcp14">REQUIRED</span> to provide server authentication and
confidentiality. TLS certificates <span class="bcp14">MUST</span> be checked according to <span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-4.3.4" class="relref">Section 4.3.4</a></span>.<a href="#section-3-6" class="pilcrow">¶</a></p>
<div id="asynchronous-request-handling">
<section id="section-3.1">
        <h3 id="name-asynchronous-request-handli">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-asynchronous-request-handli" class="section-name selfRef">Asynchronous Request Handling</a>
        </h3>
<p id="section-3.1-1">Many of the protocol's interactions may be handled asynchronously so that
servers can appropriately allocate resources for long-running transactions.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">In DAP, an HTTP server indicates that it is deferring the handling of a request
by immediately sending an empty response body with a successful status code
(<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-15.3" class="relref">Section 15.3</a></span>). The response <span class="bcp14">SHOULD</span> include a Retry-After field
(<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-10.2.3" class="relref">Section 10.2.3</a></span>) to suggest a polling interval to the HTTP client.
The HTTP client then polls the state of the resource by sending GET requests to
the resource URL. In some interactions, the resource's location will be
indicated by a Location header in the HTTP server's response (<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-10.2.2" class="relref">Section 10.2.2</a></span>). Otherwise the resource URL is the URL to which the HTTP
client initially sent its request.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1-3">The HTTP client <span class="bcp14">SHOULD</span> use each response's Retry-After header field to decide
when to fetch the resource. The HTTP server responds the same way as it did to
the initial request until either the resource is ready, from which point it
responds with the resource's representation (<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-3.2" class="relref">Section 3.2</a></span>), or
handling the request fails, in which case it <span class="bcp14">MUST</span> abort with the error that
caused the failure.<a href="#section-3.1-3" class="pilcrow">¶</a></p>
<p id="section-3.1-4">The HTTP server may instead handle the request immediately. It waits to respond
to the HTTP client's request until the resource is ready, in which case it
responds with the resource's representation, or handling the request fails, in
which case it <span class="bcp14">MUST</span> abort with the error that caused the failure.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
<p id="section-3.1-5">Implementations are not required to support GET on resources if they are served
synchronously, but they could do so, as a way for other protocol participants to
retrieve the results of some transaction later on. The retention period for
job results is an implementation detail.<a href="#section-3.1-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="http-status-codes">
<section id="section-3.2">
        <h3 id="name-http-status-codes">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-http-status-codes" class="section-name selfRef">HTTP Status Codes</a>
        </h3>
<p id="section-3.2-1">HTTP servers participating in DAP <span class="bcp14">MAY</span> use any status code from the applicable
class when constructing HTTP responses, but HTTP clients <span class="bcp14">MAY</span> treat any status
code as the most general code of that class. For example, 202 may be handled as
200, or 499 as 400.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="presentation-language">
<section id="section-3.3">
        <h3 id="name-presentation-language">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-presentation-language" class="section-name selfRef">Presentation Language</a>
        </h3>
<p id="section-3.3-1">We use the presentation language defined in <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>], <a href="https://rfc-editor.org/rfc/rfc8446#section-3" class="relref">Section 3</a></span> to define
messages in the protocol. Encoding and decoding of these messages as byte
strings also follows <span>[<a href="#RFC8446" class="cite xref">RFC8446</a>]</span>.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="request-authentication">
<section id="section-3.4">
        <h3 id="name-request-authentication">
<a href="#section-3.4" class="section-number selfRef">3.4. </a><a href="#name-request-authentication" class="section-name selfRef">Request Authentication</a>
        </h3>
<p id="section-3.4-1">The protocol is made up of several interactions in which different subsets of
participants interact with each other.<a href="#section-3.4-1" class="pilcrow">¶</a></p>
<p id="section-3.4-2">In those cases where a channel between two participants is tunneled through
another protocol participant, Hybrid Public Key Encryption (<span>[<a href="#HPKE" class="cite xref">HPKE</a>]</span>)
ensures that only the intended recipient can see a message in the clear.<a href="#section-3.4-2" class="pilcrow">¶</a></p>
<p id="section-3.4-3">In other cases, HTTP client authentication is required as well as server
authentication. Any authentication scheme that is composable with HTTP is
allowed. For example:<a href="#section-3.4-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.4-4.1">
            <p id="section-3.4-4.1.1"><span>[<a href="#OAuth2" class="cite xref">OAuth2</a>]</span> credentials are presented in an Authorization HTTP header
(<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-11.6.2" class="relref">Section 11.6.2</a></span>), which can be added to any protocol message.<a href="#section-3.4-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.4-4.2">
            <p id="section-3.4-4.2.1">TLS client certificates can be used to authenticate the underlying transport.<a href="#section-3.4-4.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.4-4.3">
            <p id="section-3.4-4.3.1"><span>[<a href="#RFC9421" class="cite xref">RFC9421</a>]</span> HTTP message signatures authenticate messages without
transmitting a secret.<a href="#section-3.4-4.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-3.4-5">This flexibility allows organizations deploying DAP to use authentication
mechanisms that they already support. Discovering what authentication mechanisms
are supported by a participant is outside of this document's scope.<a href="#section-3.4-5" class="pilcrow">¶</a></p>
<p id="section-3.4-6">Request authentication is <span class="bcp14">REQUIRED</span> in the following interactions:<a href="#section-3.4-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.4-7.1">
            <p id="section-3.4-7.1.1">Leaders initializing or continuing aggregation jobs with Helpers
(<a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>).<a href="#section-3.4-7.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.4-7.2">
            <p id="section-3.4-7.2.1">Collectors initializing or polling collection jobs with Leaders
(<a href="#collect-init" class="auto internal xref">Section 4.6.1</a>).<a href="#section-3.4-7.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-3.4-7.3">
            <p id="section-3.4-7.3.1">Leaders obtaining aggregate shares from Helpers (<a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a>).<a href="#section-3.4-7.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="errors">
<section id="section-3.5">
        <h3 id="name-errors">
<a href="#section-3.5" class="section-number selfRef">3.5. </a><a href="#name-errors" class="section-name selfRef">Errors</a>
        </h3>
<p id="section-3.5-1">Errors are reported as HTTP status codes. Any of the standard client or server
errors (the 4xx or 5xx classes, respectively, from <span><a href="https://rfc-editor.org/rfc/rfc9110#section-15" class="relref">Section 15</a> of [<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>)
are permitted.<a href="#section-3.5-1" class="pilcrow">¶</a></p>
<p id="section-3.5-2">When the server responds with an error status code, it <span class="bcp14">SHOULD</span> provide additional
information using a problem detail object <span>[<a href="#RFC9457" class="cite xref">RFC9457</a>]</span> in the response body. If
the response body does consist of a problem detail object, the status code <span class="bcp14">MUST</span>
indicate a client or server error.<a href="#section-3.5-2" class="pilcrow">¶</a></p>
<p id="section-3.5-3">To facilitate automatic response to errors, this document defines the following
standard tokens for use in the "type" field:<a href="#section-3.5-3" class="pilcrow">¶</a></p>
<div id="urn-space-errors">
<table class="center" id="table-1">
          <caption><a href="#table-1" class="selfRef">Table 1</a></caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Type</th>
              <th class="text-left" rowspan="1" colspan="1">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">invalidMessage</td>
              <td class="text-left" rowspan="1" colspan="1">A message received by a protocol participant could not be parsed or otherwise was invalid.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">unrecognizedTask</td>
              <td class="text-left" rowspan="1" colspan="1">A server received a message with an unknown task ID.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">unrecognizedAggregationJob</td>
              <td class="text-left" rowspan="1" colspan="1">A server received a message with an unknown aggregation job ID.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">batchInvalid</td>
              <td class="text-left" rowspan="1" colspan="1">The batch boundary check for Collector's query failed.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">invalidBatchSize</td>
              <td class="text-left" rowspan="1" colspan="1">There are an invalid number of reports in the batch.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">invalidAggregationParameter</td>
              <td class="text-left" rowspan="1" colspan="1">The aggregation parameter assigned to a batch is invalid.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">batchMismatch</td>
              <td class="text-left" rowspan="1" colspan="1">Aggregators disagree on the report shares that were aggregated in a batch.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">stepMismatch</td>
              <td class="text-left" rowspan="1" colspan="1">The Aggregators disagree on the current step of the DAP aggregation protocol.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">batchOverlap</td>
              <td class="text-left" rowspan="1" colspan="1">A request's query includes reports that were previously collected in a different batch.</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">unsupportedExtension</td>
              <td class="text-left" rowspan="1" colspan="1">An upload request's extensions list includes an unknown extension.</td>
            </tr>
          </tbody>
        </table>
</div>
<p id="section-3.5-5">These types are scoped to the errors sub-namespace of the DAP URN namespace,
e.g., urn:ietf:params:ppm:dap:error:invalidMessage.<a href="#section-3.5-5" class="pilcrow">¶</a></p>
<p id="section-3.5-6">This list is not exhaustive. The server <span class="bcp14">MAY</span> return errors set to a URI other
than those defined above. Servers <span class="bcp14">MUST NOT</span> use the DAP URN namespace for errors
not listed in the appropriate IANA registry (see <a href="#urn-space" class="auto internal xref">Section 9.3</a>). The "detail"
member of the Problem Details document includes additional diagnostic
information.<a href="#section-3.5-6" class="pilcrow">¶</a></p>
<p id="section-3.5-7">When the task ID is known (see <a href="#task-configuration" class="auto internal xref">Section 4.2</a>), the problem document
<span class="bcp14">SHOULD</span> include an additional "taskid" member containing the ID encoded in Base
64 using the URL and filename safe alphabet with no padding defined in
Sections <a href="https://rfc-editor.org/rfc/rfc4648#section-5" class="relref">5</a> and <a href="https://rfc-editor.org/rfc/rfc4648#section-3.2" class="relref">3.2</a> of <span>[<a href="#RFC4648" class="cite xref">RFC4648</a>]</span>.<a href="#section-3.5-7" class="pilcrow">¶</a></p>
<p id="section-3.5-8">In the remainder of this document, the tokens in the table above are used to
refer to error types, rather than the full URNs. For example, an "error of type
'invalidMessage'" refers to an error document with "type" value
"urn:ietf:params:ppm:dap:error:invalidMessage".<a href="#section-3.5-8" class="pilcrow">¶</a></p>
<p id="section-3.5-9">This document uses the verbs "abort" and "alert with [some error message]" to
describe how protocol participants react to various error conditions. This
implies that the response's status code will indicate a client error unless
specified otherwise.<a href="#section-3.5-9" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="protocol">
<section id="section-4">
      <h2 id="name-protocol-definition">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-protocol-definition" class="section-name selfRef">Protocol Definition</a>
      </h2>
<p id="section-4-1">DAP has three major interactions which need to be defined:<a href="#section-4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4-2.1">
          <p id="section-4-2.1.1">Clients upload reports to the Aggregators, specified in <a href="#upload-flow" class="auto internal xref">Section 4.4</a><a href="#section-4-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-2.2">
          <p id="section-4-2.2.1">Aggregators jointly verify reports and aggregate them together, specified in
<a href="#aggregate-flow" class="auto internal xref">Section 4.5</a><a href="#section-4-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-4-2.3">
          <p id="section-4-2.3.1">The Collector collects aggregated results from the Aggregators, specified in
<a href="#collect-flow" class="auto internal xref">Section 4.6</a><a href="#section-4-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-4-3">Each of these interactions is defined in terms of HTTP resources. In this
section we define these resources and the messages used to act on them.<a href="#section-4-3" class="pilcrow">¶</a></p>
<div id="basic-definitions">
<section id="section-4.1">
        <h3 id="name-basic-type-definitions">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-basic-type-definitions" class="section-name selfRef">Basic Type Definitions</a>
        </h3>
<p id="section-4.1-1">A <code>ReportID</code> is used to uniquely identify a report in the context of a DAP task.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.1-2">
<pre>
opaque ReportID[16];
</pre><a href="#section-4.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1-3"><code>Role</code> enumerates the roles assumed by protocol participants.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.1-4">
<pre>
enum {
  collector(0),
  client(1),
  leader(2),
  helper(3),
  (255)
} Role;
</pre><a href="#section-4.1-4" class="pilcrow">¶</a>
</div>
<p id="section-4.1-5"><code>HpkeCiphertext</code> is a message encrypted using <span>[<a href="#HPKE" class="cite xref">HPKE</a>]</span> and metadata
needed to decrypt it. <code>HpkeConfigId</code> identifies a server's HPKE configuration
(see <a href="#hpke-config" class="auto internal xref">Section 4.4.1</a>).<a href="#section-4.1-5" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.1-6">
<pre>
uint8 HpkeConfigId;

struct {
  HpkeConfigId config_id;
  opaque enc&lt;1..2^16-1&gt;;
  opaque payload&lt;1..2^32-1&gt;;
} HpkeCiphertext;
</pre><a href="#section-4.1-6" class="pilcrow">¶</a>
</div>
<p id="section-4.1-7"><code>config_id</code> identifies the HPKE configuration to which the message was
encrypted. <code>enc</code> and <code>payload</code> correspond to the values returned by the
<span>[<a href="#HPKE" class="cite xref">HPKE</a>]</span> <code>SealBase()</code> function. Later sections describe how to use <code>SealBase()</code>
in different situations.<a href="#section-4.1-7" class="pilcrow">¶</a></p>
<p id="section-4.1-8"><code>Empty</code> is a zero-length byte string.<a href="#section-4.1-8" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.1-9">
<pre>
struct {} Empty;
</pre><a href="#section-4.1-9" class="pilcrow">¶</a>
</div>
<p id="section-4.1-10">Errors that occurred while handling individual reports in the upload or
aggregation interactions are represented by the following enum:<a href="#section-4.1-10" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.1-11">
<pre>
enum {
  reserved(0),
  batch_collected(1),
  report_replayed(2),
  report_dropped(3),
  hpke_unknown_config_id(4),
  hpke_decrypt_error(5),
  vdaf_verify_error(6),
  task_expired(7),
  invalid_message(8),
  report_too_early(9),
  task_not_started(10),
  outdated_config(11),
  (255)
} ReportError;
</pre><a href="#section-4.1-11" class="pilcrow">¶</a>
</div>
<div id="timestamps">
<section id="section-4.1.1">
          <h4 id="name-times-durations-and-interva">
<a href="#section-4.1.1" class="section-number selfRef">4.1.1. </a><a href="#name-times-durations-and-interva" class="section-name selfRef">Times, Durations and Intervals</a>
          </h4>
<div class="lang-tls-presentation sourcecode" id="section-4.1.1-1">
<pre>
uint64 TimePrecision;

uint64 Time;
</pre><a href="#section-4.1.1-1" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1-2">A <code>TimePrecision</code> is an integer number of seconds, used to compute times and
durations in DAP. The time precision is a parameter of a task
(<a href="#task-configuration" class="auto internal xref">Section 4.2</a>).<a href="#section-4.1.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1.1-3">Times are integers, representing a number of <code>TimePrecision</code>s since the Epoch,
defined in section 4.16 of <span>[<a href="#POSIX" class="cite xref">POSIX</a>]</span>. That is, the number of seconds after
1970-01-01 00:00:00 UTC, excluding leap seconds, divided by the task's
<code>time_precision</code>.<a href="#section-4.1.1-3" class="pilcrow">¶</a></p>
<p id="section-4.1.1-4">One POSIX timestamp is said to be before (respectively, after) another POSIX
timestamp if it is less than (respectively, greater than) the other value.<a href="#section-4.1.1-4" class="pilcrow">¶</a></p>
<p id="section-4.1.1-5">Times can only be meaningfully compared to one another if they use the same time
precision.<a href="#section-4.1.1-5" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.1.1-6">
<pre>
uint64 Duration;
</pre><a href="#section-4.1.1-6" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1-7">Durations of time are integers, representing a number of <code>TimePrecision</code>s. That
is, a number of seconds divided by the task's <code>time_precision</code>. A duration can
be added to a time to produce another time.<a href="#section-4.1.1-7" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.1.1-8">
<pre>
struct {
  Time start;
  Duration duration;
} Interval;
</pre><a href="#section-4.1.1-8" class="pilcrow">¶</a>
</div>
<p id="section-4.1.1-9">Intervals of time consist of a start time and a duration. Intervals are
half-open; that is, <code>start</code> is included and <code>(start + duration)</code> is excluded. A
time that is before the <code>start</code> of an <code>Interval</code> is said to be before that
interval. A time that is equal to or after <code>Interval.start + Interval.duration</code>
is said to be after the interval. A time that is either before or after an
interval is said to be outside the interval. A time that is neither before nor
after an interval is said to be inside or fall within the interval.<a href="#section-4.1.1-9" class="pilcrow">¶</a></p>
<p id="section-4.1.1-10">Intervals can only be meaningfully compared to one another if they use the same
time precision.<a href="#section-4.1.1-10" class="pilcrow">¶</a></p>
<div id="examples">
<section id="section-4.1.1.1">
            <h5 id="name-examples">
<a href="#section-4.1.1.1" class="section-number selfRef">4.1.1.1. </a><a href="#name-examples" class="section-name selfRef">Examples</a>
            </h5>
<p id="section-4.1.1.1-1">Suppose a task's <code>time_precision</code> is 10 seconds. A <code>Time</code> whose value is
123456789 represents the POSIX timestamp <code>1234567890</code>, or 2009-02-13 23:31:30
UTC. A <code>Duration</code> whose value is <code>11</code> represents a duration of 110 seconds.<a href="#section-4.1.1.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1.1.1-2">An <code>Interval</code> whose <code>start</code> is 123456789 and whose <code>duration</code> is 11 represents
the interval from time from POSIX timestamp <code>1234567890</code> to <code>1234568000</code>, or
2009-02-13 23:31:30 UTC to 2009-02-13 23:33:20 UTC.<a href="#section-4.1.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="vdaf-types">
<section id="section-4.1.2">
          <h4 id="name-vdaf-types">
<a href="#section-4.1.2" class="section-number selfRef">4.1.2. </a><a href="#name-vdaf-types" class="section-name selfRef">VDAF Types</a>
          </h4>
<p id="section-4.1.2-1">The 16-byte <code>ReportID</code> is used as the nonce parameter for the VDAF <code>shard</code> and
<code>verify_init</code> methods (see <span>[<a href="#VDAF" class="cite xref">VDAF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5" class="relref">Section 5</a></span>). Additionally, DAP includes
messages defined in the VDAF specification encoded as opaque byte strings within
various DAP messages. Thus, for a VDAF to be compatible with DAP, it <span class="bcp14">MUST</span>
specify a <code>NONCE_SIZE</code> of 16 bytes, and <span class="bcp14">MUST</span> specify encodings for the following
VDAF types:<a href="#section-4.1.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1.2-2.1">
              <p id="section-4.1.2-2.1.1">PublicShare<a href="#section-4.1.2-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.1.2-2.2">
              <p id="section-4.1.2-2.2.1">InputShare<a href="#section-4.1.2-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.1.2-2.3">
              <p id="section-4.1.2-2.3.1">AggParam<a href="#section-4.1.2-2.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.1.2-2.4">
              <p id="section-4.1.2-2.4.1">AggShare<a href="#section-4.1.2-2.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.1.2-2.5">
              <p id="section-4.1.2-2.5.1">VerifierShare<a href="#section-4.1.2-2.5.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.1.2-2.6">
              <p id="section-4.1.2-2.6.1">VerifierMessage<a href="#section-4.1.2-2.6.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
</section>
</div>
<div id="task-configuration">
<section id="section-4.2">
        <h3 id="name-task-configuration">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-task-configuration" class="section-name selfRef">Task Configuration</a>
        </h3>
<p id="section-4.2-1">A task represents a single measurement process, though potentially aggregating
multiple, non-overlapping batches of measurements. Each participant in a task
must agree on its configuration prior to its execution. This document does not
specify a mechanism for distributing task parameters among participants.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2-2">A task is uniquely identified by its task ID:<a href="#section-4.2-2" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.2-3">
<pre>
opaque TaskID[32];
</pre><a href="#section-4.2-3" class="pilcrow">¶</a>
</div>
<p id="section-4.2-4">The task ID <span class="bcp14">MUST</span> be a globally unique sequence of bytes. Each task has the
following parameters associated with it:<a href="#section-4.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-5.1">
            <p id="section-4.2-5.1.1">The VDAF which determines the type of measurements and the aggregation
function. The VDAF itself may have further parameters (e.g., number of buckets
in a <code>Prio3Histogram</code>).<a href="#section-4.2-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-5.2">
            <p id="section-4.2-5.2.1">A URL relative to which the Leader's API resources can be found.<a href="#section-4.2-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-5.3">
            <p id="section-4.2-5.3.1">A URL relative to which the Helper's API resources can be found.<a href="#section-4.2-5.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-5.4">
            <p id="section-4.2-5.4.1">The batch mode for this task (see <a href="#batch-modes-overview" class="auto internal xref">Section 4.2.1</a>), which determines
how reports are grouped into batches.<a href="#section-4.2-5.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-5.5">
            <p id="section-4.2-5.5.1"><code>task_interval</code> (<code>Interval</code>): Reports whose timestamp is outside of this
interval will be rejected by the Aggregators.<a href="#section-4.2-5.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-5.6">
            <p id="section-4.2-5.6.1"><code>time_precision</code> (<code>TimePrecision</code>): The time precision used in this task. See
<a href="#timestamps" class="auto internal xref">Section 4.1.1</a>.<a href="#section-4.2-5.6.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-4.2-6">The Leader and Helper API URLs <span class="bcp14">MAY</span> include arbitrary path components.<a href="#section-4.2-6" class="pilcrow">¶</a></p>
<p id="section-4.2-7">In order to facilitate the aggregation and collection interactions, each of the
Aggregators is configured with the following parameters:<a href="#section-4.2-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-8.1">
            <p id="section-4.2-8.1.1"><code>min_batch_size</code> (<code>uint64</code>): The smallest number of reports the batch is
allowed to include. A larger minimum batch size will yield a higher degree of
privacy. However, this ultimately depends on the application and the nature of
the measurements and aggregation function.<a href="#section-4.2-8.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-8.2">
            <p id="section-4.2-8.2.1"><code>collector_hpke_config</code> (<code>HpkeConfig</code>): The <span>[<a href="#HPKE" class="cite xref">HPKE</a>]</span> configuration of
the Collector (described in <a href="#hpke-config" class="auto internal xref">Section 4.4.1</a>); see <a href="#compliance" class="auto internal xref">Section 7</a> for
information about the HPKE configuration algorithms.<a href="#section-4.2-8.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-8.3">
            <p id="section-4.2-8.3.1"><code>vdaf_verify_key</code> (opaque byte string): The VDAF verification key (or keys)
shared by the Aggregators. This key is used in the aggregation interaction
(<a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>). The security requirements are described in
<a href="#verification-key" class="auto internal xref">Section 8.6.2</a>.<a href="#section-4.2-8.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-4.2-9">Finally, the Collector is configured with the HPKE secret key corresponding to
<code>collector_hpke_config</code>.<a href="#section-4.2-9" class="pilcrow">¶</a></p>
<p id="section-4.2-10">A task's parameters are immutable for the lifetime of that task. The only way to
change parameters or to rotate secret values like collector HPKE configuration
or the VDAF verification key is to configure a new task.<a href="#section-4.2-10" class="pilcrow">¶</a></p>
<div id="batch-modes-overview">
<section id="section-4.2.1">
          <h4 id="name-batch-modes-batches-and-que">
<a href="#section-4.2.1" class="section-number selfRef">4.2.1. </a><a href="#name-batch-modes-batches-and-que" class="section-name selfRef">Batch Modes, Batches, and Queries</a>
          </h4>
<p id="section-4.2.1-1">An aggregate result is computed from a set of reports, called a "batch". The
Collector requests the aggregate result by making a "query" and the Aggregators
use this query to select a batch for aggregation.<a href="#section-4.2.1-1" class="pilcrow">¶</a></p>
<p id="section-4.2.1-2">The task's batch mode defines both how reports are assigned into batches, how
these batches are addressed and the semantics of the query used for collection.
Regardless of batch mode, each report can only ever be part of a single batch.<a href="#section-4.2.1-2" class="pilcrow">¶</a></p>
<p id="section-4.2.1-3"><a href="#batch-modes" class="auto internal xref">Section 5</a> defines the <code>time-interval</code> and <code>leader-selected</code> batch modes
and discusses how new batch modes may be defined by future documents.<a href="#section-4.2.1-3" class="pilcrow">¶</a></p>
<p id="section-4.2.1-4">The query is issued to the Leader by the Collector during the collection
interaction (<a href="#collect-flow" class="auto internal xref">Section 4.6</a>). Information used to guide batch selection is
conveyed from the Leader to the Helper when initializing aggregation jobs
(<a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>) and finalizing the aggregate shares.<a href="#section-4.2.1-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="agg-param-validation">
<section id="section-4.3">
        <h3 id="name-aggregation-parameter-valid">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-aggregation-parameter-valid" class="section-name selfRef">Aggregation Parameter Validation</a>
        </h3>
<p id="section-4.3-1">For each batch it collects, the Collector chooses an aggregation parameter used
to verify the measurements before aggregating them. Before accepting a
collection job from the Collector (<a href="#collect-init" class="auto internal xref">Section 4.6.1</a>), the Leader checks that the
indicated aggregation parameter is valid according to the following procedure.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.3-2">
<li id="section-4.3-2.1">
            <p id="section-4.3-2.1.1">Decode the byte string <code>agg_param</code> into an <code>AggParam</code> as specified by the
VDAF. If decoding fails, then the aggregation parameter is invalid.<a href="#section-4.3-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.3-2.2">
            <p id="section-4.3-2.2.1">Run <code>vdaf.is_valid(decoded_agg_param, [])</code>, where <code>decoded_agg_param</code> is the
decoded <code>AggParam</code> and <code>is_valid()</code> is as defined in <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.3" class="relref">Section 5.3</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>. If the output is not <code>True</code>, then the aggregation parameter is
invalid.<a href="#section-4.3-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-4.3-3">If both steps succeed, then the aggregation parameter is valid.<a href="#section-4.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="upload-flow">
<section id="section-4.4">
        <h3 id="name-uploading-reports">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-uploading-reports" class="section-name selfRef">Uploading Reports</a>
        </h3>
<p id="section-4.4-1">Clients periodically upload reports to the Leader. Each report contains two
"report shares", one for the Leader and another for the Helper. The Helper's
report share is transmitted by the Leader during the aggregation interaction
(see <a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>).<a href="#section-4.4-1" class="pilcrow">¶</a></p>
<div id="hpke-config">
<section id="section-4.4.1">
          <h4 id="name-hpke-configuration-request">
<a href="#section-4.4.1" class="section-number selfRef">4.4.1. </a><a href="#name-hpke-configuration-request" class="section-name selfRef">HPKE Configuration Request</a>
          </h4>
<p id="section-4.4.1-1">Before the Client can upload its report to the Leader, it must know the HPKE
configuration of each Aggregator. See <a href="#compliance" class="auto internal xref">Section 7</a> for information on HPKE
algorithm choices.<a href="#section-4.4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.4.1-2">Clients retrieve the HPKE configuration from each Aggregator by sending a GET to
<code>{aggregator}/hpke_config</code>.<a href="#section-4.4.1-2" class="pilcrow">¶</a></p>
<p id="section-4.4.1-3">An Aggregator responds with an <code>HpkeConfigList</code>, with media type
"application/ppm-dap;message=hpke-config-list". The <code>HpkeConfigList</code> contains
one or more <code>HpkeConfig</code>s in decreasing order of preference. This allows an
Aggregator to support multiple HPKE configurations and multiple sets of
algorithms simultaneously.<a href="#section-4.4.1-3" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.4.1-4">
<pre>
HpkeConfig HpkeConfigList&lt;10..2^16-1&gt;;

struct {
  HpkeConfigId id;
  HpkeKemId kem_id;
  HpkeKdfId kdf_id;
  HpkeAeadId aead_id;
  HpkePublicKey public_key;
} HpkeConfig;

opaque HpkePublicKey&lt;1..2^16-1&gt;;
uint16 HpkeAeadId;
uint16 HpkeKemId;
uint16 HpkeKdfId;
</pre><a href="#section-4.4.1-4" class="pilcrow">¶</a>
</div>
<p id="section-4.4.1-5">The possible values for <code>HpkeAeadId</code>, <code>HpkeKemId</code> and <code>HpkeKdfId</code> are as defined
in <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-7" class="relref">Section 7</a></span>.<a href="#section-4.4.1-5" class="pilcrow">¶</a></p>
<p id="section-4.4.1-6">Aggregators <span class="bcp14">MUST</span> allocate distinct <code>id</code> values for each <code>HpkeConfig</code> in an
<code>HpkeConfigList</code>.<a href="#section-4.4.1-6" class="pilcrow">¶</a></p>
<p id="section-4.4.1-7">The Client <span class="bcp14">MUST</span> abort if:<a href="#section-4.4.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.4.1-8.1">
              <p id="section-4.4.1-8.1.1">the response is not a valid <code>HpkeConfigList</code>;<a href="#section-4.4.1-8.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.4.1-8.2">
              <p id="section-4.4.1-8.2.1">the <code>HpkeConfigList</code> is empty; or<a href="#section-4.4.1-8.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.4.1-8.3">
              <p id="section-4.4.1-8.3.1">no HPKE config advertised by the Aggregator specifies a supported KEM, KDF and
AEAD algorithm triple.<a href="#section-4.4.1-8.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.4.1-9">Aggregators <span class="bcp14">SHOULD</span> use caching to permit client-side caching of this resource
<span>[<a href="#RFC9111" class="cite xref">RFC9111</a>]</span>. Aggregators can control cache lifetime with the Cache-Control
header, using a value appropriate to the lifetime of their keys. Aggregators
<span class="bcp14">SHOULD</span> favor long cache lifetimes to avoid frequent cache revalidation, e.g., on
the order of days.<a href="#section-4.4.1-9" class="pilcrow">¶</a></p>
<p id="section-4.4.1-10">Aggregators <span class="bcp14">SHOULD</span> continue to accept reports with old keys for at least twice
the cache lifetime in order to avoid rejecting reports.<a href="#section-4.4.1-10" class="pilcrow">¶</a></p>
<div id="example">
<section id="section-4.4.1.1">
            <h5 id="name-example">
<a href="#section-4.4.1.1" class="section-number selfRef">4.4.1.1. </a><a href="#name-example" class="section-name selfRef">Example</a>
            </h5>
<div class="lang-http sourcecode" id="section-4.4.1.1-1">
<pre>
GET /leader/hpke_config
Host: example.com

HTTP/1.1 200
Content-Type: application/ppm-dap;message=hpke-config-list
Cache-Control: max-age=86400

encoded([
  struct {
    id = 194,
    kem_id = 0x0010,
    kdf_id = 0x0001,
    aead_id = 0x0001,
    public_key = [0x01, 0x02, 0x03, 0x04, ...],
  } HpkeConfig,
  struct {
    id = 17,
    kem_id = 0x0020,
    kdf_id = 0x0001,
    aead_id = 0x0003,
    public_key = [0x04, 0x03, 0x02, 0x01, ...],
  } HpkeConfig,
])
</pre><a href="#section-4.4.1.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="upload-request">
<section id="section-4.4.2">
          <h4 id="name-upload-request">
<a href="#section-4.4.2" class="section-number selfRef">4.4.2. </a><a href="#name-upload-request" class="section-name selfRef">Upload Request</a>
          </h4>
<p id="section-4.4.2-1">Reports are uploaded using the reports resource, served by the Leader at
<code>{leader}/tasks/{task-id}/reports</code>. An upload is represented as an
<code>UploadRequest</code>, with media type "application/ppm-dap;message=upload-req",
structured as follows:<a href="#section-4.4.2-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.4.2-2">
<pre>
struct {
  ReportID report_id;
  Time time;
  Extension public_extensions&lt;0..2^16-1&gt;;
} ReportMetadata;

struct {
  ReportMetadata report_metadata;
  opaque public_share&lt;0..2^32-1&gt;;
  HpkeCiphertext leader_encrypted_input_share;
  HpkeCiphertext helper_encrypted_input_share;
} Report;

struct {
  Report reports[message_length];
} UploadRequest;
</pre><a href="#section-4.4.2-2" class="pilcrow">¶</a>
</div>
<p id="section-4.4.2-3">Here <code>message_length</code> is the length of the HTTP message content (<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-6.4" class="relref">Section 6.4</a></span>).<a href="#section-4.4.2-3" class="pilcrow">¶</a></p>
<p id="section-4.4.2-4">Each upload request contains a sequence of <code>Report</code> with the following fields:<a href="#section-4.4.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.4.2-5.1">
              <p id="section-4.4.2-5.1.1"><code>report_metadata</code> is public metadata describing the report.<a href="#section-4.4.2-5.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.4.2-5.1.2.1">
                  <p id="section-4.4.2-5.1.2.1.1"><code>report_id</code> uniquely identifies the report. The Client <span class="bcp14">MUST</span> generate this
 by sampling 16 random bytes from a cryptographically secure random number
 generator.<a href="#section-4.4.2-5.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-4.4.2-5.1.2.2">
                  <p id="section-4.4.2-5.1.2.2.1"><code>time</code> is the time at which the report was generated.<a href="#section-4.4.2-5.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-4.4.2-5.1.2.3">
                  <p id="section-4.4.2-5.1.2.3.1"><code>public_extensions</code> is the list of public report extensions; see
<a href="#report-extensions" class="auto internal xref">Section 4.4.3</a>.<a href="#section-4.4.2-5.1.2.3.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
            <li class="normal" id="section-4.4.2-5.2">
              <p id="section-4.4.2-5.2.1"><code>public_share</code> is the public share output by the VDAF sharding algorithm. The
public share might be empty, depending on the VDAF.<a href="#section-4.4.2-5.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.4.2-5.3">
              <p id="section-4.4.2-5.3.1"><code>leader_encrypted_input_share</code> is the Leader's encrypted input share.<a href="#section-4.4.2-5.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.4.2-5.4">
              <p id="section-4.4.2-5.4.1"><code>helper_encrypted_input_share</code> is the Helper's encrypted input share.<a href="#section-4.4.2-5.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.4.2-6">Aggregators <span class="bcp14">MAY</span> require Clients to authenticate when uploading reports (see
<a href="#client-auth" class="auto internal xref">Section 8.3</a>). If it is used, client authentication <span class="bcp14">MUST</span> use a scheme that
meets the requirements in <a href="#request-authentication" class="auto internal xref">Section 3.4</a>.<a href="#section-4.4.2-6" class="pilcrow">¶</a></p>
<div id="client-behavior">
<section id="section-4.4.2.1">
            <h5 id="name-client-behavior">
<a href="#section-4.4.2.1" class="section-number selfRef">4.4.2.1. </a><a href="#name-client-behavior" class="section-name selfRef">Client Behavior</a>
            </h5>
<p id="section-4.4.2.1-1">To generate a report, the Client begins by sharding its measurement into input
shares and the public share using the VDAF's sharding algorithm (<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.1" class="relref">Section 5.1</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>), using the report ID as the nonce:<a href="#section-4.4.2.1-1" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.4.2.1-2">
<pre>
(public_share, input_shares) = Vdaf.shard(
    "dap-17" || task_id,
    measurement,
    report_id,
    rand,
)
</pre><a href="#section-4.4.2.1-2" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.4.2.1-3.1">
                <p id="section-4.4.2.1-3.1.1"><code>task_id</code> is the task ID.<a href="#section-4.4.2.1-3.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-3.2">
                <p id="section-4.4.2.1-3.2.1"><code>measurement</code> is the plaintext measurement, represented as the VDAF's
<code>Measurement</code> associated type.<a href="#section-4.4.2.1-3.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-3.3">
                <p id="section-4.4.2.1-3.3.1"><code>report_id</code> is the corresponding value from <code>ReportMetadata</code>, used as the
nonce.<a href="#section-4.4.2.1-3.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-3.4">
                <p id="section-4.4.2.1-3.4.1"><code>rand</code> is a random byte string of length specified by the VDAF. Each report's
<code>rand</code> <span class="bcp14">MUST</span> be independently sampled from a cryptographically secure random
number generator.<a href="#section-4.4.2.1-3.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.4.2.1-4"><code>Vdaf.shard</code> algorithm will return two input shares. The first is the Leader's
input share, and the second is the Helper's.<a href="#section-4.4.2.1-4" class="pilcrow">¶</a></p>
<p id="section-4.4.2.1-5">The Client then wraps each input share in the following structure:<a href="#section-4.4.2.1-5" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.4.2.1-6">
<pre>
struct {
  Extension private_extensions&lt;0..2^16-1&gt;;
  opaque payload&lt;1..2^32-1&gt;;
} PlaintextInputShare;
</pre><a href="#section-4.4.2.1-6" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.4.2.1-7.1">
                <p id="section-4.4.2.1-7.1.1"><code>private_extensions</code> is the list of private report extensions for the given
 Aggregator (see <a href="#report-extensions" class="auto internal xref">Section 4.4.3</a>).<a href="#section-4.4.2.1-7.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-7.2">
                <p id="section-4.4.2.1-7.2.1"><code>payload</code> is the Aggregator's input share.<a href="#section-4.4.2.1-7.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.4.2.1-8">Next, the Client encrypts each <code>PlaintextInputShare</code> as follows:<a href="#section-4.4.2.1-8" class="pilcrow">¶</a></p>
<p id="section-4.4.2.1-9">(RFC EDITOR: Once the document becomes an RFC, we will stop including the draft
version in domain separation tags. In the remainder of this section, replace
"dap-17" with "dap".)<a href="#section-4.4.2.1-9" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.4.2.1-10">
<pre>
enc, payload = SealBase(pk,
  "dap-17 input share" || 0x01 || server_role,
  input_share_aad, plaintext_input_share)
</pre><a href="#section-4.4.2.1-10" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.4.2.1-11.1">
                <p id="section-4.4.2.1-11.1.1"><code>pk</code> is the public key from the Aggregator's HPKE configuration.<a href="#section-4.4.2.1-11.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-11.2">
                <p id="section-4.4.2.1-11.2.1"><code>0x01</code> represents the <code>Role</code> of the sender (always the Client).<a href="#section-4.4.2.1-11.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-11.3">
                <p id="section-4.4.2.1-11.3.1"><code>server_role</code> is the <code>Role</code> of the recipient (<code>0x02</code> for the Leader and <code>0x03</code>
 for the Helper).<a href="#section-4.4.2.1-11.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-11.4">
                <p id="section-4.4.2.1-11.4.1"><code>plaintext_input_share</code> is the Aggregator's <code>PlaintextInputShare</code>.<a href="#section-4.4.2.1-11.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.4.2.1-11.5">
                <p id="section-4.4.2.1-11.5.1"><code>input_share_aad</code> is an encoded <code>InputShareAad</code>, constructed from the
corresponding fields in the report per the definition below.<a href="#section-4.4.2.1-11.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.4.2.1-12">The <code>SealBase()</code> function is as specified in <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-6.1" class="relref">Section 6.1</a></span> for the
ciphersuite indicated by the Aggregator's HPKE configuration.<a href="#section-4.4.2.1-12" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.4.2.1-13">
<pre>
struct {
  TaskID task_id;
  ReportMetadata report_metadata;
  opaque public_share&lt;0..2^32-1&gt;;
} InputShareAad;
</pre><a href="#section-4.4.2.1-13" class="pilcrow">¶</a>
</div>
<p id="section-4.4.2.1-14">Clients upload reports by sending an <code>UploadRequest</code> as the body of a POST to
the Leader's reports resource.<a href="#section-4.4.2.1-14" class="pilcrow">¶</a></p>
</section>
</div>
<div id="leader-behavior">
<section id="section-4.4.2.2">
            <h5 id="name-leader-behavior">
<a href="#section-4.4.2.2" class="section-number selfRef">4.4.2.2. </a><a href="#name-leader-behavior" class="section-name selfRef">Leader Behavior</a>
            </h5>
<p id="section-4.4.2.2-1">The handling of the upload request by the Leader <span class="bcp14">MUST</span> be idempotent as discussed
in <span><a href="https://rfc-editor.org/rfc/rfc9110#section-9.2.2" class="relref">Section 9.2.2</a> of [<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>.<a href="#section-4.4.2.2-1" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-2">If the upload request is malformed, the Leader aborts with error
<code>invalidMessage</code>.<a href="#section-4.4.2.2-2" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-3">If the Leader does not recognize the task ID, then it aborts with error
<code>unrecognizedTask</code>.<a href="#section-4.4.2.2-3" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-4">If all the reports in the request are accepted, then the Leader sends a response
with an empty body.<a href="#section-4.4.2.2-4" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-5">If some or all of the reports fail to upload for one of the reasons described in
the remainder of this section, the Leader responds with a body consisting of an
<code>UploadErrors</code> with the media type <code>application/ppm-dap;message=upload-errors</code>.
The structure of the response is as follows:<a href="#section-4.4.2.2-5" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.4.2.2-6">
<pre>
struct {
  ReportID id;
  ReportError error;
} ReportUploadStatus;

struct {
  ReportUploadStatus status[message_length];
} UploadErrors;
</pre><a href="#section-4.4.2.2-6" class="pilcrow">¶</a>
</div>
<p id="section-4.4.2.2-7">Here <code>message_length</code> denotes the length in bytes of the concatenated
<code>ReportUploadStatus</code> objects.<a href="#section-4.4.2.2-7" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-8">The Leader only includes reports that failed processing in the response. Reports
that are accepted do not have a response.<a href="#section-4.4.2.2-8" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-9">Reports in the response <span class="bcp14">MUST</span> appear in the same order as in the request.<a href="#section-4.4.2.2-9" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-10">For each report that failed to upload, the Leader creates a <code>ReportUploadStatus</code>
and includes the <code>ReportId</code> from the input and a <code>ReportError</code>
(<a href="#basic-definitions" class="auto internal xref">Section 4.1</a>) that describes the failure. The length of this sequence
is always less than or equal to the length of the upload sequence.<a href="#section-4.4.2.2-10" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-11">If the Leader does not recognize the <code>config_id</code> in the encrypted input share,
it sets the corresponding error field to <code>outdated_config</code>. When the Client
receives an <code>outdated_config</code> error, it <span class="bcp14">SHOULD</span> invalidate any cached
<code>HpkeConfigList</code> and retry with a freshly generated <code>Report</code>. If this retried
upload does not succeed, the Client <span class="bcp14">SHOULD</span> abort and discontinue retrying.<a href="#section-4.4.2.2-11" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-12">If a report's ID matches that of a previously uploaded report, the Leader <span class="bcp14">MUST</span>
discard it. In addition, it <span class="bcp14">MAY</span> set the corresponding error field to
<code>report_replayed</code>.<a href="#section-4.4.2.2-12" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-13">The Leader <span class="bcp14">MUST</span> discard any report pertaining to a batch that has already been
collected (see <a href="#replay-protection" class="auto internal xref">Section 2.3</a> for details). The Leader <span class="bcp14">MAY</span> also set the
corresponding error field to <code>report_replayed</code>.<a href="#section-4.4.2.2-13" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-14">The Leader <span class="bcp14">MUST</span> discard any report whose timestamp is outside of the task's
<code>time_interval</code>. When it does so, it <span class="bcp14">SHOULD</span> set the corresponding error field to
<code>report_dropped</code>.<a href="#section-4.4.2.2-14" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-15">The Leader may need to buffer reports while waiting to aggregate them (e.g.,
while waiting for an aggregation parameter from the Collector; see
<a href="#collect-flow" class="auto internal xref">Section 4.6</a>). The Leader <span class="bcp14">SHOULD NOT</span> accept reports whose timestamps are too
far in the future. Implementors <span class="bcp14">MAY</span> provide for some small leeway, usually no
more than a few minutes, to account for clock skew. If the Leader rejects a
report for this reason, it <span class="bcp14">SHOULD</span> set the corresponding error field to
<code>report_too_early</code>. In this situation, the Client <span class="bcp14">MAY</span> re-upload the report later
on.<a href="#section-4.4.2.2-15" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-16">If the report contains an unrecognized public report extension, or if the
Leader's input share contains an unrecognized private report extension, then the
Leader <span class="bcp14">MUST</span> discard the report and <span class="bcp14">MAY</span> abort with error <code>unsupportedExtension</code>.
If the Leader does abort for this reason, it <span class="bcp14">SHOULD</span> indicate the unsupported
extensions in the resulting problem document via an extension member (<span><a href="https://rfc-editor.org/rfc/rfc9457#section-3.2" class="relref">Section 3.2</a> of [<a href="#RFC9457" class="cite xref">RFC9457</a>]</span>) <code>unsupported_extensions</code> on the problem document. This member
<span class="bcp14">MUST</span> contain an array of numbers indicating the extension code points which were
not recognized. For example, if the report upload contained two unsupported
extensions with code points <code>23</code> and <code>42</code>, the "unsupported_extensions" member
would contain the JSON value <code>[23, 42]</code>.<a href="#section-4.4.2.2-16" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-17">If the same extension type appears more than once among the public extensions
and the private extensions in the Leader's input share, then the Leader <span class="bcp14">MUST</span>
discard the report and <span class="bcp14">MAY</span> abort with error <code>invalidMessage</code>.<a href="#section-4.4.2.2-17" class="pilcrow">¶</a></p>
<p id="section-4.4.2.2-18">Validation of anti-replay and extensions is not mandatory during the handling of
upload requests to avoid blocking on storage transactions or decryption of input
shares. The Leader also cannot validate the Helper's extensions because it
cannot decrypt the Helper's input share. Validation of report IDs and extensions
will occur before aggregation.<a href="#section-4.4.2.2-18" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-1">
<section id="section-4.4.2.3">
            <h5 id="name-example-2">
<a href="#section-4.4.2.3" class="section-number selfRef">4.4.2.3. </a><a href="#name-example-2" class="section-name selfRef">Example</a>
            </h5>
<p id="section-4.4.2.3-1">Successful upload<a href="#section-4.4.2.3-1" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.4.2.3-2">
<pre>
POST /leader/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/reports
Host: example.com
Content-Type: application/ppm-dap;message=upload-req
Content-Length: 100

encoded(struct {
  reports = [
    struct {
      report_metadata = struct {
        report_id = [0x0a, 0x0b, 0x0c, 0x0d, ...],
        time = 17419860,
        public_extensions = [0x00, 0x00],
      } ReportMetadata,
      public_share = [0x0a, 0x0b, ...],
      leader_encrypted_input-share = struct {
        config_id = 1,
        enc = [0x0f, 0x0e, 0x0d, 0x0c, ...],
        payload = [0x0b, 0x0a, 0x09, 0x08, ...],
      } HpkeCiphertext,
      helper_encrypted_input-share = struct {
        config_id = 2,
        enc = [0x0c, 0x0d, 0x0e, 0x0f, ...],
        payload = [0x08, 0x00, 0x0a, 0x0b, ...],
      } HpkeCiphertext,
    } Report,
  ],
} UploadRequest)

HTTP/1.1 200
</pre><a href="#section-4.4.2.3-2" class="pilcrow">¶</a>
</div>
<p id="section-4.4.2.3-3">Failed upload of 1/2 reports submitted in one bulk upload<a href="#section-4.4.2.3-3" class="pilcrow">¶</a></p>
<div class="breakable lang-http sourcecode" id="section-4.4.2.3-4">
<pre>
POST /leader/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/reports
Host: example.com
Content-Type: application/ppm-dap;message=upload-req
Content-Length: 200

encoded(struct {
  reports = [
    struct {
      report_metadata = struct {
        report_id = [0x0a, 0x0b, 0x0c, 0x0d, ...],
        time = 20000000,
        public_extensions = [0x00, 0x01],
      } ReportMetadata,
      public_share = [0x0a, 0x0b, ...],
      leader_encrypted_input-share = struct {
        config_id = 1,
        enc = [0x0f, 0x0e, 0x0d, 0x0c, ...],
        payload = [0x0b, 0x0a, 0x09, 0x08, ...],
      } HpkeCiphertext,
      helper_encrypted_input-share = struct {
        config_id = 2,
        enc = [0x0c, 0x0d, 0x0e, 0x0f, ...],
        payload = [0x08, 0x00, 0x0a, 0x0b, ...],
      } HpkeCiphertext,
    } Report,
    struct {
      report_metadata = struct {
        report_id = [0x0z, 0x0y, 0x0x, 0x0w, ...],
        time = 20000000,
        public_extensions = [0x00, 0x01],
      } ReportMetadata,
      public_share = [0x0a, 0x0b, ...],
      leader_encrypted_input-share = struct {
        config_id = 1,
        enc = [0x0f, 0x0e, 0x0d, 0x0c, ...],
        payload = [0x0b, 0x0a, 0x09, 0x08, ...],
      } HpkeCiphertext,
      helper_encrypted_input-share = struct {
        config_id = 2,
        enc = [0x0c, 0x0d, 0x0e, 0x0f, ...],
        payload = [0x08, 0x00, 0x0a, 0x0b, ...],
      } HpkeCiphertext,
    } Report,
  ],
} UploadRequest)

HTTP/1.1 200
Content-Type: application/ppm-dap;message=upload-errors
Content-Length: 20

encoded(struct {
  reports = [
    struct {
      id = [0x0z, 0x0y, 0x0x, 0x0w, ...],
      error = report_replayed,
    },
  ],
} UploadErrors)
</pre><a href="#section-4.4.2.3-4" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="report-extensions">
<section id="section-4.4.3">
          <h4 id="name-report-extensions">
<a href="#section-4.4.3" class="section-number selfRef">4.4.3. </a><a href="#name-report-extensions" class="section-name selfRef">Report Extensions</a>
          </h4>
<p id="section-4.4.3-1">Clients use report extensions to convey additional information to the
Aggregators. Each <code>ReportMetadata</code> contains a list of extensions public to both
aggregators, and each <code>PlaintextInputShare</code> contains a list of extensions
private to the relevant Aggregator. For example, Clients may need to
authenticate to the Helper by presenting a secret that must not be revealed to
the Leader.<a href="#section-4.4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.4.3-2">Each extension is a tag-length encoded value of the form:<a href="#section-4.4.3-2" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.4.3-3">
<pre>
struct {
  ExtensionType extension_type;
  opaque extension_data&lt;0..2^16-1&gt;;
} Extension;

enum {
  reserved(0),
  (65535)
} ExtensionType;
</pre><a href="#section-4.4.3-3" class="pilcrow">¶</a>
</div>
<p id="section-4.4.3-4">Field <code>extension_type</code> indicates the type of extension, and <code>extension_data</code>
contains the opaque encoding of the extension.<a href="#section-4.4.3-4" class="pilcrow">¶</a></p>
<p id="section-4.4.3-5">Extensions are mandatory to implement. Unrecognized extensions are handled as
specified in <a href="#input-share-validation" class="auto internal xref">Section 4.5.2.4</a>.<a href="#section-4.4.3-5" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="aggregate-flow">
<section id="section-4.5">
        <h3 id="name-verifying-and-aggregating-r">
<a href="#section-4.5" class="section-number selfRef">4.5. </a><a href="#name-verifying-and-aggregating-r" class="section-name selfRef">Verifying and Aggregating Reports</a>
        </h3>
<p id="section-4.5-1">Once some Clients have uploaded their reports to the Leader, the Leader can
begin the process of validating and aggregating them with the Helper. To enable
the system to handle large batches of reports, this process is parallelized
across many "aggregation jobs" in which subsets of the reports are processed
independently. Each aggregation job is associated with a single task, but a task
can have many aggregation jobs.<a href="#section-4.5-1" class="pilcrow">¶</a></p>
<p id="section-4.5-2">An aggregation job runs the VDAF verification process described in <span>[<a href="#VDAF" class="cite xref">VDAF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.2" class="relref">Section 5.2</a></span> for each report in the job. Verification has two purposes:<a href="#section-4.5-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.5-3">
<li id="section-4.5-3.1">
            <p id="section-4.5-3.1.1">To "refine" the input shares into "output shares" that have the desired
aggregatable form. For some VDAFs, like Prio3, the mapping from input to
output shares is a fixed operation depending only on the input share, but in
general the mapping involves an aggregation parameter chosen by the
Collector.<a href="#section-4.5-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.5-3.2">
            <p id="section-4.5-3.2.1">To verify that each pair of output shares, when combined, corresponds to a
valid, refined measurement, where validity is determined by the VDAF itself.
For example, the Prio3Sum variant of Prio3 (<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-7.4.2" class="relref">Section 7.4.2</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>)
proves that the output shares sum up to an integer in a specific range, while
the Prio3Histogram variant (<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-7.4.4" class="relref">Section 7.4.4</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>) proves that output
shares sum up to a one-hot vector representing a contribution to a single
bucket of the histogram.<a href="#section-4.5-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-4.5-4">In general, refinement and verification are not distinct computations, since for
some VDAFs, verification may only be achieved implicitly as a result of the
refinement process. We instead think of these as properties of the output shares
themselves: if verification succeeds, then the resulting output shares are
guaranteed to combine into a valid, refined measurement.<a href="#section-4.5-4" class="pilcrow">¶</a></p>
<p id="section-4.5-5">Aggregation jobs are identified by 16-byte job ID, chosen by the Leader:<a href="#section-4.5-5" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.5-6">
<pre>
opaque AggregationJobID[16];
</pre><a href="#section-4.5-6" class="pilcrow">¶</a>
</div>
<p id="section-4.5-7">An aggregation job is an HTTP resource served by the Helper at the
URL <code>{helper}/tasks/{task-id}/aggregation_jobs/{aggregation-job-id}</code>. VDAF
verification is mapped onto an aggregation job as illustrated in <a href="#agg-flow" class="auto internal xref">Figure 7</a>.
The first request from the Leader to the Helper includes the aggregation
parameter, the Helper's report share for each report in the job, and for each
report the initialization step for verification. The Helper's response, along
with each subsequent request and response, carries the remaining messages
exchanged during verification.<a href="#section-4.5-7" class="pilcrow">¶</a></p>
<span id="name-overview-of-the-dap-aggrega"></span><div id="agg-flow">
<figure id="figure-7">
          <div id="section-4.5-8.1">
            <div class="alignLeft art-svg artwork" id="section-4.5-8.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="544" width="496" viewBox="0 0 496 544" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                <path d="M 8,80 L 8,112" fill="none" stroke="black"></path>
                <path d="M 32,48 L 32,72" fill="none" stroke="black"></path>
                <path d="M 32,112 L 32,320" fill="none" stroke="black"></path>
                <path d="M 32,384 L 32,512" fill="none" stroke="black"></path>
                <path d="M 80,80 L 80,112" fill="none" stroke="black"></path>
                <path d="M 416,80 L 416,112" fill="none" stroke="black"></path>
                <path d="M 464,112 L 464,320" fill="none" stroke="black"></path>
                <path d="M 464,384 L 464,512" fill="none" stroke="black"></path>
                <path d="M 488,80 L 488,112" fill="none" stroke="black"></path>
                <path d="M 8,80 L 80,80" fill="none" stroke="black"></path>
                <path d="M 416,80 L 488,80" fill="none" stroke="black"></path>
                <path d="M 8,112 L 80,112" fill="none" stroke="black"></path>
                <path d="M 416,112 L 488,112" fill="none" stroke="black"></path>
                <path d="M 40,160 L 456,160" fill="none" stroke="black"></path>
                <path d="M 40,208 L 456,208" fill="none" stroke="black"></path>
                <path d="M 40,256 L 456,256" fill="none" stroke="black"></path>
                <path d="M 40,304 L 456,304" fill="none" stroke="black"></path>
                <path d="M 40,432 L 456,432" fill="none" stroke="black"></path>
                <path d="M 40,480 L 456,480" fill="none" stroke="black"></path>
                <polygon class="arrowhead" points="472,512 460,506.4 460,517.6" fill="black" transform="rotate(90,464,512)"></polygon>
                <polygon class="arrowhead" points="464,432 452,426.4 452,437.6" fill="black" transform="rotate(0,456,432)"></polygon>
                <polygon class="arrowhead" points="464,256 452,250.4 452,261.6" fill="black" transform="rotate(0,456,256)"></polygon>
                <polygon class="arrowhead" points="464,160 452,154.4 452,165.6" fill="black" transform="rotate(0,456,160)"></polygon>
                <polygon class="arrowhead" points="48,480 36,474.4 36,485.6" fill="black" transform="rotate(180,40,480)"></polygon>
                <polygon class="arrowhead" points="48,304 36,298.4 36,309.6" fill="black" transform="rotate(180,40,304)"></polygon>
                <polygon class="arrowhead" points="48,208 36,202.4 36,213.6" fill="black" transform="rotate(180,40,208)"></polygon>
                <polygon class="arrowhead" points="40,512 28,506.4 28,517.6" fill="black" transform="rotate(90,32,512)"></polygon>
                <polygon class="arrowhead" points="40,72 28,66.4 28,77.6" fill="black" transform="rotate(90,32,72)"></polygon>
                <g class="text">
                  <text x="48" y="36">report,</text>
                  <text x="120" y="36">agg_param</text>
                  <text x="44" y="100">Leader</text>
                  <text x="452" y="100">Helper</text>
                  <text x="132" y="132">AggregationJobInitReq:</text>
                  <text x="100" y="148">agg_param,</text>
                  <text x="192" y="148">verify_init</text>
                  <text x="376" y="180">AggregationJobResp:</text>
                  <text x="352" y="196">verify_resp(continue)</text>
                  <text x="148" y="228">AggregationJobContinueReq:</text>
                  <text x="120" y="244">verify_continue</text>
                  <text x="376" y="276">AggregationJobResp:</text>
                  <text x="352" y="292">verify_resp(continue)</text>
                  <text x="32" y="356">...</text>
                  <text x="464" y="356">...</text>
                  <text x="148" y="404">AggregationJobContinueReq:</text>
                  <text x="120" y="420">verify_continue</text>
                  <text x="376" y="452">AggregationJobResp:</text>
                  <text x="324" y="468">verify_resp(continue|finish)</text>
                  <text x="84" y="532">leader_out_share</text>
                  <text x="412" y="532">helper_out_share</text>
                </g>
              </svg><a href="#section-4.5-8.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-7" class="selfRef">Figure 7</a>:
<a href="#name-overview-of-the-dap-aggrega" class="selfRef">Overview of the DAP aggregation interaction.</a>
          </figcaption></figure>
</div>
<p id="section-4.5-9">The number of steps, and the type of the responses, depends on the VDAF. The
message structures and processing rules are specified in the following
subsections.<a href="#section-4.5-9" class="pilcrow">¶</a></p>
<p id="section-4.5-10">Each Aggregator maintains some state for each report. A state transition is
triggered by receiving a message from the Aggregator's peer. Eventually this
process results in a terminal state, either rejecting the report or recovering
an output share. Once a report has reached a terminal state, no more messages
will be processed for it. There are four possible states (see <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.7" class="relref">Section 5.7</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>: <code>Continued</code>, <code>FinishedWithOutbound</code>, <code>Finished</code> and <code>Rejected</code>. The
first two states include an outbound message to be processed by the peer.<a href="#section-4.5-10" class="pilcrow">¶</a></p>
<p id="section-4.5-11">The Helper can either process each step synchronously, meaning it computes each
verification step before producing a response to the Leader's HTTP request, or
asynchronously, meaning it responds immediately and defers processing to a
background worker. To continue, the Leader polls the Helper until it responds
with the next step. This choice allows a Helper implementation to choose a
model that best fits its architecture and use case. For instance replay checks
across vast numbers of reports and verification of large histograms, may be
better suited for the asynchronous model.<a href="#section-4.5-11" class="pilcrow">¶</a></p>
<p id="section-4.5-12">Aggregation cannot begin until the Collector specifies a query and an
aggregation parameter, except where eager aggregation (<a href="#eager-aggregation" class="auto internal xref">Section 4.5.1</a>) is
possible.<a href="#section-4.5-12" class="pilcrow">¶</a></p>
<p id="section-4.5-13">An aggregation job has three phases:<a href="#section-4.5-13" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5-14.1">
            <p id="section-4.5-14.1.1">Initialization: Disseminate report shares and initialize the VDAF
verification state for each report.<a href="#section-4.5-14.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.5-14.2">
            <p id="section-4.5-14.2.1">Continuation: Exchange verifier shares and messages until verification
completes or an error occurs.<a href="#section-4.5-14.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.5-14.3">
            <p id="section-4.5-14.3.1">Completion: Yield an output share for each report share in the aggregation
job.<a href="#section-4.5-14.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-4.5-15">After an aggregation job is completed, each Aggregator commits to the output
shares by updating running-total aggregate shares and other values for each
batch bucket associated with a verified output share, as described in
<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>. These values are stored until a batch that includes the batch
bucket is collected as described in <a href="#collect-flow" class="auto internal xref">Section 4.6</a>.<a href="#section-4.5-15" class="pilcrow">¶</a></p>
<p id="section-4.5-16">The aggregation interaction provides protection against including reports in
more than one batch and against adding reports to already collected batches,
both of which can violate privacy (<a href="#replay-protection" class="auto internal xref">Section 2.3</a>). Before committing to
an output share, the Aggregators check whether its report ID has already been
aggregated and whether the batch bucket being updated has been collected.<a href="#section-4.5-16" class="pilcrow">¶</a></p>
<div id="eager-aggregation">
<section id="section-4.5.1">
          <h4 id="name-eager-aggregation">
<a href="#section-4.5.1" class="section-number selfRef">4.5.1. </a><a href="#name-eager-aggregation" class="section-name selfRef">Eager Aggregation</a>
          </h4>
<p id="section-4.5.1-1">In general, aggregation cannot begin until the Collector specifies a query and
an aggregation parameter. However, depending on the VDAF and batch mode in use,
it is often possible to begin aggregation as soon as reports arrive.<a href="#section-4.5.1-1" class="pilcrow">¶</a></p>
<p id="section-4.5.1-2">For example, Prio3 has just one valid aggregation parameter (the empty string),
and so allows for eager aggregation. Both the time-interval and leader-selected
batch modes defined in this document (<a href="#batch-modes" class="auto internal xref">Section 5</a>) allow for eager
aggregation, but future batch modes might preclude it.<a href="#section-4.5.1-2" class="pilcrow">¶</a></p>
<p id="section-4.5.1-3">Even when the VDAF uses a non-empty aggregation parameter, there still might be
some applications in which the Aggregators can anticipate the parameter the
Collector will choose and begin aggregation.<a href="#section-4.5.1-3" class="pilcrow">¶</a></p>
<p id="section-4.5.1-4">For example, when using Poplar1 (<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-8" class="relref">Section 8</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>), the Collector and
Aggregators might agree ahead of time on the set of candidate prefixes to use.
In such cases, it is important that Aggregators ensure that the parameter
eventually chosen by the Collector matches what they used. Depending on the
VDAF, aggregating reports with multiple aggregation parameters may impact
privacy. Aggregators must therefore ensure they only ever use the aggregation
parameter chosen by the Collector.<a href="#section-4.5.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="agg-init">
<section id="section-4.5.2">
          <h4 id="name-aggregate-initialization">
<a href="#section-4.5.2" class="section-number selfRef">4.5.2. </a><a href="#name-aggregate-initialization" class="section-name selfRef">Aggregate Initialization</a>
          </h4>
<p id="section-4.5.2-1">Aggregation initialization accomplishes two tasks:<a href="#section-4.5.2-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.5.2-2">
<li id="section-4.5.2-2.1">
              <p id="section-4.5.2-2.1.1">Determine which report shares are valid.<a href="#section-4.5.2-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-4.5.2-2.2">
              <p id="section-4.5.2-2.2.1">For each valid report share, initialize VDAF verification (see <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.2" class="relref">Section 5.2</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>).<a href="#section-4.5.2-2.2.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-4.5.2-3">The Leader and Helper initialization behavior is detailed below.<a href="#section-4.5.2-3" class="pilcrow">¶</a></p>
<div id="leader-init">
<section id="section-4.5.2.1">
            <h5 id="name-leader-initialization">
<a href="#section-4.5.2.1" class="section-number selfRef">4.5.2.1. </a><a href="#name-leader-initialization" class="section-name selfRef">Leader Initialization</a>
            </h5>
<span id="name-leader-state-transition-tri"></span><div id="leader-init-state">
<figure id="figure-8">
              <div id="section-4.5.2.1-1.1">
                <div class="alignLeft art-svg artwork" id="section-4.5.2.1-1.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="160" width="432" viewBox="0 0 432 160" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                    <path d="M 216,48 L 216,144" fill="none" stroke="black"></path>
                    <path d="M 64,48 L 80,48" fill="none" stroke="black"></path>
                    <path d="M 176,48 L 256,48" fill="none" stroke="black"></path>
                    <path d="M 216,80 L 256,80" fill="none" stroke="black"></path>
                    <path d="M 216,112 L 256,112" fill="none" stroke="black"></path>
                    <path d="M 216,144 L 256,144" fill="none" stroke="black"></path>
                    <polygon class="arrowhead" points="264,144 252,138.4 252,149.6" fill="black" transform="rotate(0,256,144)"></polygon>
                    <polygon class="arrowhead" points="264,112 252,106.4 252,117.6" fill="black" transform="rotate(0,256,112)"></polygon>
                    <polygon class="arrowhead" points="264,80 252,74.4 252,85.6" fill="black" transform="rotate(0,256,80)"></polygon>
                    <polygon class="arrowhead" points="264,48 252,42.4 252,53.6" fill="black" transform="rotate(0,256,48)"></polygon>
                    <polygon class="arrowhead" points="88,48 76,42.4 76,53.6" fill="black" transform="rotate(0,80,48)"></polygon>
                    <g class="text">
                      <text x="212" y="36">VerifyResp</text>
                      <text x="28" y="52">Report</text>
                      <text x="128" y="52">Continued</text>
                      <text x="304" y="52">Continued</text>
                      <text x="348" y="84">FinishedWithOutbound</text>
                      <text x="300" y="116">Finished</text>
                      <text x="376" y="116">(*commit)</text>
                      <text x="300" y="148">Rejected</text>
                      <text x="376" y="148">(*reject)</text>
                    </g>
                  </svg><a href="#section-4.5.2.1-1.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-8" class="selfRef">Figure 8</a>:
<a href="#name-leader-state-transition-tri" class="selfRef">Leader state transition triggered by aggregation initialization. (*) indicates a terminal state.</a>
              </figcaption></figure>
</div>
<p id="section-4.5.2.1-2">The Leader begins an aggregation job by choosing a set of candidate reports that
belong to the same task and a job ID which <span class="bcp14">MUST</span> be unique within the task.<a href="#section-4.5.2.1-2" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-3">First, the Leader <span class="bcp14">MUST</span> ensure each report in the candidate set can be committed
per the criteria detailed in <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>. If a report cannot be committed,
then the Leader rejects it and removes it from the candidate set.<a href="#section-4.5.2.1-3" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-4">Next, the Leader decrypts each of its report shares as described in
<a href="#input-share-decryption" class="auto internal xref">Section 4.5.2.3</a>, then checks input share validity as described in
<a href="#input-share-validation" class="auto internal xref">Section 4.5.2.4</a>. If either step fails, the Leader rejects the report
and removes it from the candidate set.<a href="#section-4.5.2.1-4" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-5">For each report the Leader executes the following procedure:<a href="#section-4.5.2.1-5" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.5.2.1-6">
<pre>
state = Vdaf.ping_pong_leader_init(
    vdaf_verify_key,
    "dap-17" || task_id,
    agg_param,
    report_id,
    public_share,
    plaintext_input_share.payload,
)
</pre><a href="#section-4.5.2.1-6" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.1-7">where:<a href="#section-4.5.2.1-7" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.2.1-8.1">
                <p id="section-4.5.2.1-8.1.1"><code>vdaf_verify_key</code> is the VDAF verification key for the task<a href="#section-4.5.2.1-8.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-8.2">
                <p id="section-4.5.2.1-8.2.1"><code>task_id</code> is the task ID<a href="#section-4.5.2.1-8.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-8.3">
                <p id="section-4.5.2.1-8.3.1"><code>agg_param</code> is the VDAF aggregation parameter provided by the Collector (see
<a href="#collect-flow" class="auto internal xref">Section 4.6</a>)<a href="#section-4.5.2.1-8.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-8.4">
                <p id="section-4.5.2.1-8.4.1"><code>report_id</code> is the report ID, used as the nonce for VDAF sharding<a href="#section-4.5.2.1-8.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-8.5">
                <p id="section-4.5.2.1-8.5.1"><code>public_share</code> is the report's public share<a href="#section-4.5.2.1-8.5.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-8.6">
                <p id="section-4.5.2.1-8.6.1"><code>plaintext_input_share</code> is the Leader's <code>PlaintextInputShare</code><a href="#section-4.5.2.1-8.6.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.2.1-9"><code>ping_pong_leader_init</code> is defined in <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.7.1" class="relref">Section 5.7.1</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>. This process
determines the initial per-report <code>state</code>. If <code>state</code> is of type <code>Rejected</code>
(<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.7" class="relref">Section 5.7</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>, then the report is rejected and removed from the
candidate set, and no message is sent to the Helper for this report.<a href="#section-4.5.2.1-9" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-10">Otherwise, if <code>state</code> is of type <code>Continued</code> (no other state is reachable at
this point), then the state includes an outbound message denoted
<code>state.outbound</code>. The Leader uses it to construct a <code>VerifyInit</code> structure for
that report.<a href="#section-4.5.2.1-10" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.5.2.1-11">
<pre>
struct {
  ReportMetadata report_metadata;
  opaque public_share&lt;0..2^32-1&gt;;
  HpkeCiphertext encrypted_input_share;
} ReportShare;

struct {
  ReportShare report_share;
  opaque payload&lt;1..2^32-1&gt;;
} VerifyInit;
</pre><a href="#section-4.5.2.1-11" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.1-12">This message consists of:<a href="#section-4.5.2.1-12" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.2.1-13.1">
                <p id="section-4.5.2.1-13.1.1"><code>report_share.report_metadata</code>: The report's metadata.<a href="#section-4.5.2.1-13.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-13.2">
                <p id="section-4.5.2.1-13.2.1"><code>report_share.public_share</code>: The report's public share.<a href="#section-4.5.2.1-13.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-13.3">
                <p id="section-4.5.2.1-13.3.1"><code>report_share.encrypted_input_share</code>: The Helper's encrypted input share.<a href="#section-4.5.2.1-13.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-13.4">
                <p id="section-4.5.2.1-13.4.1"><code>payload</code>: The outbound message, set to <code>state.outbound</code>.<a href="#section-4.5.2.1-13.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.2.1-14">Once all the report shares have been initialized, the Leader creates an
<code>AggregationJobInitReq</code> message containing the <code>VerifyInit</code> structures
for the relevant reports.<a href="#section-4.5.2.1-14" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.5.2.1-15">
<pre>
struct {
  BatchMode batch_mode;
  opaque config&lt;0..2^16-1&gt;;
} PartialBatchSelector;

struct {
  uint8 verification_key_id;
  opaque agg_param&lt;0..2^32-1&gt;;
  PartialBatchSelector part_batch_selector;
  VerifyInit verify_inits[verify_inits_length];
} AggregationJobInitReq;
</pre><a href="#section-4.5.2.1-15" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.1-16">This message consists of:<a href="#section-4.5.2.1-16" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.2.1-17.1">
                <p id="section-4.5.2.1-17.1.1"><code>verification_key_id</code>: An identifier for the shared VDAF verification key
that Aggregators use to verify report integrity;
see <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.2" class="relref">Section 5.2</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span> and <a href="#verification-key" class="auto internal xref">Section 8.6.2</a>.
This allows a Leader to nominate a verification key
from a set of prearranged keys.
This might also allow for verification keys to be updated by Aggregators.<a href="#section-4.5.2.1-17.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-17.2">
                <p id="section-4.5.2.1-17.2.1"><code>agg_param</code>: The VDAF aggregation parameter chosen by the Collector. Before
initializing an aggregation job, the Leader <span class="bcp14">MUST</span> validate the parameter as
described in <a href="#agg-param-validation" class="auto internal xref">Section 4.3</a>.<a href="#section-4.5.2.1-17.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-17.3">
                <p id="section-4.5.2.1-17.3.1"><code>part_batch_selector</code>: The "partial batch selector" used by the Aggregators to
determine how to aggregate each report. Its contents depends on the indicated
batch mode. This field is called the "partial" batch selector because
depending on the batch mode, it may only partially determine a batch. See
<a href="#batch-modes" class="auto internal xref">Section 5</a>.<a href="#section-4.5.2.1-17.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.1-17.4">
                <p id="section-4.5.2.1-17.4.1"><code>verify_inits</code>: the sequence of <code>VerifyInit</code> messages constructed in the
previous step. Here <code>verify_inits_length</code> is the length of the HTTP message
content (<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-6.4" class="relref">Section 6.4</a></span>), minus the lengths in octets of the
encoded <code>agg_param</code> and <code>part_batch_selector</code> fields. That is, the remainder
of the HTTP message consists of <code>verify_inits</code>.<a href="#section-4.5.2.1-17.4.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<aside id="section-4.5.2.1-18">
              <p id="section-4.5.2.1-18.1">IMPORTANT: this this does not change the security requirements
for verification keys; see <a href="#verification-key" class="auto internal xref">Section 8.6.2</a>.
The analysis in <span>[<a href="#DPRS23" class="cite xref">DPRS23</a>]</span> depends on an assumption
that verification keys are selected prior to a report being generated;
a different analysis would be required
to enable selecting a verification key after a task has started.<a href="#section-4.5.2.1-18.1" class="pilcrow">¶</a></p>
</aside>
<p id="section-4.5.2.1-19">The Leader sends the <code>AggregationJobInitReq</code> in the body of a PUT request to the
aggregation job with a media type of
"application/ppm-dap;message=aggregation-job-init-req". The Leader handles the
response(s) as described in <a href="#http-usage" class="auto internal xref">Section 3</a> to obtain an <code>AggregationJobResp</code>.<a href="#section-4.5.2.1-19" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-20">The <code>AggregationJobResp.verify_resps</code> field must include exactly the same
report IDs in the same order as the Leader's <code>AggregationJobInitReq</code>. Otherwise,
the Leader <span class="bcp14">MUST</span> abandon the aggregation job.<a href="#section-4.5.2.1-20" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-21">The Leader proceeds as follows with each report:<a href="#section-4.5.2.1-21" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.5.2.1-22">
<li id="section-4.5.2.1-22.1">
                <p id="section-4.5.2.1-22.1.1">If the inbound verification response has type "continue", then the Leader
computes<a href="#section-4.5.2.1-22.1.1" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.5.2.1-22.1.2">
<pre>
state = Vdaf.ping_pong_leader_continued(
    "dap-17" || task_id,
    agg_param,
    state,
    inbound,
)
</pre><a href="#section-4.5.2.1-22.1.2" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.1-22.1.3">
where:<a href="#section-4.5.2.1-22.1.3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.2.1-22.1.4.1">
                    <p id="section-4.5.2.1-22.1.4.1.1"><code>task_id</code> is the task ID<a href="#section-4.5.2.1-22.1.4.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="normal" id="section-4.5.2.1-22.1.4.2">
                    <p id="section-4.5.2.1-22.1.4.2.1"><code>agg_param</code> is the VDAF aggregation parameter provided by the Collector
(see <a href="#collect-flow" class="auto internal xref">Section 4.6</a>)<a href="#section-4.5.2.1-22.1.4.2.1" class="pilcrow">¶</a></p>
</li>
                  <li class="normal" id="section-4.5.2.1-22.1.4.3">
                    <p id="section-4.5.2.1-22.1.4.3.1"><code>state</code> is the report's initial verification state<a href="#section-4.5.2.1-22.1.4.3.1" class="pilcrow">¶</a></p>
</li>
                  <li class="normal" id="section-4.5.2.1-22.1.4.4">
                    <p id="section-4.5.2.1-22.1.4.4.1"><code>inbound</code> is the payload of the <code>VerifyResp</code><a href="#section-4.5.2.1-22.1.4.4.1" class="pilcrow">¶</a></p>
</li>
                </ul>
<p id="section-4.5.2.1-22.1.5">
If the new <code>state</code> has type <code>Continued</code> or <code>FinishedWithOutbound</code>,
then there is at least one more outbound message to send before verification
is complete. The Leader stores <code>state</code> and proceeds as in
<a href="#aggregation-leader-continuation" class="auto internal xref">Section 4.5.3.1</a>.<a href="#section-4.5.2.1-22.1.5" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-22.1.6">
Else if the new <code>state</code> has type <code>Finished</code>, then verification is complete
and the state includes an output share, denoted <code>state.out_share</code>. The Leader
commits to <code>state.out_share</code> as described in <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>.<a href="#section-4.5.2.1-22.1.6" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-22.1.7">
Else if <code>state</code> has type <code>Rejected</code>, then the Leader rejects the
report and removes it from the candidate set.<a href="#section-4.5.2.1-22.1.7" class="pilcrow">¶</a></p>
<p id="section-4.5.2.1-22.1.8">
Note on rejection agreement: rejecting at this point would result in a batch
mismatch if the Helper had already committed to its output share. This is
impossible due to the verifiability property of the VDAF: if the underlying
measurement were invalid, then the Helper would have indicated rejection in
its response.<a href="#section-4.5.2.1-22.1.8" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.1-22.2">
                <p id="section-4.5.2.1-22.2.1">Else if the <code>VerifyResp</code> has type "reject", then the Leader rejects the
report and removes it from the candidate set. The Leader <span class="bcp14">MUST NOT</span> include
the report in a subsequent aggregation job, unless the report error is
<code>report_too_early</code>, in which case the Leader <span class="bcp14">MAY</span> include the report in a
subsequent aggregation job.<a href="#section-4.5.2.1-22.2.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.1-22.3">
                <p id="section-4.5.2.1-22.3.1">Otherwise the inbound message type is invalid for the Leader's current
state, in which case the Leader <span class="bcp14">MUST</span> abandon the aggregation job.<a href="#section-4.5.2.1-22.3.1" class="pilcrow">¶</a></p>
</li>
            </ol>
<p id="section-4.5.2.1-23">Since VDAF verification completes in a constant number of rounds, it will never
be the case that verification is complete for some of the reports in an
aggregation job but not others.<a href="#section-4.5.2.1-23" class="pilcrow">¶</a></p>
</section>
</div>
<div id="aggregation-helper-init">
<section id="section-4.5.2.2">
            <h5 id="name-helper-initialization">
<a href="#section-4.5.2.2" class="section-number selfRef">4.5.2.2. </a><a href="#name-helper-initialization" class="section-name selfRef">Helper Initialization</a>
            </h5>
<span id="name-helper-state-transition-tri"></span><div id="helper-init-state">
<figure id="figure-9">
              <div id="section-4.5.2.2-1.1">
                <div class="alignLeft art-svg artwork" id="section-4.5.2.2-1.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="112" width="392" viewBox="0 0 392 112" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                    <path d="M 112,32 L 112,96" fill="none" stroke="black"></path>
                    <path d="M 96,32 L 136,32" fill="none" stroke="black"></path>
                    <path d="M 112,64 L 136,64" fill="none" stroke="black"></path>
                    <path d="M 112,96 L 136,96" fill="none" stroke="black"></path>
                    <polygon class="arrowhead" points="144,96 132,90.4 132,101.6" fill="black" transform="rotate(0,136,96)"></polygon>
                    <polygon class="arrowhead" points="144,64 132,58.4 132,69.6" fill="black" transform="rotate(0,136,64)"></polygon>
                    <polygon class="arrowhead" points="144,32 132,26.4 132,37.6" fill="black" transform="rotate(0,136,32)"></polygon>
                    <g class="text">
                      <text x="44" y="36">VerifyInit</text>
                      <text x="184" y="36">Continued</text>
                      <text x="228" y="68">FinishedWithOutbound</text>
                      <text x="352" y="68">(*commit)</text>
                      <text x="180" y="100">Rejected</text>
                      <text x="256" y="100">(*reject)</text>
                    </g>
                  </svg><a href="#section-4.5.2.2-1.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-9" class="selfRef">Figure 9</a>:
<a href="#name-helper-state-transition-tri" class="selfRef">Helper state transition triggered by aggregation initialization. (*) indicates a terminal state.</a>
              </figcaption></figure>
</div>
<p id="section-4.5.2.2-2">The Helper begins an aggregation job when it receives an <code>AggregationJobInitReq</code>
message from the Leader. For each <code>VerifyInit</code> in this message, the Helper
attempts to initialize VDAF verification (see <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.1" class="relref">Section 5.1</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>) just as
the Leader does. If successful, it includes the result in its response for the
Leader to use to continue verifying the report.<a href="#section-4.5.2.2-2" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-3">The initialization request can be handled either asynchronously or synchronously
as described in <a href="#http-usage" class="auto internal xref">Section 3</a>. When indicating that the job is not yet
ready, the response <span class="bcp14">MUST</span> include a Location header field (<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-10.2.2" class="relref">Section 10.2.2</a></span>) set to the relative reference
<code>/tasks/{task-id}/aggregation_jobs/{aggregation-job-id}?step=0</code>. Subsequent GET
requests to the aggregation job <span class="bcp14">MUST</span> include the <code>step</code> query parameter so that
the Helper can figure out which step of preparation the Leader is on (see
<a href="#aggregation-step-skew-recovery" class="auto internal xref">Section 4.5.3.4</a>). When the job is ready, the Helper responds
with the <code>AggregationJobResp</code> (defined below).<a href="#section-4.5.2.2-3" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-4">Upon receipt of an <code>AggregationJobInitReq</code>, the Helper checks the following
conditions:<a href="#section-4.5.2.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.2.2-5.1">
                <p id="section-4.5.2.2-5.1.1">Whether it recognizes the task ID. If not, then the Helper <span class="bcp14">MUST</span> fail the job
with error <code>unrecognizedTask</code>.<a href="#section-4.5.2.2-5.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-5.2">
                <p id="section-4.5.2.2-5.2.1">Whether the <code>AggregationJobInitReq</code> is malformed. If so, the the Helper <span class="bcp14">MUST</span>
fail the job with error <code>invalidMessage</code>.<a href="#section-4.5.2.2-5.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-5.3">
                <p id="section-4.5.2.2-5.3.1">Whether the batch mode indicated by <code>part_batch_selector.batch_mode</code> matches
the task's batch mode. If not, then the Helper <span class="bcp14">MUST</span> fail the job with error
<code>invalidMessage</code>.<a href="#section-4.5.2.2-5.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-5.4">
                <p id="section-4.5.2.2-5.4.1">Whether the aggregation parameter is valid as described in
<a href="#agg-param-validation" class="auto internal xref">Section 4.3</a>. If the aggregation parameter is invalid, then the
Helper <span class="bcp14">MUST</span> fail the job with error <code>invalidAggregationParameter</code>.<a href="#section-4.5.2.2-5.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-5.5">
                <p id="section-4.5.2.2-5.5.1">Whether the report IDs in <code>AggregationJobInitReq.verify_inits</code> are all
distinct. If not, then the Helper <span class="bcp14">MUST</span> fail the job with error
<code>invalidMessage</code>.<a href="#section-4.5.2.2-5.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.2.2-6">The Helper then processes the aggregation job by computing a response for each
report share. This includes the following structures:<a href="#section-4.5.2.2-6" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.5.2.2-7">
<pre>
enum {
  continue(0),
  finish(1)
  reject(2),
  (255)
} VerifyRespType;

struct {
  ReportID report_id;
  VerifyRespType verify_resp_type;
  select (VerifyResp.verify_resp_type) {
    case continue: opaque payload&lt;1..2^32-1&gt;;
    case finish:   Empty;
    case reject:   ReportError report_error;
  };
} VerifyResp;
</pre><a href="#section-4.5.2.2-7" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.2-8"><code>VerifyResp.report_id</code> is always set to the ID of the report that the Helper is
verifying. The values of the other fields in different cases are discussed
below.<a href="#section-4.5.2.2-8" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-9">The Helper processes each of the remaining report shares in turn.
First, the Helper decrypts each report share as described in
<a href="#input-share-decryption" class="auto internal xref">Section 4.5.2.3</a>, then checks input share validity as described in
<a href="#input-share-validation" class="auto internal xref">Section 4.5.2.4</a>. If either decryption of validation fails, the Helper
sets <code>VerifyResp.verify_resp_type</code> to <code>reject</code> and <code>VerifyResp.report_error</code>
to the indicated error.<a href="#section-4.5.2.2-9" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-10">For all other reports it initializes the VDAF verification state as follows:<a href="#section-4.5.2.2-10" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.5.2.2-11">
<pre>
state = Vdaf.ping_pong_helper_init(
    vdaf_verify_key,
    "dap-17" || task_id,
    agg_param,
    report_id,
    public_share,
    plaintext_input_share.payload,
    inbound,
)
</pre><a href="#section-4.5.2.2-11" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.5.2.2-12.1">
                <p id="section-4.5.2.2-12.1.1"><code>vdaf_verify_key</code> is the VDAF verification key for the task<a href="#section-4.5.2.2-12.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-12.2">
                <p id="section-4.5.2.2-12.2.1"><code>task_id</code> is the task ID<a href="#section-4.5.2.2-12.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-12.3">
                <p id="section-4.5.2.2-12.3.1"><code>verification_key_id</code> is the key identifier for the verification key
chosen by the Leader and included in the <code>AggregationJobInitReq</code> message<a href="#section-4.5.2.2-12.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-12.4">
                <p id="section-4.5.2.2-12.4.1"><code>agg_param</code> is the VDAF aggregation parameter sent in the
<code>AggregationJobInitReq</code> message<a href="#section-4.5.2.2-12.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-12.5">
                <p id="section-4.5.2.2-12.5.1"><code>report_id</code> is the report ID<a href="#section-4.5.2.2-12.5.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-12.6">
                <p id="section-4.5.2.2-12.6.1"><code>public_share</code> is the report's public share<a href="#section-4.5.2.2-12.6.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-12.7">
                <p id="section-4.5.2.2-12.7.1"><code>plaintext_input_share</code> is the Helper's <code>PlaintextInputShare</code><a href="#section-4.5.2.2-12.7.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.2-12.8">
                <p id="section-4.5.2.2-12.8.1"><code>inbound</code> is the payload of the inbound <code>VerifyInit</code><a href="#section-4.5.2.2-12.8.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.2.2-13">This procedure determines the initial per-report <code>state</code>. If <code>state</code> is of type
<code>Rejected</code>, then the Helper sets <code>VerifyResp.verify_resp_type</code> to <code>reject</code> and
<code>VerifyResp.report_error</code> to <code>vdaf_verify_error</code>.<a href="#section-4.5.2.2-13" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-14">Otherwise <code>state</code> has type <code>Continued</code> or <code>FinishedWithOutbound</code> and
there is at least one more outbound message to process. State <code>Finished</code> is
not reachable at this point. The Helper sets <code>VerifyResp.verify_resp_type</code> to
<code>continue</code> and <code>VerifyResp.payload</code> to <code>state.outbound</code>.<a href="#section-4.5.2.2-14" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-15">If <code>state</code> has type <code>Continued</code>, then the Helper stores <code>state</code> for use in the
first continuation step in <a href="#aggregation-helper-continuation" class="auto internal xref">Section 4.5.3.2</a>.<a href="#section-4.5.2.2-15" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-16">Else if <code>state</code> has type <code>FinishedWithOutbound</code>, then the Helper commits to
<code>state.out_share</code> as described in <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>. If commitment fails with
some report error <code>commit_error</code> (e.g., the report was replayed or its batch
bucket was collected), then the Helper sets <code>VerifyResp.verify_resp_type</code> to
<code>reject</code> and <code>VerifyResp.report_error</code> to <code>commit_error</code>.<a href="#section-4.5.2.2-16" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-17">Once the Helper has constructed a <code>VerifyResp</code> for each report, the aggregation
job response is ready. Its results are represented by an <code>AggregationJobResp</code>,
which is structured as follows:<a href="#section-4.5.2.2-17" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.5.2.2-18">
<pre>
struct {
  VerifyResp verify_resps[message_length];
} AggregationJobResp;
</pre><a href="#section-4.5.2.2-18" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.2-19">Here <code>message_length</code> is the length of the HTTP message content (<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-6.4" class="relref">Section 6.4</a></span>).<a href="#section-4.5.2.2-19" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-20"><code>verify_resps</code> is the outbound <code>VerifyResp</code> messages for each report computed
in the previous step. The order <span class="bcp14">MUST</span> match
<code>AggregationJobInitReq.verify_inits</code>. The media type for <code>AggregationJobResp</code>
is "application/ppm-dap;message=aggregation-job-resp".<a href="#section-4.5.2.2-20" class="pilcrow">¶</a></p>
<p id="section-4.5.2.2-21">The Helper may receive multiple copies of a given initialization request. The
Helper <span class="bcp14">MUST</span> verify that subsequent requests have the same
<code>AggregationJobInitReq</code> value and abort with a client error if they do not. It
is illegal to rewind or reset the state of an aggregation job. If the Helper
receives requests to initialize an aggregation job once it has been continued at
least once, confirming that the Leader received the Helper's response (see
<a href="#agg-continue-flow" class="auto internal xref">Section 4.5.3</a>), it <span class="bcp14">MUST</span> abort with a client error.<a href="#section-4.5.2.2-21" class="pilcrow">¶</a></p>
</section>
</div>
<div id="input-share-decryption">
<section id="section-4.5.2.3">
            <h5 id="name-input-share-decryption">
<a href="#section-4.5.2.3" class="section-number selfRef">4.5.2.3. </a><a href="#name-input-share-decryption" class="section-name selfRef">Input Share Decryption</a>
            </h5>
<p id="section-4.5.2.3-1">Each report share has a corresponding task ID, report metadata (report ID,
timestamp, and public extensions), public share, and the Aggregator's encrypted
input share. Let <code>task_id</code>, <code>report_metadata</code>, <code>public_share</code>, and
<code>encrypted_input_share</code> denote these values, respectively. Given these values,
an Aggregator decrypts the input share as follows. First, it constructs an
<code>InputShareAad</code> message from <code>task_id</code>, <code>report_metadata</code>, and <code>public_share</code>.
Let this be denoted by <code>input_share_aad</code>. Then, the Aggregator attempts
decryption of the payload with the following procedure:<a href="#section-4.5.2.3-1" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.5.2.3-2">
<pre>
plaintext_input_share = OpenBase(encrypted_input_share.enc, sk,
  "dap-17 input share" || 0x01 || server_role,
  input_share_aad, encrypted_input_share.payload)
</pre><a href="#section-4.5.2.3-2" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.5.2.3-3.1">
                <p id="section-4.5.2.3-3.1.1"><code>sk</code> is the secret key from the HPKE configuration indicated by
<code>encrypted_input_share.config_id</code><a href="#section-4.5.2.3-3.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.3-3.2">
                <p id="section-4.5.2.3-3.2.1"><code>0x01</code> represents the Role of the sender (always the Client)<a href="#section-4.5.2.3-3.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.2.3-3.3">
                <p id="section-4.5.2.3-3.3.1"><code>server_role</code> is the Role of the recipient Aggregator (<code>0x02</code> for the Leader
and <code>0x03</code> for the Helper).<a href="#section-4.5.2.3-3.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.2.3-4">The <code>OpenBase()</code> function is as specified in <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-6.1" class="relref">Section 6.1</a></span> for the
ciphersuite indicated by the HPKE configuration.<a href="#section-4.5.2.3-4" class="pilcrow">¶</a></p>
<p id="section-4.5.2.3-5">If the HPKE configuration ID is unrecognized or decryption fails, the Aggregator
marks the report share as invalid with the error <code>hpke_decrypt_error</code>.
Otherwise, the Aggregator outputs the resulting PlaintextInputShare
<code>plaintext_input_share</code>.<a href="#section-4.5.2.3-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="input-share-validation">
<section id="section-4.5.2.4">
            <h5 id="name-input-share-validation">
<a href="#section-4.5.2.4" class="section-number selfRef">4.5.2.4. </a><a href="#name-input-share-validation" class="section-name selfRef">Input Share Validation</a>
            </h5>
<p id="section-4.5.2.4-1">Before initialization, Aggregators <span class="bcp14">MUST</span> perform the following checks for each
input share in the job, in any order:<a href="#section-4.5.2.4-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.5.2.4-2">
<li id="section-4.5.2.4-2.1">
                <p id="section-4.5.2.4-2.1.1">Check that the input share can be decoded as specified by the VDAF. If not,
the input share <span class="bcp14">MUST</span> be marked as invalid with the error <code>invalid_message</code>.<a href="#section-4.5.2.4-2.1.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.4-2.2">
                <p id="section-4.5.2.4-2.2.1">Check if the report's timestamp is more than a few minutes ahead of the
current time. If so, then the Aggregator <span class="bcp14">SHOULD</span> mark the input share as
invalid with error <code>report_too_early</code>.<a href="#section-4.5.2.4-2.2.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.4-2.3">
                <p id="section-4.5.2.4-2.3.1">Check if the report's timestamp is before the task's <code>task_interval</code>. If so,
the Aggregator <span class="bcp14">MUST</span> mark the input share as invalid with the error
<code>task_not_started</code>.<a href="#section-4.5.2.4-2.3.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.4-2.4">
                <p id="section-4.5.2.4-2.4.1">Check if the report's timestamp is after the task's <code>task_interval</code>. If so,
the Aggregator <span class="bcp14">MUST</span> mark the input share as invalid with the error
<code>task_expired</code>.<a href="#section-4.5.2.4-2.4.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.4-2.5">
                <p id="section-4.5.2.4-2.5.1">Check if the public or private report extensions contain any unrecognized
report extension types. If so, the Aggregator <span class="bcp14">MUST</span> mark the input share as
invalid with error <code>invalid_message</code>.<a href="#section-4.5.2.4-2.5.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.4-2.6">
                <p id="section-4.5.2.4-2.6.1">Check if any two extensions have the same extension type across public and
private extension fields. If so, the Aggregator <span class="bcp14">MUST</span> mark the input share as
invalid with error <code>invalid_message</code>.<a href="#section-4.5.2.4-2.6.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.2.4-2.7">
                <p id="section-4.5.2.4-2.7.1">If an Aggregator cannot determine if an input share is valid--for example,
the report timestamp may be so far in the past that the state required to
perform the check has been evicted from the Aggregator's storage (see
<a href="#sharding-storage" class="auto internal xref">Section 6.4.1</a> for details)--it <span class="bcp14">MUST</span> mark the input share as invalid
with error <code>report_dropped</code>.<a href="#section-4.5.2.4-2.7.1" class="pilcrow">¶</a></p>
</li>
            </ol>
<p id="section-4.5.2.4-3">If all of the above checks succeed, the input share is valid.<a href="#section-4.5.2.4-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-2">
<section id="section-4.5.2.5">
            <h5 id="name-example-3">
<a href="#section-4.5.2.5" class="section-number selfRef">4.5.2.5. </a><a href="#name-example-3" class="section-name selfRef">Example</a>
            </h5>
<p id="section-4.5.2.5-1">The Helper handles the aggregation job initialization synchronously:<a href="#section-4.5.2.5-1" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.5.2.5-2">
<pre>
PUT /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=aggregation-job-init-req
Content-Length: 100
Authorization: Bearer auth-token

encoded(struct {
  agg_param = [0x00, 0x01, 0x02, 0x04, ...],
  part_batch_selector = struct {
    batch_mode = BatchMode.leader_selected,
    config = encoded(struct {
      batch_id = [0x1f, 0x1e, ..., 0x00],
    } LeaderSelectedPartialBatchSelectorConfig),
  } PartialBatchSelector,
  verify_inits,
} AggregationJobInitReq)

HTTP/1.1 200
Content-Type: application/ppm-dap;message=aggregation-job-resp
Content-Length: 100

encoded(struct { verify_resps } AggregationJobResp)
</pre><a href="#section-4.5.2.5-2" class="pilcrow">¶</a>
</div>
<p id="section-4.5.2.5-3">Or asynchronously:<a href="#section-4.5.2.5-3" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.5.2.5-4">
<pre>
PUT /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=aggregation-job-init-req
Content-Length: 100
Authorization: Bearer auth-token

encoded(struct {
  agg_param = [0x00, 0x01, 0x02, 0x04, ...],
  part_batch_selector = struct {
    batch_mode = BatchMode.time_interval,
    config = encoded(Empty),
  },
  verify_inits,
} AggregationJobInitReq)

HTTP/1.1 200
Location: /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=0
Retry-After: 300

GET /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=0
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Location: /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=0
Retry-After: 300

GET /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=0
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Content-Type: application/ppm-dap;message=aggregation-job-resp
Content-Length: 100

encoded(struct { verify_resps } AggregationJobResp)
</pre><a href="#section-4.5.2.5-4" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="agg-continue-flow">
<section id="section-4.5.3">
          <h4 id="name-aggregate-continuation">
<a href="#section-4.5.3" class="section-number selfRef">4.5.3. </a><a href="#name-aggregate-continuation" class="section-name selfRef">Aggregate Continuation</a>
          </h4>
<p id="section-4.5.3-1">In the continuation phase, the Leader drives the VDAF verification of each
report in the candidate set until the underlying VDAF moves into a terminal
state, yielding an output share for each Aggregator or a rejection.<a href="#section-4.5.3-1" class="pilcrow">¶</a></p>
<p id="section-4.5.3-2">Continuation is only required for VDAFs that require more than one round. Single
round VDAFs like Prio3 will never reach this phase.<a href="#section-4.5.3-2" class="pilcrow">¶</a></p>
<div id="aggregation-leader-continuation">
<section id="section-4.5.3.1">
            <h5 id="name-leader-continuation">
<a href="#section-4.5.3.1" class="section-number selfRef">4.5.3.1. </a><a href="#name-leader-continuation" class="section-name selfRef">Leader Continuation</a>
            </h5>
<span id="name-leader-state-transition-trig"></span><div id="leader-cont-state">
<figure id="figure-10">
              <div id="section-4.5.3.1-1.1">
                <div class="alignLeft art-svg artwork" id="section-4.5.3.1-1.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="240" width="344" viewBox="0 0 344 240" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                    <path d="M 128,48 L 128,144" fill="none" stroke="black"></path>
                    <path d="M 216,192 L 216,224" fill="none" stroke="black"></path>
                    <path d="M 88,48 L 168,48" fill="none" stroke="black"></path>
                    <path d="M 128,80 L 168,80" fill="none" stroke="black"></path>
                    <path d="M 128,112 L 168,112" fill="none" stroke="black"></path>
                    <path d="M 128,144 L 168,144" fill="none" stroke="black"></path>
                    <path d="M 176,192 L 256,192" fill="none" stroke="black"></path>
                    <path d="M 216,224 L 256,224" fill="none" stroke="black"></path>
                    <polygon class="arrowhead" points="264,224 252,218.4 252,229.6" fill="black" transform="rotate(0,256,224)"></polygon>
                    <polygon class="arrowhead" points="264,192 252,186.4 252,197.6" fill="black" transform="rotate(0,256,192)"></polygon>
                    <polygon class="arrowhead" points="176,144 164,138.4 164,149.6" fill="black" transform="rotate(0,168,144)"></polygon>
                    <polygon class="arrowhead" points="176,112 164,106.4 164,117.6" fill="black" transform="rotate(0,168,112)"></polygon>
                    <polygon class="arrowhead" points="176,80 164,74.4 164,85.6" fill="black" transform="rotate(0,168,80)"></polygon>
                    <polygon class="arrowhead" points="176,48 164,42.4 164,53.6" fill="black" transform="rotate(0,168,48)"></polygon>
                    <g class="text">
                      <text x="132" y="36">VerifyResp</text>
                      <text x="40" y="52">Continued</text>
                      <text x="216" y="52">Continued</text>
                      <text x="260" y="84">FinishedWithOutbound</text>
                      <text x="212" y="116">Finished</text>
                      <text x="288" y="116">(*commit)</text>
                      <text x="212" y="148">Rejected</text>
                      <text x="288" y="148">(*reject)</text>
                      <text x="212" y="180">VerifyResp</text>
                      <text x="84" y="196">FinishedWithOutbound</text>
                      <text x="304" y="196">(*commit)</text>
                      <text x="304" y="228">(*reject)</text>
                    </g>
                  </svg><a href="#section-4.5.3.1-1.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-10" class="selfRef">Figure 10</a>:
<a href="#name-leader-state-transition-trig" class="selfRef">Leader state transition triggered by aggregation continuation. (*) indicates a terminal state.</a>
              </figcaption></figure>
</div>
<p id="section-4.5.3.1-2">The Leader begins each step of aggregation continuation with a verification
state object <code>state</code> for each report in the candidate set. Either all states
have type <code>Continued</code> or all states have type <code>FinishedWithOutbound</code>. In either
case, there is at least one more outbound message to process, denoted
<code>state.outbound</code>.<a href="#section-4.5.3.1-2" class="pilcrow">¶</a></p>
<p id="section-4.5.3.1-3">The Leader advances its aggregation job to the next step (step 1 if this is the
first continuation after initialization). Then it instructs the Helper to
advance the aggregation job to the step the Leader has just reached. For each
report the Leader constructs a verification continuation message:<a href="#section-4.5.3.1-3" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.5.3.1-4">
<pre>
struct {
  ReportID report_id;
  opaque payload&lt;1..2^32-1&gt;;
} VerifyContinue;
</pre><a href="#section-4.5.3.1-4" class="pilcrow">¶</a>
</div>
<p id="section-4.5.3.1-5">where <code>report_id</code> is the report ID associated with <code>state</code>, and
<code>payload</code> is set to <code>state.outbound</code>.<a href="#section-4.5.3.1-5" class="pilcrow">¶</a></p>
<p id="section-4.5.3.1-6">Next, the Leader sends a POST to the aggregation job with media type
"application/ppm-dap;message=aggregation-job-continue-req" and body structured
as:<a href="#section-4.5.3.1-6" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.5.3.1-7">
<pre>
struct {
  uint16 step;
  VerifyContinue verify_continues[verify_continues_length];
} AggregationJobContinueReq;
</pre><a href="#section-4.5.3.1-7" class="pilcrow">¶</a>
</div>
<p id="section-4.5.3.1-8">The <code>step</code> field is the step of DAP aggregation that the Leader just reached and
wants the Helper to advance to. The <code>verify_continues</code> field is the sequence of
verification continuation messages constructed in the previous step. Here
<code>verify_continues_length</code> is the length of the HTTP message content
(<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-6.4" class="relref">Section 6.4</a></span>), minus the length in octets of <code>step</code>. The
<code>VerifyContinue</code> elements <span class="bcp14">MUST</span> be in the same order as the previous request to
the aggregation job, omitting any reports that were previously rejected by
either Aggregator.<a href="#section-4.5.3.1-8" class="pilcrow">¶</a></p>
<p id="section-4.5.3.1-9">The Leader handles the response(s) as described in <a href="#http-usage" class="auto internal xref">Section 3</a> to obtain an
<code>AggregationJobResp</code>.<a href="#section-4.5.3.1-9" class="pilcrow">¶</a></p>
<p id="section-4.5.3.1-10">The response's <code>verify_resps</code> <span class="bcp14">MUST</span> include exactly the same report IDs in the
same order as the Leader's <code>AggregationJobContinueReq</code>. Otherwise, the Leader
<span class="bcp14">MUST</span> abandon the aggregation job.<a href="#section-4.5.3.1-10" class="pilcrow">¶</a></p>
<p id="section-4.5.3.1-11">Otherwise, the Leader proceeds as follows with each report:<a href="#section-4.5.3.1-11" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.5.3.1-12">
<li id="section-4.5.3.1-12.1">
                <p id="section-4.5.3.1-12.1.1">If <code>state</code> has type <code>Continued</code> and the inbound <code>VerifyResp</code> has
type "continue", then the Leader computes<a href="#section-4.5.3.1-12.1.1" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.5.3.1-12.1.2">
<pre>
state = Vdaf.ping_pong_leader_continued(
    "dap-17" || task_id,
    agg_param,
    state,
    inbound,
)
</pre><a href="#section-4.5.3.1-12.1.2" class="pilcrow">¶</a>
</div>
<p id="section-4.5.3.1-12.1.3">
where <code>task_id</code> is the task ID, <code>inbound</code> is the payload of the inbound
<code>VerifyResp</code>, and <code>state</code> is the report's verification state carried over
from the previous step. It then processes the next state transition:<a href="#section-4.5.3.1-12.1.3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.3.1-12.1.4.1">
                    <p id="section-4.5.3.1-12.1.4.1.1">If the type of the new <code>state</code> is <code>Continued</code> or
<code>FinishedWithOutbound</code>, then the Leader stores <code>state</code> and proceeds
to the next continuation step.<a href="#section-4.5.3.1-12.1.4.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="normal" id="section-4.5.3.1-12.1.4.2">
                    <p id="section-4.5.3.1-12.1.4.2.1">Else if the new type is <code>Rejected</code>, then the Leader rejects the report and
removes it from the candidate set.<a href="#section-4.5.3.1-12.1.4.2.1" class="pilcrow">¶</a></p>
<p id="section-4.5.3.1-12.1.4.2.2">
Note on rejection agreement: rejecting at this point would result in a
batch mismatch if the Helper had already committed to its output share.
This is impossible due to the verifiability property of the VDAF: if the
underlying measurement were invalid, then the Helper would have indicated
rejection in its response.<a href="#section-4.5.3.1-12.1.4.2.2" class="pilcrow">¶</a></p>
</li>
                  <li class="normal" id="section-4.5.3.1-12.1.4.3">
                    <p id="section-4.5.3.1-12.1.4.3.1">Else if the new type is <code>Finished</code>, then the Leader commits to
<code>state.out_share</code> as described in <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>.<a href="#section-4.5.3.1-12.1.4.3.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li id="section-4.5.3.1-12.2">
                <p id="section-4.5.3.1-12.2.1">Else if <code>state</code> has type <code>FinishedWithOutbound</code> and the inbound
<code>VerifyResp</code> has type "finish", then verification is complete and the
Leader commits to <code>state.out_share</code> as described in
<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>.<a href="#section-4.5.3.1-12.2.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.3.1-12.3">
                <p id="section-4.5.3.1-12.3.1">Else if the inbound <code>VerifyResp</code> has type "reject", then the Leader rejects
the report and removes it from the candidate set. The Leader <span class="bcp14">MUST NOT</span>
include the report in a subsequent aggregation job, unless the report error
is <code>report_too_early</code>, in which case the Leader <span class="bcp14">MAY</span> include the report in a
subsequent aggregation job.<a href="#section-4.5.3.1-12.3.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.3.1-12.4">
                <p id="section-4.5.3.1-12.4.1">Otherwise the inbound message is incompatible with the Leader's current
state, in which case the Leader <span class="bcp14">MUST</span> abandon the aggregation job.<a href="#section-4.5.3.1-12.4.1" class="pilcrow">¶</a></p>
</li>
            </ol>
<p id="section-4.5.3.1-13">If the Leader fails to process the response from the Helper, for example because
of a transient failure such as a network connection failure or process crash,
the Leader <span class="bcp14">SHOULD</span> re-send the original request unmodified in order to attempt
recovery (see <a href="#aggregation-step-skew-recovery" class="auto internal xref">Section 4.5.3.4</a>).<a href="#section-4.5.3.1-13" class="pilcrow">¶</a></p>
</section>
</div>
<div id="aggregation-helper-continuation">
<section id="section-4.5.3.2">
            <h5 id="name-helper-continuation">
<a href="#section-4.5.3.2" class="section-number selfRef">4.5.3.2. </a><a href="#name-helper-continuation" class="section-name selfRef">Helper Continuation</a>
            </h5>
<span id="name-helper-state-transition-trig"></span><div id="helper-cont-state">
<figure id="figure-11">
              <div id="section-4.5.3.2-1.1">
                <div class="alignLeft art-svg artwork" id="section-4.5.3.2-1.1.1">
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="160" width="424" viewBox="0 0 424 160" class="diagram" text-anchor="middle" font-family="monospace" font-size="13px" stroke-linecap="round">
                    <path d="M 128,48 L 128,144" fill="none" stroke="black"></path>
                    <path d="M 88,48 L 168,48" fill="none" stroke="black"></path>
                    <path d="M 128,80 L 168,80" fill="none" stroke="black"></path>
                    <path d="M 128,112 L 168,112" fill="none" stroke="black"></path>
                    <path d="M 128,144 L 168,144" fill="none" stroke="black"></path>
                    <polygon class="arrowhead" points="176,144 164,138.4 164,149.6" fill="black" transform="rotate(0,168,144)"></polygon>
                    <polygon class="arrowhead" points="176,112 164,106.4 164,117.6" fill="black" transform="rotate(0,168,112)"></polygon>
                    <polygon class="arrowhead" points="176,80 164,74.4 164,85.6" fill="black" transform="rotate(0,168,80)"></polygon>
                    <polygon class="arrowhead" points="176,48 164,42.4 164,53.6" fill="black" transform="rotate(0,168,48)"></polygon>
                    <g class="text">
                      <text x="140" y="36">VerifyContinue</text>
                      <text x="40" y="52">Continued</text>
                      <text x="216" y="52">Continued</text>
                      <text x="260" y="84">FinishedWithOutbound</text>
                      <text x="384" y="84">(commit*)</text>
                      <text x="212" y="116">Finished</text>
                      <text x="288" y="116">(commit*)</text>
                      <text x="212" y="148">Rejected</text>
                      <text x="288" y="148">(reject*)</text>
                    </g>
                  </svg><a href="#section-4.5.3.2-1.1.1" class="pilcrow">¶</a>
</div>
</div>
<figcaption><a href="#figure-11" class="selfRef">Figure 11</a>:
<a href="#name-helper-state-transition-trig" class="selfRef">Helper state transition triggered by aggregation continuation. (*) indicates a terminal state.</a>
              </figcaption></figure>
</div>
<p id="section-4.5.3.2-2">The Helper begins continuation with a <code>state</code> object for each report in
the candidate set, each of which has type <code>Continued</code>. The Helper waits for the
Leader to POST an <code>AggregationJobContinueReq</code> to the aggregation job.<a href="#section-4.5.3.2-2" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-3">The continuation request can be handled either asynchronously or synchronously
as described in <a href="#http-usage" class="auto internal xref">Section 3</a>. When indicating that the job is not yet ready,
the response <span class="bcp14">MUST</span> include a Location header field (<span>[<a href="#RFC9110" class="cite xref">RFC9110</a>], <a href="https://rfc-editor.org/rfc/rfc9110#section-10.2.2" class="relref">Section 10.2.2</a></span>)
to the relative reference
<code>/tasks/{task-id}/aggregation_jobs/{aggregation-job-id}?step={step}</code>, where
<code>step</code> is set to <code>AggregationJobContinueReq.step</code>. Subsequent GET requests to
the aggregation job <span class="bcp14">MUST</span> include the <code>step</code> query parameter so that the Helper
can figure out which step of preparation the Leader is on (see
<a href="#aggregation-step-skew-recovery" class="auto internal xref">Section 4.5.3.4</a>). The representation of the aggregation job
is an <code>AggregationJobResp</code>.<a href="#section-4.5.3.2-3" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-4">To begin handling an <code>AggregationJobContinueReq</code>, the Helper checks the
following conditions:<a href="#section-4.5.3.2-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.3.2-5.1">
                <p id="section-4.5.3.2-5.1.1">Whether it recognizes the task ID. If not, then the Helper <span class="bcp14">MUST</span> fail the job
with error <code>unrecognizedTask</code>.<a href="#section-4.5.3.2-5.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.2-5.2">
                <p id="section-4.5.3.2-5.2.1">Whether it recognizes the indicated aggregation job ID. If not, the Helper
<span class="bcp14">MUST</span> fail the job with error <code>unrecognizedAggregationJob</code>.<a href="#section-4.5.3.2-5.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.2-5.3">
                <p id="section-4.5.3.2-5.3.1">Whether the <code>AggregationJobContinueReq</code> is malformed. If so, the the Helper
<span class="bcp14">MUST</span> fail the job with error <code>invalidMessage</code>.<a href="#section-4.5.3.2-5.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.2-5.4">
                <p id="section-4.5.3.2-5.4.1">Whether <code>AggregationJobContinueReq.step</code> is equal to <code>0</code>. If so, the Helper
<span class="bcp14">MUST</span> fail the job with error <code>invalidMessage</code>.<a href="#section-4.5.3.2-5.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.2-5.5">
                <p id="section-4.5.3.2-5.5.1">Whether the report IDs are all distinct and each report ID corresponds to one
of the <code>state</code> objects. If either of these checks fail, then the Helper <span class="bcp14">MUST</span>
fail the job with error <code>invalidMessage</code>.<a href="#section-4.5.3.2-5.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.3.2-6">Additionally, if any verification step appears out of order relative to the
previous request, then the Helper <span class="bcp14">MAY</span> fail the job with error <code>invalidMessage</code>.
A report may be missing, in which case the Helper assumes the Leader rejected
it and removes it from the candidate set.<a href="#section-4.5.3.2-6" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-7">Next, the Helper checks the continuation step indicated by the request. If the
<code>step</code> value is one greater than the job's current step, then the Helper
proceeds.<a href="#section-4.5.3.2-7" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-8">The Helper may receive multiple copies of a continuation request for a given
step. The Helper <span class="bcp14">MAY</span> attempt to recover by sending the same response as it did
for the previous <code>AggregationJobContinueReq</code>, without performing any additional
work on the aggregation job. It is illegal to rewind or reset the state of an
aggregation job, so in this case it <span class="bcp14">MUST</span> verify that the contents of the
<code>AggregationJobContinueReq</code> are identical to the previous message (see
<a href="#aggregation-step-skew-recovery" class="auto internal xref">Section 4.5.3.4</a>).<a href="#section-4.5.3.2-8" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-9">If the Helper does not wish to attempt recovery, or if the step has some other
value, the Helper <span class="bcp14">MUST</span> fail the job with error <code>stepMismatch</code>.<a href="#section-4.5.3.2-9" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-10">For each report, the Helper does the following:<a href="#section-4.5.3.2-10" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.5.3.2-11">
<pre>
state = Vdaf.ping_pong_helper_continued(
    "dap-17" || task_id,
    agg_param,
    state,
    inbound,
)
</pre><a href="#section-4.5.3.2-11" class="pilcrow">¶</a>
</div>
<p id="section-4.5.3.2-12">where <code>task_id</code> is the task ID, <code>inbound</code> is the payload of the inbound
<code>VerifyContinue</code>, and <code>state</code> is the report's verification state carried over
from the previous step. If the new <code>state</code> has type <code>Rejected</code>, then the Helper
sets <code>VerifyResp.verify_resp_type</code> to <code>reject</code> and <code>VerifyResp.report_error</code>
to <code>vdaf_verify_error</code>.<a href="#section-4.5.3.2-12" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-13">If <code>state</code> has type <code>Continued</code>, then the Helper stores <code>state</code> for use in the
next continuation step.<a href="#section-4.5.3.2-13" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-14">If <code>state</code> has type <code>FinishedWithOutbound</code> or <code>Finished</code>, then the Helper
commits to <code>state.out_share</code> as described in <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>. If commitment
fails with some report error <code>commit_error</code> (e.g., the report was replayed or
its batch bucket was collected), then the Helper sets
<code>VerifyResp.verify_resp_type</code> to <code>reject</code> and <code>VerifyResp.report_error</code> to
<code>commit_error</code>.<a href="#section-4.5.3.2-14" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-15">If commitment succeeds, the Helper's response depends on whether the state
includes an outbound message that needs to be processed. If <code>state</code> has type
<code>Continued</code> or <code>FinishedWithOutbound</code> then the Helper sets
<code>VerifyResp.verify_resp_type</code> to <code>continue</code> and <code>VerifyResp.payload</code> to
<code>state.outbound</code>.<a href="#section-4.5.3.2-15" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-16">Otherwise, if <code>state</code> has type <code>Finished</code>, then the Helper sets
<code>VerifyResp.verify_resp_type</code> to <code>finish</code>.<a href="#section-4.5.3.2-16" class="pilcrow">¶</a></p>
<p id="section-4.5.3.2-17">Once the Helper has computed a <code>VerifyResp</code> for every report, the aggregation
job response is ready. It is represented by an <code>AggregationJobResp</code> message
(see <a href="#aggregation-helper-init" class="auto internal xref">Section 4.5.2.2</a>) with each verification step. The order of the
verification steps <span class="bcp14">MUST</span> match the Leader's <code>AggregationJobContinueReq</code>.<a href="#section-4.5.3.2-17" class="pilcrow">¶</a></p>
</section>
</div>
<div id="batch-buckets">
<section id="section-4.5.3.3">
            <h5 id="name-batch-buckets">
<a href="#section-4.5.3.3" class="section-number selfRef">4.5.3.3. </a><a href="#name-batch-buckets" class="section-name selfRef">Batch Buckets</a>
            </h5>
<p id="section-4.5.3.3-1">When aggregation refines an output share, it must be stored into an appropriate
"batch bucket", which is defined in this section. An output share cannot be
removed from a batch bucket once stored, so we say that the Aggregator <em>commits</em>
the output share. The data stored in a batch bucket is kept for eventual use in
the <a href="#collect-flow" class="auto internal xref">Section 4.6</a>.<a href="#section-4.5.3.3-1" class="pilcrow">¶</a></p>
<p id="section-4.5.3.3-2">Batch buckets are indexed by a "batch bucket identifier" as as specified by the
task's batch mode:<a href="#section-4.5.3.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.3.3-3.1">
                <p id="section-4.5.3.3-3.1.1">For the time-interval batch mode (<a href="#time-interval-batch-mode" class="auto internal xref">Section 5.1</a>, the batch
bucket identifier is an interval of time and is determined by the report's
timestamp.<a href="#section-4.5.3.3-3.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.3-3.2">
                <p id="section-4.5.3.3-3.2.1">For the leader-selected batch mode (<a href="#leader-selected-batch-mode" class="auto internal xref">Section 5.2</a>), the
batch bucket identifier is the batch ID and indicated in the aggregation job.<a href="#section-4.5.3.3-3.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.3.3-4">A few different pieces of information are associated with each batch bucket:<a href="#section-4.5.3.3-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.3.3-5.1">
                <p id="section-4.5.3.3-5.1.1">An aggregate share, as defined by the <span>[<a href="#VDAF" class="cite xref">VDAF</a>]</span> in use.<a href="#section-4.5.3.3-5.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.3-5.2">
                <p id="section-4.5.3.3-5.2.1">The number of reports included in the batch bucket.<a href="#section-4.5.3.3-5.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.3-5.3">
                <p id="section-4.5.3.3-5.3.1">A 32-byte checksum value, as defined below.<a href="#section-4.5.3.3-5.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.3.3-6">An output share is eligible to be committed if the following conditions are met:<a href="#section-4.5.3.3-6" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.3.3-7.1">
                <p id="section-4.5.3.3-7.1.1">If the batch bucket has been collected, the Aggregator <span class="bcp14">MUST</span> mark the report
invalid with error <code>batch_collected</code>.<a href="#section-4.5.3.3-7.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.3-7.2">
                <p id="section-4.5.3.3-7.2.1">If the report ID associated with <code>out_share</code> has been aggregated in the task,
the Aggregator <span class="bcp14">MUST</span> mark the report invalid with error <code>report_replayed</code>.<a href="#section-4.5.3.3-7.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.3.3-8">Aggregators <span class="bcp14">MUST</span> check these conditions before committing an output share.
Helpers may perform these checks at any time before commitment (i.e., during
either aggregation initialization or continuation), but Leaders <span class="bcp14">MUST</span> perform
these checks before adding a report to an aggregation job.<a href="#section-4.5.3.3-8" class="pilcrow">¶</a></p>
<p id="section-4.5.3.3-9">The following procedure is used to commit an output share <code>out_share</code> to a batch
bucket:<a href="#section-4.5.3.3-9" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.3.3-10.1">
                <p id="section-4.5.3.3-10.1.1">Look up the existing batch bucket for the batch bucket identifier
associated with the aggregation job and output share.<a href="#section-4.5.3.3-10.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.3.3-10.1.2.1">
                    <p id="section-4.5.3.3-10.1.2.1.1">If there is no existing batch bucket, initialize a new one. The initial
aggregate share value is computed as <code>Vdaf.agg_init(agg_param)</code>, where
<code>agg_param</code> is the aggregation parameter associated with the aggregation job
(see <span>[<a href="#VDAF" class="cite xref">VDAF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-4.4" class="relref">Section 4.4</a></span>). The initial count is <code>0</code> and the initial
checksum is 32 zero bytes.<a href="#section-4.5.3.3-10.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="normal" id="section-4.5.3.3-10.2">
                <p id="section-4.5.3.3-10.2.1">Update the aggregate share <code>agg_share</code> to <code>Vdaf.agg_update(agg_param,
agg_share, out_share)</code>.<a href="#section-4.5.3.3-10.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.3-10.3">
                <p id="section-4.5.3.3-10.3.1">Increment the count by 1.<a href="#section-4.5.3.3-10.3.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.3-10.4">
                <p id="section-4.5.3.3-10.4.1">Update the checksum value to the bitwise XOR of the current checksum value
with the SHA256 <span>[<a href="#SHS" class="cite xref">SHS</a>]</span> hash of the report ID
associated with the output share.<a href="#section-4.5.3.3-10.4.1" class="pilcrow">¶</a></p>
</li>
              <li class="normal" id="section-4.5.3.3-10.5">
                <p id="section-4.5.3.3-10.5.1">Store <code>out_share</code>'s report ID for future replay checks.<a href="#section-4.5.3.3-10.5.1" class="pilcrow">¶</a></p>
</li>
            </ul>
<p id="section-4.5.3.3-11">This section describes a single set of values associated with each batch bucket.
However, implementations are free to shard batch buckets, combining them back
into a single set of values when reading the batch bucket. The aggregate shares
are combined using <code>Vdaf.merge(agg_param, agg_shares)</code> (see <span>[<a href="#VDAF" class="cite xref">VDAF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-4.4" class="relref">Section 4.4</a></span>), the count values are combined by summing, and the checksum values are
combined by bitwise XOR.<a href="#section-4.5.3.3-11" class="pilcrow">¶</a></p>
<p id="section-4.5.3.3-12">Implementation note: The Leader considers a batch to be collected once it has
completed a collection job for a CollectionJobReq message from the Collector;
the Helper considers a batch to be collected once it has responded to an
<code>AggregateShareReq</code> message from the Leader. A batch is determined by query
conveyed in these messages. Queries must satisfy the criteria defined by their
batch mode (<a href="#batch-modes" class="auto internal xref">Section 5</a>). These criteria are meant to restrict queries in a
way that makes it easy to determine whether a report pertains to a batch that
was collected. See <a href="#distributed-systems" class="auto internal xref">Section 6.4.2</a> for more information.<a href="#section-4.5.3.3-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="aggregation-step-skew-recovery">
<section id="section-4.5.3.4">
            <h5 id="name-recovering-from-aggregation">
<a href="#section-4.5.3.4" class="section-number selfRef">4.5.3.4. </a><a href="#name-recovering-from-aggregation" class="section-name selfRef">Recovering from Aggregation Step Skew</a>
            </h5>
<p id="section-4.5.3.4-1"><code>AggregationJobContinueReq</code> messages contain a <code>step</code> field, allowing
Aggregators to ensure that their peer is on an expected step of verification.
In particular, the intent is to allow recovery from a scenario where the Helper
successfully advances from step <code>n</code> to <code>n+1</code>, but its <code>AggregationJobResp</code>
response to the Leader gets dropped due to something like a transient network
failure. The Leader could then resend the request to have the Helper advance to
step <code>n+1</code> and the Helper should be able to retransmit the <code>AggregationJobResp</code>
that was previously dropped. To make that kind of recovery possible, Aggregator
implementations <span class="bcp14">SHOULD</span> checkpoint the most recent step's verification state and
messages to durable storage such that the Leader can re-construct continuation
requests and the Helper can re-construct continuation responses as needed.<a href="#section-4.5.3.4-1" class="pilcrow">¶</a></p>
<p id="section-4.5.3.4-2">When implementing aggregation step skew recovery, the Helper <span class="bcp14">SHOULD</span> ensure that
the Leader's <code>AggregationJobContinueReq</code> message did not change when it was
re-sent (i.e., the two messages must be identical). This prevents the Leader
from re-winding an aggregation job and re-running an aggregation step with
different parameters.<a href="#section-4.5.3.4-2" class="pilcrow">¶</a></p>
<p id="section-4.5.3.4-3">One way the Helper could achieve this would be to store a digest of the Leader's
request, indexed by aggregation job ID and step, and refuse to service a request
for a given aggregation step unless it matches the previously seen request (if
any).<a href="#section-4.5.3.4-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-3">
<section id="section-4.5.3.5">
            <h5 id="name-example-4">
<a href="#section-4.5.3.5" class="section-number selfRef">4.5.3.5. </a><a href="#name-example-4" class="section-name selfRef">Example</a>
            </h5>
<p id="section-4.5.3.5-1">The Helper handles the aggregation job continuation synchronously:<a href="#section-4.5.3.5-1" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.5.3.5-2">
<pre>
POST /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=aggregation-job-continue-req
Content-Length: 100
Authorization: Bearer auth-token

encoded(struct {
  step = 1,
  verify_continues,
} AggregationJobContinueReq)

HTTP/1.1 200
Content-Type: application/ppm-dap;message=aggregation-job-resp
Content-Length: 100

encoded(struct { verify_resps } AggregationJobResp)
</pre><a href="#section-4.5.3.5-2" class="pilcrow">¶</a>
</div>
<p id="section-4.5.3.5-3">Or asynchronously:<a href="#section-4.5.3.5-3" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.5.3.5-4">
<pre>
POST /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=aggregation-job-continue-req
Content-Length: 100
Authorization: Bearer auth-token

encoded(struct {
  step = 1,
  verify_continues,
} AggregationJobContinueReq)

HTTP/1.1 200
Location: /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=1
Retry-After: 300

GET /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=1
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Location: /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=1
Retry-After: 300

GET /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA?step=1
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Content-Type: application/ppm-dap;message=aggregation-job-resp
Content-Length: 100

encoded(struct { verify_resps } AggregationJobResp)
</pre><a href="#section-4.5.3.5-4" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="aggregation-job-abandonment-and-deletion">
<section id="section-4.5.4">
          <h4 id="name-aggregation-job-abandonment">
<a href="#section-4.5.4" class="section-number selfRef">4.5.4. </a><a href="#name-aggregation-job-abandonment" class="section-name selfRef">Aggregation Job Abandonment and Deletion</a>
          </h4>
<p id="section-4.5.4-1">This document describes various error cases where a Leader is required to
abandon an aggregation job. This means the Leader should discontinue further
processing of the job and the reports included in it. Reports included in an
abandoned aggregation job <span class="bcp14">MUST NOT</span> be considered collected for purposes of
replay and double collection checks (<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>) and <span class="bcp14">MAY</span> be
included in future aggregation jobs.<a href="#section-4.5.4-1" class="pilcrow">¶</a></p>
<p id="section-4.5.4-2">If the Leader must abandon an aggregation job, it <span class="bcp14">SHOULD</span> let the Helper know it
can clean up its state by sending a DELETE request to the job. Deletion of a
completed aggregation job <span class="bcp14">MUST NOT</span> delete information needed for replay or double
collection checks.<a href="#section-4.5.4-2" class="pilcrow">¶</a></p>
<div id="example-4">
<section id="section-4.5.4.1">
            <h5 id="name-example-5">
<a href="#section-4.5.4.1" class="section-number selfRef">4.5.4.1. </a><a href="#name-example-5" class="section-name selfRef">Example</a>
            </h5>
<div class="lang-http sourcecode" id="section-4.5.4.1-1">
<pre>
DELETE /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregation_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
</pre><a href="#section-4.5.4.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="collect-flow">
<section id="section-4.6">
        <h3 id="name-collecting-results">
<a href="#section-4.6" class="section-number selfRef">4.6. </a><a href="#name-collecting-results" class="section-name selfRef">Collecting Results</a>
        </h3>
<p id="section-4.6-1">The Collector initiates this phase with a query to the Leader (<a href="#batch-modes" class="auto internal xref">Section 5</a>),
which the Aggregators use to select a batch of reports to aggregate. Each
Aggregator emits an aggregate share encrypted to the Collector so that it can
decrypt and combine them to yield the aggregate result. This process is referred
to as a "collection job" and is composed of two interactions:<a href="#section-4.6-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.6-2">
<li id="section-4.6-2.1">
            <p id="section-4.6-2.1.1">Collect request and response between the Collector and Leader, specified in
<a href="#collect-init" class="auto internal xref">Section 4.6.1</a><a href="#section-4.6-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.6-2.2">
            <p id="section-4.6-2.2.1">Aggregate share request and response between the Leader and the Helper,
specified in <a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a><a href="#section-4.6-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ol>
<p id="section-4.6-3">Once complete, the Collector computes the final aggregate result as specified in
<a href="#collect-finalization" class="auto internal xref">Section 4.6.5</a>.<a href="#section-4.6-3" class="pilcrow">¶</a></p>
<p id="section-4.6-4">Collection jobs are identified by a 16-byte job ID, chosen by the Collector:<a href="#section-4.6-4" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.6-5">
<pre>
opaque CollectionJobID[16];
</pre><a href="#section-4.6-5" class="pilcrow">¶</a>
</div>
<p id="section-4.6-6">A collection job is an HTTP resource served by the Leader at the URL
<code>{leader}/tasks/{task-id}/collection_jobs/{collection-job-id}</code>.<a href="#section-4.6-6" class="pilcrow">¶</a></p>
<div id="collect-init">
<section id="section-4.6.1">
          <h4 id="name-collection-job-initializati">
<a href="#section-4.6.1" class="section-number selfRef">4.6.1. </a><a href="#name-collection-job-initializati" class="section-name selfRef">Collection Job Initialization</a>
          </h4>
<p id="section-4.6.1-1">First, the Collector chooses a collection job ID, which <span class="bcp14">MUST</span> be unique within
the scope of the corresponding DAP task.<a href="#section-4.6.1-1" class="pilcrow">¶</a></p>
<p id="section-4.6.1-2">To initiate the collection job, the Collector issues a PUT request to the
collection job with media type "application/ppm-dap;message=collection-job-req",
and a body structured as follows:<a href="#section-4.6.1-2" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.6.1-3">
<pre>
struct {
  BatchMode batch_mode;
  opaque config&lt;0..2^16-1&gt;;
} Query;

struct {
  Query query;
  opaque agg_param&lt;0..2^32-1&gt;;
} CollectionJobReq;
</pre><a href="#section-4.6.1-3" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.6.1-4.1">
              <p id="section-4.6.1-4.1.1"><code>query</code>, the Collector's query. The content of this field depends on the
indicated batch mode (<a href="#batch-modes" class="auto internal xref">Section 5</a>).<a href="#section-4.6.1-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-4.2">
              <p id="section-4.6.1-4.2.1"><code>agg_param</code>, an aggregation parameter for the VDAF being executed. This is
the same value as in <code>AggregationJobInitReq</code> (see <a href="#leader-init" class="auto internal xref">Section 4.5.2.1</a>).<a href="#section-4.6.1-4.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.1-5">Depending on the VDAF scheme and how the Leader is configured, the Leader and
Helper may already have aggregated a sufficient number of reports satisfying the
query and be ready to return the aggregate shares right away. However, this is
not always the case. In fact, for some VDAFs, it is not be possible to begin
running aggregation jobs (<a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>) until the Collector initiates a
collection job. This is because, in general (see <a href="#eager-aggregation" class="auto internal xref">Section 4.5.1</a>), the
aggregation parameter is not known until this point. In certain situations it is
possible to predict the aggregation parameter in advance. For example, for Prio3
the only valid aggregation parameter is the empty string.<a href="#section-4.6.1-5" class="pilcrow">¶</a></p>
<p id="section-4.6.1-6">The collection request can be handled either asynchronously or synchronously as
described in <a href="#http-usage" class="auto internal xref">Section 3</a>. The representation of the collection job is a
<code>CollectionJobResp</code> (defined below).<a href="#section-4.6.1-6" class="pilcrow">¶</a></p>
<p id="section-4.6.1-7">If the job fails with <code>invalidBatchSize</code>, then the Collector <span class="bcp14">MAY</span> retry it later,
once it believes enough new reports have been uploaded and aggregated to allow
the collection job to succeed.<a href="#section-4.6.1-7" class="pilcrow">¶</a></p>
<p id="section-4.6.1-8">The Leader begins handling a <code>CollectionJobReq</code> by checking the following
conditions:<a href="#section-4.6.1-8" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.1-9.1">
              <p id="section-4.6.1-9.1.1">Whether it recognizes the task ID. If not, the Leader <span class="bcp14">MUST</span> fail the collection
job with error <code>unrecognizedTask</code>.<a href="#section-4.6.1-9.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-9.2">
              <p id="section-4.6.1-9.2.1">Whether the indicated batch mode matches the task's batch mode. If not, the
Leader <span class="bcp14">MUST</span> fail the job with error <code>invalidMessage</code>.<a href="#section-4.6.1-9.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-9.3">
              <p id="section-4.6.1-9.3.1">Whether the <code>CollectionJobReq</code> is malformed. If so, the the Helper <span class="bcp14">MUST</span> fail
the job with error <code>invalidMessage</code>.<a href="#section-4.6.1-9.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-9.4">
              <p id="section-4.6.1-9.4.1">Whether the aggregation parameter is valid as described in
<a href="#agg-param-validation" class="auto internal xref">Section 4.3</a>. If not, the Leader <span class="bcp14">MUST</span> fail the job with error
<code>invalidAggregationParameter</code>.<a href="#section-4.6.1-9.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-9.5">
              <p id="section-4.6.1-9.5.1">Whether the <code>Query</code> in the Collector's request determines a batch that can be
collected. If the query does not identify a valid set of batch buckets
according to the criteria defined by the batch mode in use (<a href="#batch-modes" class="auto internal xref">Section 5</a>),
then the Leader <span class="bcp14">MUST</span> fail the job with error <code>batchInvalid</code>.<a href="#section-4.6.1-9.5.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-9.6">
              <p id="section-4.6.1-9.6.1">Whether any of the batch buckets identified by the query have already been
collected, then the Leader <span class="bcp14">MUST</span> fail the job with error <code>batchOverlap</code>.<a href="#section-4.6.1-9.6.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-9.7">
              <p id="section-4.6.1-9.7.1">If aggregation was performed eagerly (<a href="#eager-aggregation" class="auto internal xref">Section 4.5.1</a>), then the Leader
checks that the aggregation parameter received in the <code>CollectionJobReq</code>
matches the aggregation parameter used in each aggregation job pertaining to
the batch. If not, the Leader <span class="bcp14">MUST</span> fail the job with error <code>invalidMessage</code>.<a href="#section-4.6.1-9.7.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.1-10">Having validated the <code>CollectionJobReq</code>, the Leader begins working with the
Helper to aggregate the reports satisfying the query (or continues this process,
depending on whether the Leader is aggregating eagerly; <a href="#eager-aggregation" class="auto internal xref">Section 4.5.1</a>)
as described in <a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>.<a href="#section-4.6.1-10" class="pilcrow">¶</a></p>
<p id="section-4.6.1-11">If the Leader has a pending aggregation job that overlaps with the batch for the
collection job, the Leader <span class="bcp14">MUST</span> first complete the aggregation job before
proceeding and requesting an aggregate share from the Helper. This avoids a race
condition between aggregation and collection jobs that can yield batch mismatch
errors.<a href="#section-4.6.1-11" class="pilcrow">¶</a></p>
<p id="section-4.6.1-12">If the number of validated reports in the batch is not equal to or greater than
the task's minimum batch size, then the Leader <span class="bcp14">SHOULD</span> wait for more reports to
be uploaded and aggregated and try the collection job again later. Alternately,
the Leader <span class="bcp14">MAY</span> give up on the collection job (for example, if it decides that no
new reports satisfying the query are likely to ever arrive), in which case it
<span class="bcp14">MUST</span> fail the job with error <code>invalidBatchSize</code>. It <span class="bcp14">MUST NOT</span> fulfill any jobs
with an insufficient number of validated reports.<a href="#section-4.6.1-12" class="pilcrow">¶</a></p>
<p id="section-4.6.1-13">Once the Leader has validated the collection job and run to completion all the
aggregation jobs that pertain to it, it obtains the Helper's aggregate share
following the aggregate-share request flow described in <a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a>.
If obtaining the aggregate share fails, then the Leader <span class="bcp14">MUST</span> fail the collection
job with the error that caused the failure.<a href="#section-4.6.1-13" class="pilcrow">¶</a></p>
<p id="section-4.6.1-14">Once the Leader has the Helper's aggregate share and has computed its own, the
collection job is ready. Its results are represented by a <code>CollectionJobResp</code>,
which is structured as follows:<a href="#section-4.6.1-14" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.6.1-15">
<pre>
struct {
  PartialBatchSelector part_batch_selector;
  uint64 report_count;
  Interval interval;
  HpkeCiphertext leader_encrypted_agg_share;
  HpkeCiphertext helper_encrypted_agg_share;
} CollectionJobResp;
</pre><a href="#section-4.6.1-15" class="pilcrow">¶</a>
</div>
<p id="section-4.6.1-16">A <code>CollectionJobResp</code>'s media type is
"application/ppm-dap;message=collection-job-resp". The structure includes the
following:<a href="#section-4.6.1-16" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.1-17.1">
              <p id="section-4.6.1-17.1.1"><code>part_batch_selector</code>: Information used to bind the aggregate result to the
query. For leader-selected tasks, this includes the batch ID assigned to the
batch by the Leader. The indicated batch mode <span class="bcp14">MUST</span> match the task's batch
mode.<a href="#section-4.6.1-17.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-17.2">
              <p id="section-4.6.1-17.2.1"><code>report_count</code>: The number of reports included in the batch.<a href="#section-4.6.1-17.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-17.3">
              <p id="section-4.6.1-17.3.1"><code>interval</code>: The smallest interval of time that contains the timestamps of all
reports included in the batch. In the case of a time-interval query
(<a href="#time-interval-batch-mode" class="auto internal xref">Section 5.1</a>), this interval can be smaller than the one in
the corresponding <code>CollectionJobReq.query</code>.<a href="#section-4.6.1-17.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-17.4">
              <p id="section-4.6.1-17.4.1"><code>leader_encrypted_agg_share</code>: The Leader's aggregate share, encrypted to the
Collector (see <a href="#aggregate-share-encrypt" class="auto internal xref">Section 4.6.6</a>).<a href="#section-4.6.1-17.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.1-17.5">
              <p id="section-4.6.1-17.5.1"><code>helper_encrypted_agg_share</code>: The Helper's aggregate share, encrypted to the
Collector (see <a href="#aggregate-share-encrypt" class="auto internal xref">Section 4.6.6</a>).<a href="#section-4.6.1-17.5.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.1-18">Once the <code>Leader</code> has constructed a <code>CollectionJobResp</code> for the Collector, the
Leader considers the batch to be collected, and further aggregation jobs <span class="bcp14">MUST NOT</span> commit more reports to the batch (see <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>).<a href="#section-4.6.1-18" class="pilcrow">¶</a></p>
<p id="section-4.6.1-19">Changing a collection job's parameters is illegal, so if there are further PUT
requests to the collection job with a different <code>CollectionJobReq</code>, the Leader
<span class="bcp14">MUST</span> abort with error <code>invalidMessage</code>.<a href="#section-4.6.1-19" class="pilcrow">¶</a></p>
<div id="example-5">
<section id="section-4.6.1.1">
            <h5 id="name-example-6">
<a href="#section-4.6.1.1" class="section-number selfRef">4.6.1.1. </a><a href="#name-example-6" class="section-name selfRef">Example</a>
            </h5>
<p id="section-4.6.1.1-1">The Leader handles the collection job request synchronously:<a href="#section-4.6.1.1-1" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.6.1.1-2">
<pre>
PUT /leader/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  collection_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=collection-job-req
Authorization: Bearer auth-token

encoded(struct {
  query = struct {
    batch_mode = BatchMode.leader_selected,
    query = encoded(Empty),
  } Query,
  agg_param = [0x00, 0x01, ...],
} CollectionJobReq)

HTTP/1.1 200
Content-Type: application/ppm-dap;message=collection-job-resp

encoded(struct {
  part_batch_selector = struct {
    batch_mode = BatchMode.leader_selected,
    config = encoded(struct {
      batch_id = [0x1f, 0x1e, ..., 0x00],
    } LeaderSelectedPartialBatchSelectorConfig),
  } PartialBatchSelector,
  report_count = 1000,
  interval = struct {
    start = 16595440,
    duration = 1,
  } Interval,
  leader_encrypted_agg_share = struct { ... } HpkeCiphertext,
  helper_encrypted_agg_share = struct { ... } HpkeCiphertext,
} CollectionJobResp)
</pre><a href="#section-4.6.1.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.6.1.1-3">Or asynchronously:<a href="#section-4.6.1.1-3" class="pilcrow">¶</a></p>
<div class="breakable lang-http sourcecode" id="section-4.6.1.1-4">
<pre>
PUT /leader/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  collection_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=collection-job-req
Authorization: Bearer auth-token

encoded(struct {
  query = struct {
    batch_mode = BatchMode.time_interval,
    query = encoded(struct {
      batch_interval = struct {
        start = 16595440,
        duration = 1,
      } Interval,
    } TimeIntervalQueryConfig),
  },
  agg_param = encoded(Empty),
} CollectionJobReq)

HTTP/1.1 200
Retry-After: 300

GET /leader/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  collection_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Retry-After: 300

GET /leader/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  collection_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Content-Type: application/ppm-dap;message=collection-job-resp

encoded(struct {
  part_batch_selector = struct {
    batch_mode = BatchMode.time_interval,
    config = encoded(struct {
      interval = struct {
        start = 1659544,
        duration = 10,
      } Interval,
    } TimeIntervalBatchSelectorConfig)
  },
  report_count = 4000,
  interval = struct {
    start = 1659547,
    duration = 10,
  } Interval,
  leader_encrypted_agg_share = struct { ... } HpkeCiphertext,
  helper_encrypted_agg_share = struct { ... } HpkeCiphertext,
} CollectionJobResp)
</pre><a href="#section-4.6.1.1-4" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="collection-job-deletion">
<section id="section-4.6.2">
          <h4 id="name-collection-job-deletion">
<a href="#section-4.6.2" class="section-number selfRef">4.6.2. </a><a href="#name-collection-job-deletion" class="section-name selfRef">Collection Job Deletion</a>
          </h4>
<p id="section-4.6.2-1">The Collector can send a DELETE request to the collection job, which indicates
to the Leader that it can abandon the collection job and discard state related
to it.<a href="#section-4.6.2-1" class="pilcrow">¶</a></p>
<p id="section-4.6.2-2">Aggregators <span class="bcp14">MUST NOT</span> delete information needed for replay or double collection
checks (<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>).<a href="#section-4.6.2-2" class="pilcrow">¶</a></p>
<div id="example-6">
<section id="section-4.6.2.1">
            <h5 id="name-example-7">
<a href="#section-4.6.2.1" class="section-number selfRef">4.6.2.1. </a><a href="#name-example-7" class="section-name selfRef">Example</a>
            </h5>
<div class="lang-http sourcecode" id="section-4.6.2.1-1">
<pre>
DELETE /leader/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  collection_jobs/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
</pre><a href="#section-4.6.2.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="collect-aggregate">
<section id="section-4.6.3">
          <h4 id="name-obtaining-aggregate-shares">
<a href="#section-4.6.3" class="section-number selfRef">4.6.3. </a><a href="#name-obtaining-aggregate-shares" class="section-name selfRef">Obtaining Aggregate Shares</a>
          </h4>
<p id="section-4.6.3-1">The Leader must compute its own aggregate share and obtain the Helper's
encrypted aggregate share before it can complete a collection job.<a href="#section-4.6.3-1" class="pilcrow">¶</a></p>
<p id="section-4.6.3-2">First, the Leader retrieves all batch buckets (<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>) associated
with this collection job. The batch buckets to retrieve depend on the batch mode
of this task:<a href="#section-4.6.3-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3-3.1">
              <p id="section-4.6.3-3.1.1">For time-interval (<a href="#time-interval-batch-mode" class="auto internal xref">Section 5.1</a>), this is all batch buckets
whose batch bucket identifiers are contained within the batch interval
specified in the <code>CollectionJobReq</code>'s query.<a href="#section-4.6.3-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-3.2">
              <p id="section-4.6.3-3.2.1">For leader-selected (<a href="#leader-selected-batch-mode" class="auto internal xref">Section 5.2</a>), this is the batch
bucket associated with the batch ID the Leader has chosen for this collection
job.<a href="#section-4.6.3-3.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.3-4">The Leader then combines the values inside the batch bucket as follows:<a href="#section-4.6.3-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3-5.1">
              <p id="section-4.6.3-5.1.1">Aggregate shares are combined via <code>Vdaf.merge(agg_param, agg_shares)</code> (see
<span>[<a href="#VDAF" class="cite xref">VDAF</a>], <a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-4.4" class="relref">Section 4.4</a></span>), where <code>agg_param</code> is the aggregation parameter
provided in the <code>CollectionJobReq</code>, and <code>agg_shares</code> are the (partial)
aggregate shares in the batch buckets. The result is the Leader aggregate
share for this collection job.<a href="#section-4.6.3-5.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-5.2">
              <p id="section-4.6.3-5.2.1">Report counts are combined via summing.<a href="#section-4.6.3-5.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-5.3">
              <p id="section-4.6.3-5.3.1">Checksums are combined via bitwise XOR.<a href="#section-4.6.3-5.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.3-6">A Helper aggregate share is identified by a 16-byte ID:<a href="#section-4.6.3-6" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.6.3-7">
<pre>
opaque AggregateShareID[16];
</pre><a href="#section-4.6.3-7" class="pilcrow">¶</a>
</div>
<p id="section-4.6.3-8">The Helper's aggregate share is an HTTP resource served by the Helper at the URL
<code>{helper}/tasks/{task-id}/aggregate_shares/{aggregate-share-id}</code>. To obtain it,
the Leader first chooses an aggregate share ID, which <span class="bcp14">MUST</span> be unique within the
scope of the corresponding DAP task.<a href="#section-4.6.3-8" class="pilcrow">¶</a></p>
<p id="section-4.6.3-9">Then the Leader sends a PUT request to the aggregate share with the body:<a href="#section-4.6.3-9" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.6.3-10">
<pre>
struct {
  BatchMode batch_mode;
  opaque config&lt;0..2^16-1&gt;;
} BatchSelector;

struct {
  BatchSelector batch_selector;
  opaque agg_param&lt;0..2^32-1&gt;;
  uint64 report_count;
  opaque checksum[32];
} AggregateShareReq;
</pre><a href="#section-4.6.3-10" class="pilcrow">¶</a>
</div>
<p id="section-4.6.3-11">The media type of <code>AggregateShareReq</code> is
"application/ppm-dap;message=aggregate-share-req". The structure contains the
following parameters:<a href="#section-4.6.3-11" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.3-12.1">
              <p id="section-4.6.3-12.1.1"><code>batch_selector</code>: The "batch selector", the contents of which depends on the
indicated batch mode (see <a href="#batch-modes" class="auto internal xref">Section 5</a>.<a href="#section-4.6.3-12.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-12.2">
              <p id="section-4.6.3-12.2.1"><code>agg_param</code>: The encoded aggregation parameter for the VDAF being executed.<a href="#section-4.6.3-12.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-12.3">
              <p id="section-4.6.3-12.3.1"><code>report_count</code>: The number number of reports included in the batch, as
computed above.<a href="#section-4.6.3-12.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.3-12.4">
              <p id="section-4.6.3-12.4.1"><code>checksum</code>: The batch checksum, as computed above.<a href="#section-4.6.3-12.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.3-13">The aggregate share request can be handled either asynchronously or
synchronously as described in <a href="#http-usage" class="auto internal xref">Section 3</a>. The representation of the share is
an <code>AggregateShare</code> (defined below).<a href="#section-4.6.3-13" class="pilcrow">¶</a></p>
<p id="section-4.6.3-14">The Helper first ensures that it recognizes the task ID. If not, it <span class="bcp14">MUST</span> fail
the job with error <code>unrecognizedTask</code>.<a href="#section-4.6.3-14" class="pilcrow">¶</a></p>
<p id="section-4.6.3-15">The indicated batch mode <span class="bcp14">MUST</span> match the task's batch mode. If not, the Helper
<span class="bcp14">MUST</span> fail the job with error <code>invalidMessage</code>.<a href="#section-4.6.3-15" class="pilcrow">¶</a></p>
<p id="section-4.6.3-16">If the <code>AggregateShareReq</code> is malformed, the Helper <span class="bcp14">MUST</span> fail the job with error
<code>invalidMessage</code>.<a href="#section-4.6.3-16" class="pilcrow">¶</a></p>
<p id="section-4.6.3-17">The Helper then verifies that the <code>BatchSelector</code> in the Leader's request
determines a batch that can be collected. If the selector does not identify a
valid set of batch buckets according to the criteria defined by the batch mode
in use (<a href="#batch-modes" class="auto internal xref">Section 5</a>), then the Helper <span class="bcp14">MUST</span> fail the job with error
<code>batchInvalid</code>.<a href="#section-4.6.3-17" class="pilcrow">¶</a></p>
<p id="section-4.6.3-18">If any of the batch buckets identified by the selector have already been
collected, then the Helper <span class="bcp14">MUST</span> fail the job with error <code>batchOverlap</code>.<a href="#section-4.6.3-18" class="pilcrow">¶</a></p>
<p id="section-4.6.3-19">If the number of validated reports in the batch is not equal to or greater than
the task's minimum batch size, then the Helper <span class="bcp14">MUST</span> abort with
<code>invalidBatchSize</code>.<a href="#section-4.6.3-19" class="pilcrow">¶</a></p>
<p id="section-4.6.3-20">The aggregation parameter <span class="bcp14">MUST</span> match the aggregation parameter used in
aggregation jobs pertaining to this batch. If not, the Helper <span class="bcp14">MUST</span> fail the job
with error <code>invalidMessage</code>.<a href="#section-4.6.3-20" class="pilcrow">¶</a></p>
<p id="section-4.6.3-21">Next, the Helper retrieves and combines the batch buckets associated with the
request using the same process used by the Leader (described at the beginning of
this section), arriving at its aggregate share, report count, and checksum
values. If the Helper's computed report count and checksum values do not match
the values provided in the <code>AggregateShareReq</code>, it <span class="bcp14">MUST</span> fail the job with error
<code>batchMismatch</code>.<a href="#section-4.6.3-21" class="pilcrow">¶</a></p>
<p id="section-4.6.3-22">The Helper then encrypts <code>agg_share</code> under the Collector's HPKE public key as
described in <a href="#aggregate-share-encrypt" class="auto internal xref">Section 4.6.6</a>, yielding <code>encrypted_agg_share</code>.
Encryption prevents the Leader from learning the actual result, as it only has
its own aggregate share and cannot compute the Helper's.<a href="#section-4.6.3-22" class="pilcrow">¶</a></p>
<p id="section-4.6.3-23">Once the Helper has encrypted its aggregate share, the aggregate share job is
ready. Its results are represented by an <code>AggregateShare</code>, with media type
"application/ppm-dap;message=aggregate-share":<a href="#section-4.6.3-23" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.6.3-24">
<pre>
struct {
  HpkeCiphertext encrypted_aggregate_share;
} AggregateShare;
</pre><a href="#section-4.6.3-24" class="pilcrow">¶</a>
</div>
<p id="section-4.6.3-25"><code>encrypted_aggregate_share.config_id</code> is set to the Collector's HPKE config ID.
<code>encrypted_aggregate_share.enc</code> is set to the encapsulated HPKE context <code>enc</code>
computed above and <code>encrypted_aggregate_share.ciphertext</code> is the ciphertext
<code>encrypted_agg_share</code> computed above.<a href="#section-4.6.3-25" class="pilcrow">¶</a></p>
<p id="section-4.6.3-26">After receiving the Helper's response, the Leader includes the HpkeCiphertext in
its response to the Collector (see <a href="#collect-finalization" class="auto internal xref">Section 4.6.5</a>).<a href="#section-4.6.3-26" class="pilcrow">¶</a></p>
<p id="section-4.6.3-27">Once an <code>AggregateShareReq</code> has been constructed for the batch determined by a
given query, the Helper considers the batch to be collected. The Helper <span class="bcp14">MUST NOT</span>
commit any more output shares to the batch. It is an error for the Leader to
issue any more aggregation jobs for additional reports that satisfy the query.
These reports <span class="bcp14">MUST</span> be rejected by the Helper as described in <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>.<a href="#section-4.6.3-27" class="pilcrow">¶</a></p>
<p id="section-4.6.3-28">Changing an aggregate share's parameters is illegal, so if there are further PUT
requests to the aggregate share with a different <code>AggregateShareReq</code>, the Helper
<span class="bcp14">MUST</span> abort with error <code>invalidMessage</code>.<a href="#section-4.6.3-28" class="pilcrow">¶</a></p>
<p id="section-4.6.3-29">Before completing the collection job, the Leader encrypts its aggregate share
under the Collector's HPKE public key as described in
<a href="#aggregate-share-encrypt" class="auto internal xref">Section 4.6.6</a>.<a href="#section-4.6.3-29" class="pilcrow">¶</a></p>
<div id="example-7">
<section id="section-4.6.3.1">
            <h5 id="name-example-8">
<a href="#section-4.6.3.1" class="section-number selfRef">4.6.3.1. </a><a href="#name-example-8" class="section-name selfRef">Example</a>
            </h5>
<p id="section-4.6.3.1-1">The Helper handles the aggregate share request synchronously:<a href="#section-4.6.3.1-1" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.6.3.1-2">
<pre>
PUT /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregate_shares/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=aggregate-share-req
Authorization: Bearer auth-token

encoded(struct {
  batch_selector = struct {
    batch_mode = BatchMode.time_interval,
    config = encoded(struct {
      batch_interval = struct {
        start = 1659544,
        duration = 10,
      } Interval,
    } TimeIntervalBatchSelectorConfig),
  } BatchSelector,
  agg_param = [0x00, 0x01, ...],
  report_count = 1000,
  checksum = [0x0a, 0x0b, ..., 0x0f],
} AggregateShareReq)

HTTP/1.1 200
Content-Type: application/ppm-dap;message=aggregate-share

encoded(struct {
  encrypted_aggregate_share = struct { ... } HpkeCiphertext,
} AggregateShare)
</pre><a href="#section-4.6.3.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.6.3.1-3">Or asynchronously:<a href="#section-4.6.3.1-3" class="pilcrow">¶</a></p>
<div class="lang-http sourcecode" id="section-4.6.3.1-4">
<pre>
PUT /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregate_shares/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Content-Type: application/ppm-dap;message=aggregate-share-req
Authorization: Bearer auth-token

encoded(struct {
  batch_selector = struct {
    batch_mode = BatchMode.time_interval,
    config = encoded(struct {
      batch_interval = struct {
        start = 1659544,
        duration = 10,
      } Interval,
    } TimeIntervalBatchSelectorConfig),
  } BatchSelector,
  agg_param = [0x00, 0x01, ...],
  report_count = 1000,
  checksum = [0x0a, 0x0b, ..., 0x0f],
} AggregateShareReq)

HTTP/1.1 200
Retry-After: 300

GET /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregate_shares/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Retry-After: 300

GET /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregate_shares/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
Content-Type: application/ppm-dap;message=aggregate-share

encoded(struct {
  encrypted_aggregate_share = struct { ... } HpkeCiphertext,
} AggregateShare)
</pre><a href="#section-4.6.3.1-4" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="aggregate-share-deletion">
<section id="section-4.6.4">
          <h4 id="name-aggregate-share-deletion">
<a href="#section-4.6.4" class="section-number selfRef">4.6.4. </a><a href="#name-aggregate-share-deletion" class="section-name selfRef">Aggregate Share Deletion</a>
          </h4>
<p id="section-4.6.4-1">The Leader can send a DELETE request to the aggregate share, which indicates to
the Helper that it can abandon the aggregate share and discard state related to
it.<a href="#section-4.6.4-1" class="pilcrow">¶</a></p>
<p id="section-4.6.4-2">Aggregators <span class="bcp14">MUST NOT</span> delete information needed for replay or double collection
checks (<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>).<a href="#section-4.6.4-2" class="pilcrow">¶</a></p>
<div id="example-8">
<section id="section-4.6.4.1">
            <h5 id="name-example-9">
<a href="#section-4.6.4.1" class="section-number selfRef">4.6.4.1. </a><a href="#name-example-9" class="section-name selfRef">Example</a>
            </h5>
<div class="lang-http sourcecode" id="section-4.6.4.1-1">
<pre>
DELETE /helper/tasks/8BY0RzZMzxvA46_8ymhzycOB9krN-QIGYvg_RsByGec/\
  aggregate_shares/lc7aUeGpdSNosNlh-UZhKA
Host: example.com
Authorization: Bearer auth-token

HTTP/1.1 200
</pre><a href="#section-4.6.4.1-1" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="collect-finalization">
<section id="section-4.6.5">
          <h4 id="name-collection-job-finalization">
<a href="#section-4.6.5" class="section-number selfRef">4.6.5. </a><a href="#name-collection-job-finalization" class="section-name selfRef">Collection Job Finalization</a>
          </h4>
<p id="section-4.6.5-1">Once the Collector has received a collection job from the Leader, it can decrypt
the aggregate shares and produce an aggregate result. The Collector decrypts
each aggregate share as described in <a href="#aggregate-share-encrypt" class="auto internal xref">Section 4.6.6</a>. Once the
Collector successfully decrypts all aggregate shares, it unshards the aggregate
shares into an aggregate result using the VDAF's <code>unshard</code> algorithm.<a href="#section-4.6.5-1" class="pilcrow">¶</a></p>
<p id="section-4.6.5-2">Let <code>leader_agg_share</code> denote the Leader's aggregate share, <code>helper_agg_share</code>
denote the Helper's aggregate share, <code>report_count</code> denote the report count sent
by the Leader, and <code>agg_param</code> denote the opaque aggregation parameter. The
final aggregate result is computed as follows:<a href="#section-4.6.5-2" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.6.5-3">
<pre>
agg_result = Vdaf.unshard(agg_param,
                          [leader_agg_share, helper_agg_share],
                          report_count)
</pre><a href="#section-4.6.5-3" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="aggregate-share-encrypt">
<section id="section-4.6.6">
          <h4 id="name-aggregate-share-encryption">
<a href="#section-4.6.6" class="section-number selfRef">4.6.6. </a><a href="#name-aggregate-share-encryption" class="section-name selfRef">Aggregate Share Encryption</a>
          </h4>
<p id="section-4.6.6-1">Encrypting an aggregate share <code>agg_share</code> for a given <code>AggregateShareReq</code> is
done as follows:<a href="#section-4.6.6-1" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.6.6-2">
<pre>
(enc, payload) = SealBase(
    pk,
    "dap-17 aggregate share" || server_role || 0x00,
    agg_share_aad,
    agg_share)
</pre><a href="#section-4.6.6-2" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.6.6-3.1">
              <p id="section-4.6.6-3.1.1"><code>pk</code> is the Collector's HPKE public key<a href="#section-4.6.6-3.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-3.2">
              <p id="section-4.6.6-3.2.1"><code>server_role</code> is the Role of the encrypting server (<code>0x02</code> for the Leader and
<code>0x03</code> for a Helper)<a href="#section-4.6.6-3.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-3.3">
              <p id="section-4.6.6-3.3.1"><code>0x00</code> represents the Role of the recipient (always the Collector)<a href="#section-4.6.6-3.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-3.4">
              <p id="section-4.6.6-3.4.1"><code>agg_share_aad</code> is an <code>AggregateShareAad</code> (defined below).<a href="#section-4.6.6-3.4.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.6-4">The <code>SealBase()</code> function is as specified in <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-6.1" class="relref">Section 6.1</a></span> for the
ciphersuite indicated by the HPKE configuration.<a href="#section-4.6.6-4" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-4.6.6-5">
<pre>
struct {
  TaskID task_id;
  opaque agg_param&lt;0..2^32-1&gt;;
  BatchSelector batch_selector;
} AggregateShareAad;
</pre><a href="#section-4.6.6-5" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.6.6-6.1">
              <p id="section-4.6.6-6.1.1"><code>task_id</code> is the ID of the task the aggregate share was computed in.<a href="#section-4.6.6-6.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-6.2">
              <p id="section-4.6.6-6.2.1"><code>agg_param</code> is the aggregation parameter used to compute the aggregate share.<a href="#section-4.6.6-6.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-6.3">
              <p id="section-4.6.6-6.3.1"><code>batch_selector</code> is the is the batch selector from the <code>AggregateShareReq</code>
(for the Helper) or the batch selector computed from the Collector's query
(for the Leader).<a href="#section-4.6.6-6.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-4.6.6-7">The Collector decrypts these aggregate shares using the opposite process.
Specifically, given an encrypted input share, denoted <code>enc_share</code>, for a given
batch selector, decryption works as follows:<a href="#section-4.6.6-7" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-4.6.6-8">
<pre>
agg_share = OpenBase(
    enc_share.enc,
    sk,
    "dap-17 aggregate share" || server_role || 0x00,
    agg_share_aad,
    enc_share.payload)
</pre><a href="#section-4.6.6-8" class="pilcrow">¶</a>
</div>
<ul class="normal">
<li class="normal" id="section-4.6.6-9.1">
              <p id="section-4.6.6-9.1.1"><code>sk</code> is the HPKE secret key<a href="#section-4.6.6-9.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-9.2">
              <p id="section-4.6.6-9.2.1"><code>server_role</code> is the Role of the server that sent the aggregate share (<code>0x02</code>
for the Leader and <code>0x03</code> for the Helper)<a href="#section-4.6.6-9.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-9.3">
              <p id="section-4.6.6-9.3.1"><code>0x00</code> represents the Role of the recipient (always the Collector)<a href="#section-4.6.6-9.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-4.6.6-9.4">
              <p id="section-4.6.6-9.4.1"><code>agg_share_aad</code> is an <code>AggregateShareAad</code> message constructed from the task ID
and the aggregation parameter in the collect request, and a batch selector.
The value of the batch selector used in <code>agg_share_aad</code> is determined by the
batch mode:<a href="#section-4.6.6-9.4.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.6.6-9.4.2.1">
                  <p id="section-4.6.6-9.4.2.1.1">For time-interval (<a href="#time-interval-batch-mode" class="auto internal xref">Section 5.1</a>), the batch selector is the
batch interval specified in the query.<a href="#section-4.6.6-9.4.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-4.6.6-9.4.2.2">
                  <p id="section-4.6.6-9.4.2.2.1">For leader-selected (<a href="#leader-selected-batch-mode" class="auto internal xref">Section 5.2</a>), the batch selector is
the batch ID sent in the response.<a href="#section-4.6.6-9.4.2.2.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
          </ul>
<p id="section-4.6.6-10">The <code>OpenBase()</code> function is as specified in <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-6.1" class="relref">Section 6.1</a></span> for the
ciphersuite indicated by the HPKE configuration.<a href="#section-4.6.6-10" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="batch-modes">
<section id="section-5">
      <h2 id="name-batch-modes">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-batch-modes" class="section-name selfRef">Batch Modes</a>
      </h2>
<p id="section-5-1">This section defines an initial set of batch modes for DAP. New batch modes may
be defined by future documents following the guidelines in
<a href="#extending-this-doc" class="auto internal xref">Section 10</a>.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">In protocol messages, batch modes are identified with a <code>BatchMode</code> value:<a href="#section-5-2" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5-3">
<pre>
enum {
  reserved(0),
  time_interval(1),
  leader_selected(2),
  (255)
} BatchMode;
</pre><a href="#section-5-3" class="pilcrow">¶</a>
</div>
<p id="section-5-4">Each batch mode specifies the following:<a href="#section-5-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5-5">
<li id="section-5-5.1">
          <p id="section-5-5.1.1">The value of the <code>config</code> field of <code>Query</code>, <code>PartialBatchSelector</code>, and
<code>BatchSelector</code><a href="#section-5-5.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-5-5.2">
          <p id="section-5-5.2.1">Batch buckets (<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>): how reports are assigned to batch
buckets; how each bucket is identified; and how batch buckets are mapped to
batches<a href="#section-5-5.2.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<div id="time-interval-batch-mode">
<section id="section-5.1">
        <h3 id="name-time-interval">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-time-interval" class="section-name selfRef">Time Interval</a>
        </h3>
<p id="section-5.1-1">The time-interval batch mode is designed to support applications in which
reports are grouped by an interval of time. The Collector specifies a "batch
interval" into which report timestamps must fall.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2">The Collector can issue queries whose batch intervals are continuous,
monotonically increasing, and have the same duration. For example, the following
sequence of batch intervals satisfies these conditions:<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.1-3">
<pre>
[
  struct {
    start = 1659544,
    duration = 1,
  } Interval,
  struct {
    start = 1659545,
    duration = 1,
  } Interval,
  struct {
    start = 1659546,
    duration = 1,
  } Interval,
  struct {
    start = 1659547,
    duration = 1,
  } Interval,
]
</pre><a href="#section-5.1-3" class="pilcrow">¶</a>
</div>
<p id="section-5.1-4">However, this is not a requirement: the Collector may decide to issue queries
out-of-order. In addition, the Collector may need to vary the duration to adjust
to changing report upload rates.<a href="#section-5.1-4" class="pilcrow">¶</a></p>
<div id="query-configuration">
<section id="section-5.1.1">
          <h4 id="name-query-configuration">
<a href="#section-5.1.1" class="section-number selfRef">5.1.1. </a><a href="#name-query-configuration" class="section-name selfRef">Query Configuration</a>
          </h4>
<p id="section-5.1.1-1">The payload of <code>Query.config</code> is<a href="#section-5.1.1-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.1.1-2">
<pre>
struct {
  Interval batch_interval;
} TimeIntervalQueryConfig;
</pre><a href="#section-5.1.1-2" class="pilcrow">¶</a>
</div>
<p id="section-5.1.1-3">where <code>batch_interval</code> is the batch interval requested by the Collector. The
interval <span class="bcp14">MUST</span> be well-formed as specified in <a href="#timestamps" class="auto internal xref">Section 4.1.1</a>. Otherwise, the
query does not specify a set of valid batch buckets.<a href="#section-5.1.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="partial-batch-selector-configuration">
<section id="section-5.1.2">
          <h4 id="name-partial-batch-selector-conf">
<a href="#section-5.1.2" class="section-number selfRef">5.1.2. </a><a href="#name-partial-batch-selector-conf" class="section-name selfRef">Partial Batch Selector Configuration</a>
          </h4>
<p id="section-5.1.2-1">The payload of <code>PartialBatchSelector.config</code> is empty.<a href="#section-5.1.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="batch-selector-configuration">
<section id="section-5.1.3">
          <h4 id="name-batch-selector-configuratio">
<a href="#section-5.1.3" class="section-number selfRef">5.1.3. </a><a href="#name-batch-selector-configuratio" class="section-name selfRef">Batch Selector Configuration</a>
          </h4>
<p id="section-5.1.3-1">The payload of <code>BatchSelector.config</code> is<a href="#section-5.1.3-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.1.3-2">
<pre>
struct {
  Interval batch_interval;
} TimeIntervalBatchSelectorConfig;
</pre><a href="#section-5.1.3-2" class="pilcrow">¶</a>
</div>
<p id="section-5.1.3-3">where <code>batch_interval</code> is the batch interval requested by the Collector.<a href="#section-5.1.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="time-interval-batch-buckets">
<section id="section-5.1.4">
          <h4 id="name-batch-buckets-2">
<a href="#section-5.1.4" class="section-number selfRef">5.1.4. </a><a href="#name-batch-buckets-2" class="section-name selfRef">Batch Buckets</a>
          </h4>
<p id="section-5.1.4-1">Each batch bucket is identified by an <code>Interval</code> whose duration is equal to the
task's <code>time_precision</code>. The identifier associated with a given report is the
unique such interval containing the timestamp of the report. For example, if
the task's <code>time_precision</code> is 1000 seconds and the report was generated at
1729629081 seconds after the start of the UNIX epoch, the relevant batch
bucket identifier is<a href="#section-5.1.4-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.1.4-2">
<pre>
struct {
  start = 1729629,
  duration = 1,
} Interval
</pre><a href="#section-5.1.4-2" class="pilcrow">¶</a>
</div>
<p id="section-5.1.4-3">The <code>Query</code> received by the Leader or <code>BatchSelector</code> received by the Helper
determines a valid set of batch bucket identifiers if the batch interval's
duration is greater than or equal to the task's <code>time_precision</code>.<a href="#section-5.1.4-3" class="pilcrow">¶</a></p>
<p id="section-5.1.4-4">A batch consists of a sequence of contiguous batch buckets. That is, the set of
batch bucket identifiers for the batch interval is<a href="#section-5.1.4-4" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.1.4-5">
<pre>
[
  struct {
    start = batch_interval.start,
    duration = 1,
  } Interval,
  struct {
    start = batch_interval.start + 1,
    duration = 1,
  } Interval,
  ...
  struct {
    start = batch_interval.start + batch_interval.duration - 1,
    duration = 1,
  } Interval,
]
</pre><a href="#section-5.1.4-5" class="pilcrow">¶</a>
</div>
</section>
</div>
</section>
</div>
<div id="leader-selected-batch-mode">
<section id="section-5.2">
        <h3 id="name-leader-selected-batch-mode">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-leader-selected-batch-mode" class="section-name selfRef">Leader-selected Batch Mode</a>
        </h3>
<p id="section-5.2-1">The leader-selected batch mode is used when it is acceptable for the Leader to
arbitrarily batch reports. Each batch is identified by an opaque "batch ID"
chosen by the Leader, which <span class="bcp14">MUST</span> be unique in the scope of the task.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.2-2">
<pre>
opaque BatchID[32];
</pre><a href="#section-5.2-2" class="pilcrow">¶</a>
</div>
<p id="section-5.2-3">The Collector will not know the set of batch IDs available for collection. To
get the aggregate of a batch, the Collector issues a query for the next
available batch. The Leader selects a recent batch to aggregate which <span class="bcp14">MUST NOT</span>
yet have been associated with a collection job.<a href="#section-5.2-3" class="pilcrow">¶</a></p>
<p id="section-5.2-4">The Aggregators can output batches of any size that is larger than or equal to
the task's minimum batch size. The target batch size, if any, is
implementation-specific, and may be equal to or greater than the minimum batch
size. Deciding how soon batches should be output is also
implementation-specific. Exactly sizing batches may be challenging for Leader
deployments in which multiple, independent nodes running the aggregate
interaction (see <a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>) need to be coordinated.<a href="#section-5.2-4" class="pilcrow">¶</a></p>
<div id="query-configuration-1">
<section id="section-5.2.1">
          <h4 id="name-query-configuration-2">
<a href="#section-5.2.1" class="section-number selfRef">5.2.1. </a><a href="#name-query-configuration-2" class="section-name selfRef">Query Configuration</a>
          </h4>
<p id="section-5.2.1-1">They payload of <code>Query.config</code> is empty. The request merely indicates the
Collector would like the next batch selected by the Leader.<a href="#section-5.2.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="partial-batch-selector-configuration-1">
<section id="section-5.2.2">
          <h4 id="name-partial-batch-selector-confi">
<a href="#section-5.2.2" class="section-number selfRef">5.2.2. </a><a href="#name-partial-batch-selector-confi" class="section-name selfRef">Partial Batch Selector Configuration</a>
          </h4>
<p id="section-5.2.2-1">The payload of <code>PartialBatchSelector.config</code> is:<a href="#section-5.2.2-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.2.2-2">
<pre>
struct {
  BatchID batch_id;
} LeaderSelectedPartialBatchSelectorConfig;
</pre><a href="#section-5.2.2-2" class="pilcrow">¶</a>
</div>
<p id="section-5.2.2-3">where <code>batch_id</code> is the batch ID selected by the Leader.<a href="#section-5.2.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="batch-selector-configuration-1">
<section id="section-5.2.3">
          <h4 id="name-batch-selector-configuration">
<a href="#section-5.2.3" class="section-number selfRef">5.2.3. </a><a href="#name-batch-selector-configuration" class="section-name selfRef">Batch Selector Configuration</a>
          </h4>
<p id="section-5.2.3-1">The payload of <code>BatchSelector.config</code> is:<a href="#section-5.2.3-1" class="pilcrow">¶</a></p>
<div class="lang-tls-presentation sourcecode" id="section-5.2.3-2">
<pre>
struct {
  BatchID batch_id;
} LeaderSelectedBatchSelectorConfig;
</pre><a href="#section-5.2.3-2" class="pilcrow">¶</a>
</div>
<p id="section-5.2.3-3">where <code>batch_id</code> is the batch ID selected by the Leader.<a href="#section-5.2.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="leader-selected-batch-buckets">
<section id="section-5.2.4">
          <h4 id="name-batch-buckets-3">
<a href="#section-5.2.4" class="section-number selfRef">5.2.4. </a><a href="#name-batch-buckets-3" class="section-name selfRef">Batch Buckets</a>
          </h4>
<p id="section-5.2.4-1">Each batch consists of a single bucket and is identified by the batch ID. A
report is assigned to the batch indicated by the <code>PartialBatchSelector</code> during
aggregation.<a href="#section-5.2.4-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="operational-capabilities">
<section id="section-6">
      <h2 id="name-operational-considerations">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-operational-considerations" class="section-name selfRef">Operational Considerations</a>
      </h2>
<p id="section-6-1">The DAP protocol has inherent constraints derived from the tradeoff between
privacy guarantees and computational complexity. These tradeoffs influence how
applications may choose to utilize services implementing the specification.<a href="#section-6-1" class="pilcrow">¶</a></p>
<div id="entity-capabilities">
<section id="section-6.1">
        <h3 id="name-protocol-participant-capabi">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-protocol-participant-capabi" class="section-name selfRef">Protocol Participant Capabilities</a>
        </h3>
<p id="section-6.1-1">The design in this document has different assumptions and requirements for
different protocol participants, including Clients, Aggregators, and Collectors.
This section describes these capabilities in more detail.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<div id="client-capabilities">
<section id="section-6.1.1">
          <h4 id="name-client-capabilities">
<a href="#section-6.1.1" class="section-number selfRef">6.1.1. </a><a href="#name-client-capabilities" class="section-name selfRef">Client Capabilities</a>
          </h4>
<p id="section-6.1.1-1">Clients have limited capabilities and requirements. Their only inputs to the
protocol are (1) the parameters configured out of band and (2) a measurement.
Clients are not expected to store any state across any upload flows, nor are
they required to implement any sort of report upload retry mechanism. By design,
the protocol in this document is robust against individual Client upload
failures since the protocol output is an aggregate over all inputs.<a href="#section-6.1.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="aggregator-capabilities">
<section id="section-6.1.2">
          <h4 id="name-aggregator-capabilities">
<a href="#section-6.1.2" class="section-number selfRef">6.1.2. </a><a href="#name-aggregator-capabilities" class="section-name selfRef">Aggregator Capabilities</a>
          </h4>
<p id="section-6.1.2-1">Leaders and Helpers have different operational requirements. The design in this
document assumes an operationally competent Leader, i.e., one that has no
storage or computation limitations or constraints, but only a modestly
provisioned Helper, i.e., one that has computation, bandwidth, and storage
constraints. By design, Leaders must be at least as capable as Helpers, where
Helpers are generally required to:<a href="#section-6.1.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1.2-2.1">
              <p id="section-6.1.2-2.1.1">Support the aggregate interaction, which includes validating and aggregating
reports; and<a href="#section-6.1.2-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.2-2.2">
              <p id="section-6.1.2-2.2.1">Publish and manage an HPKE configuration that can be used for the upload
interaction.<a href="#section-6.1.2-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.2-2.3">
              <p id="section-6.1.2-2.3.1">Implement some form of batch-to-report index, as well as inter- and
intra-batch replay mitigation storage, which includes some way of tracking
batch report size. Some of this state may be used for replay attack
mitigation. The replay mitigation strategy is described in
<a href="#input-share-validation" class="auto internal xref">Section 4.5.2.4</a>.<a href="#section-6.1.2-2.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-6.1.2-3">Beyond the minimal capabilities required of Helpers, Leaders are generally
required to:<a href="#section-6.1.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.1.2-4.1">
              <p id="section-6.1.2-4.1.1">Support the upload interaction and store reports; and<a href="#section-6.1.2-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.2-4.2">
              <p id="section-6.1.2-4.2.1">Track batch report size during each collect flow and request encrypted output
shares from Helpers.<a href="#section-6.1.2-4.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.1.2-4.3">
              <p id="section-6.1.2-4.3.1">Implement and store state for the form of inter- and intra-batch replay
mitigation in <a href="#agg-flow" class="auto internal xref">Figure 7</a>. This requires storing the report IDs of all
reports processed for a given task. Implementations may find it helpful to
track additional information, like the timestamp, so that the storage used
for anti-replay can be sharded efficiently.<a href="#section-6.1.2-4.3.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
<div id="collector-capabilities">
<section id="section-6.1.3">
          <h4 id="name-collector-capabilities">
<a href="#section-6.1.3" class="section-number selfRef">6.1.3. </a><a href="#name-collector-capabilities" class="section-name selfRef">Collector Capabilities</a>
          </h4>
<p id="section-6.1.3-1">Collectors statefully interact with Aggregators to produce an aggregate output.
Their input to the protocol is the task parameters, configured out of band,
which include the corresponding batch window and size. For each collect
invocation, Collectors are required to keep state from the start of the protocol
to the end as needed to produce the final aggregate output.<a href="#section-6.1.3-1" class="pilcrow">¶</a></p>
<p id="section-6.1.3-2">Collectors must also maintain state for the lifetime of each task, which
includes key material associated with the HPKE key configuration.<a href="#section-6.1.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="vdafs-and-compute-requirements">
<section id="section-6.2">
        <h3 id="name-vdafs-and-compute-requireme">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-vdafs-and-compute-requireme" class="section-name selfRef">VDAFs and Compute Requirements</a>
        </h3>
<p id="section-6.2-1">The choice of VDAF can impact the computation and storage required for a DAP
task:<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.2-2.1">
            <p id="section-6.2-2.1.1">The runtime of VDAF sharding and verification is related to the "size" of the
underlying measurements. For example, the Prio3SumVec VDAF defined in
<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-7" class="relref">Section 7</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span> requires each measurement to be a vector of the same
length, which all parties need to agree on prior to VDAF execution. The
computation required for such tasks increases linearly as a function of the
chosen length, as each vector element must be processed in turn.<a href="#section-6.2-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.2-2.2">
            <p id="section-6.2-2.2.1">The runtime of VDAF verification is related to the size of the aggregation
parameter. For example for Poplar1 defined in <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-8" class="relref">Section 8</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>,
verification takes as input a sequence of so-called "candidate prefixes", and
the amount of computation is linear in the number of prefixes.<a href="#section-6.2-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-6.2-2.3">
            <p id="section-6.2-2.3.1">The storage requirements for aggregate shares vary depending on the size of
the measurements and/or the aggregation parameter.<a href="#section-6.2-2.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-6.2-3">To account for these factors, care must be taken that a DAP deployment can
handle VDAF execution of all possible configurations for any tasks which the
deployment may be configured for. Otherwise, an attacker may deny service by
uploading many expensive reports to a suitably-configured VDAF.<a href="#section-6.2-3" class="pilcrow">¶</a></p>
<p id="section-6.2-4">The varying cost of VDAF computation means that Aggregators should negotiate
reasonable limits for each VDAF configuration, out of band with the protocol.
For example, Aggregators may agree on a maximum size for an aggregation job or
on a maximum rate of incoming reports.<a href="#section-6.2-4" class="pilcrow">¶</a></p>
<p id="section-6.2-5">Applications which require computationally-expensive VDAFs can mitigate the
computation cost of aggregation in a few ways, such as producing aggregates over
a sample of the data or choosing a representation of the data permitting a
simpler aggregation scheme.<a href="#section-6.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="aggregation-utility-and-soft-batch-deadlines">
<section id="section-6.3">
        <h3 id="name-aggregation-utility-and-sof">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-aggregation-utility-and-sof" class="section-name selfRef">Aggregation Utility and Soft Batch Deadlines</a>
        </h3>
<p id="section-6.3-1">A soft real-time system should produce a response within a deadline to be
useful. This constraint may be relevant when the value of an aggregate decreases
over time. A missed deadline can reduce an aggregate's utility but not
necessarily cause failure in the system.<a href="#section-6.3-1" class="pilcrow">¶</a></p>
<p id="section-6.3-2">An example of a soft real-time constraint is the expectation that input data can
be verified and aggregated in a period equal to data collection, given some
computational budget. Meeting these deadlines will require efficient
implementations of the VDAF. Applications might batch requests or utilize more
efficient serialization to improve throughput.<a href="#section-6.3-2" class="pilcrow">¶</a></p>
<p id="section-6.3-3">Some applications may be constrained by the time that it takes to reach a
privacy threshold defined by a minimum number of reports. One possible solution
is to increase the reporting period so more samples can be collected, balanced
against the urgency of responding to a soft deadline.<a href="#section-6.3-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="protocol-specific-optimizations">
<section id="section-6.4">
        <h3 id="name-protocol-specific-optimizat">
<a href="#section-6.4" class="section-number selfRef">6.4. </a><a href="#name-protocol-specific-optimizat" class="section-name selfRef">Protocol-specific Optimizations</a>
        </h3>
<p id="section-6.4-1">Not all DAP tasks have the same operational requirements, so the protocol is
designed to allow implementations to reduce operational costs in certain cases.<a href="#section-6.4-1" class="pilcrow">¶</a></p>
<div id="sharding-storage">
<section id="section-6.4.1">
          <h4 id="name-reducing-storage-requiremen">
<a href="#section-6.4.1" class="section-number selfRef">6.4.1. </a><a href="#name-reducing-storage-requiremen" class="section-name selfRef">Reducing Storage Requirements</a>
          </h4>
<p id="section-6.4.1-1">In general, the Aggregators are required to keep state for tasks and all valid
reports for as long as collection requests can be made for them. However, it is
not necessary to store the complete reports. Each Aggregator only needs to
store an aggregate share for each possible batch bucket i.e., the batch
interval for time-interval or batch ID for leader-selected, along with a flag
indicating whether the aggregate share has been collected. This is due to the
requirement for queries to respect bucket boundaries. See <a href="#batch-modes" class="auto internal xref">Section 5</a>.<a href="#section-6.4.1-1" class="pilcrow">¶</a></p>
<p id="section-6.4.1-2">However, Aggregators are also required to implement several per-report checks
that require retaining a number of data artifacts. For example, to detect replay
attacks, it is necessary for each Aggregator to retain the set of report IDs of
reports that have been aggregated for the task so far. Depending on the task
lifetime and report upload rate, this can result in high storage costs. To
alleviate this burden, DAP allows Aggregators to drop this state as needed, so
long as reports are dropped properly as described in <a href="#input-share-validation" class="auto internal xref">Section 4.5.2.4</a>.
Aggregators <span class="bcp14">SHOULD</span> take steps to mitigate the risk of dropping reports (e.g., by
evicting the oldest data first).<a href="#section-6.4.1-2" class="pilcrow">¶</a></p>
<p id="section-6.4.1-3">Furthermore, the Aggregators must store data related to a task as long as the
current time is not after this task's <code>task_interval</code>. Aggregators <span class="bcp14">MAY</span> delete
the task and all data pertaining to this task after the <code>task_interval</code>.
Implementors <span class="bcp14">SHOULD</span> provide for some leeway so the Collector can collect the
batch after some delay.<a href="#section-6.4.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="distributed-systems">
<section id="section-6.4.2">
          <h4 id="name-distributed-systems-and-syn">
<a href="#section-6.4.2" class="section-number selfRef">6.4.2. </a><a href="#name-distributed-systems-and-syn" class="section-name selfRef">Distributed Systems and Synchronization Concerns</a>
          </h4>
<p id="section-6.4.2-1">Various parts of a DAP implementation will need to synchronize in order to
ensure correctness during concurrent operation. This section describes the
relevant concerns and makes suggestions as to potential implementation
tradeoffs.<a href="#section-6.4.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.4.2-2.1">
              <p id="section-6.4.2-2.1.1">The upload interaction requires the Leader to discard uploaded reports with a
duplicated ID, including concurrently-uploaded reports. This might be
implemented by synchronization or via an eventually-consistent process. If the
Leader wishes to alert the Client with a <code>reportRejected</code> error,
synchronization will be necessary to ensure all but one concurrent request
receive the error.<a href="#section-6.4.2-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.4.2-2.2">
              <p id="section-6.4.2-2.2.1">The Leader is responsible for generating aggregation jobs, and will generally
want to place each report in exactly one aggregation job. (The only event in
which a Leader can place a report in multiple aggregation jobs is if the
Helper rejects the report with <code>report_too_early</code>, in which case the Leader
can place the report into a later aggregation job.) This may require
synchronization between different components of the system which are
generating aggregation jobs. Note that placing a report into more than one
aggregation job will result in a loss of throughput, rather than a loss of
correctness, privacy, or verifiability, so it is acceptable for
implementations to use an eventually-consistent scheme which may rarely place
a report into multiple aggregation jobs.<a href="#section-6.4.2-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.4.2-2.3">
              <p id="section-6.4.2-2.3.1">Aggregation is implemented as a sequence of aggregation steps by both the
Leader and the Helper. The Leader must ensure that each aggregation job is
only processed once concurrently, which may require synchronization between
the components responsible for performing aggregation. The Helper must ensure
that concurrent requests against the same aggregation job are handled
appropriately, which requires synchronization between the components handling
aggregation requests.<a href="#section-6.4.2-2.3.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.4.2-2.4">
              <p id="section-6.4.2-2.4.1">Aggregation requires checking and updating used-report storage as part of
implementing replay protection. This must be done while processing the
aggregation job, though which steps the checks are performed at is up to the
implementation. The checks and storage require synchronization, so that if two
aggregation jobs containing the same report are processed, at most one
instance of the report will be aggregated. However, the interaction with the
used-report storage does not necessarily have to be synchronized with the
processing and storage for the remainder of the aggregation process. For
example, used-report storage could be implemented in a separate datastore than
is used for the remainder of data storage, without any transactionality
between updates to the two datastores.<a href="#section-6.4.2-2.4.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-6.4.2-2.5">
              <p id="section-6.4.2-2.5.1">The aggregation and collection interactions require synchronization to avoid
modifying the aggregate of a batch after it has already been collected. Any
reports being aggregated which pertain to a batch which has already been
collected must fail with a <code>batch_collected</code> error; correctly determining this
requires synchronizing aggregation with the completion of collection jobs (for
the Leader) or aggregate share requests (for the Helper). Also, the Leader
must complete all outstanding aggregation jobs for a batch before requesting
aggregate shares from the Helper, again requiring synchronization between the
Leader's collection and aggregation interactions. Further, the Helper must
determine the aggregated report count and checksum of aggregated report IDs
before responding to an aggregate share request, requiring synchronization
between the Helper's collection and aggregation interactions.<a href="#section-6.4.2-2.5.1" class="pilcrow">¶</a></p>
</li>
          </ul>
</section>
</div>
<div id="streaming-messages">
<section id="section-6.4.3">
          <h4 id="name-streaming-messages">
<a href="#section-6.4.3" class="section-number selfRef">6.4.3. </a><a href="#name-streaming-messages" class="section-name selfRef">Streaming Messages</a>
          </h4>
<p id="section-6.4.3-1">Most messages in the protocol contain only fixed-length or length-prefixed
fields such that they can be parsed independently of context. The exceptions are
the <code>UploadReq</code>, <code>UploadErrors</code> (<a href="#upload-request" class="auto internal xref">Section 4.4.2</a>), <code>AggregationJobInitReq</code>,
<code>AggregationJobContinueReq</code>, and <code>AggregationJobResp</code> (<a href="#aggregate-flow" class="auto internal xref">Section 4.5</a>)
messages, all of which contain vectors whose length is determined by the length
of the enclosing HTTP message.<a href="#section-6.4.3-1" class="pilcrow">¶</a></p>
<p id="section-6.4.3-2">This allows implementations to stream these messages, that is, to begin sending
them before knowing how long they will ultimately be. This is useful if
implementations wish to avoid buffering exceptionally large messages in memory,
or do not know how long a vector will be when they start sending.<a href="#section-6.4.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="compliance">
<section id="section-7">
      <h2 id="name-compliance-requirements">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-compliance-requirements" class="section-name selfRef">Compliance Requirements</a>
      </h2>
<p id="section-7-1">In the absence of an application or deployment-specific profile specifying
otherwise, a compliant DAP application <span class="bcp14">MUST</span> implement the following HPKE cipher
suite:<a href="#section-7-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7-2.1">
          <p id="section-7-2.1.1">KEM: DHKEM(X25519, HKDF-SHA256) (see <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-7.1" class="relref">Section 7.1</a></span>)<a href="#section-7-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-7-2.2">
          <p id="section-7-2.2.1">KDF: HKDF-SHA256 (see <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-7.2" class="relref">Section 7.2</a></span>)<a href="#section-7-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-7-2.3">
          <p id="section-7-2.3.1">AEAD: AES-128-GCM (see <span>[<a href="#HPKE" class="cite xref">HPKE</a>], <a href="https://rfc-editor.org/rfc/rfc9180#section-7.3" class="relref">Section 7.3</a></span>)<a href="#section-7-2.3.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="sec-considerations">
<section id="section-8">
      <h2 id="name-security-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-8-1">DAP aims to achieve the privacy and verifiability security goals defined in
<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-9" class="relref">Section 9</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>. That is, an active attacker that controls a subset of
the Clients, one of the Aggregators, and the Collector learns nothing about the
honest Clients' measurements beyond their aggregate result. At the same time,
an attacker that controls a subset of Clients cannot force the Collector to
compute anything but the aggregate result over the honest Clients'
measurements.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">Since DAP requires HTTPS (<a href="#http-usage" class="auto internal xref">Section 3</a>), the attacker cannot tamper with
messages delivered by honest parties or forge messages from honest,
authenticated parties; but it can drop messages or forge messages from
unauthenticated parties. Thus there are some threats that DAP does not defend
against and which are considered outside of its threat model. These and others
are enumerated below, along with potential mitigations.<a href="#section-8-2" class="pilcrow">¶</a></p>
<p id="section-8-3">Attacks on verifiability:<a href="#section-8-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8-4">
<li id="section-8-4.1">
          <p id="section-8-4.1.1">Aggregators can change the result by an arbitrary amount by emitting
incorrect aggregate shares, by omitting reports from the aggregation
process, or by manipulating the VDAF verification process for a single
report. Like the underlying VDAF, DAP only ensures correct computation of
the aggregate result if both Aggregators honestly execute the protocol.<a href="#section-8-4.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-8-4.2">
          <p id="section-8-4.2.1">Clients may affect the quality of aggregate results by reporting false
measurements. A VDAF can only verify that a submitted measurement is valid,
not that it is true.<a href="#section-8-4.2.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-8-4.3">
          <p id="section-8-4.3.1">An attacker can impersonate multiple Clients, or a single malicious Client
can upload an unexpectedly-large number of reports, in order to skew
aggregate results or to reduce the number of measurements from honest Clients
in a batch below the minimum batch size. See <a href="#sybil" class="auto internal xref">Section 8.1</a> for discussion and
potential mitigations.<a href="#section-8-4.3.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-8-5">Attacks on privacy:<a href="#section-8-5" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8-6">
<li id="section-8-6.1">
          <p id="section-8-6.1.1">Clients can intentionally leak their own measurements and compromise their
own privacy.<a href="#section-8-6.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-8-6.2">
          <p id="section-8-6.2.1">Both Aggregators together can, purposefully or accidentally, share
unencrypted input shares in order to defeat the privacy of individual
reports. DAP follows VDAF in providing privacy only if at least one
Aggregator honestly follows the protocol.<a href="#section-8-6.2.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-8-7">Attacks on other properties of the system:<a href="#section-8-7" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8-8">
<li id="section-8-8.1">
          <p id="section-8-8.1.1">Both Aggregators together can, purposefully or accidentally, share
unencrypted aggregate shares in order to reveal the aggregation result for a
given batch.<a href="#section-8-8.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-8-8.2">
          <p id="section-8-8.2.1">Aggregators, or a passive network attacker between the Clients and the
Leader, can examine metadata such as HTTP client IP in order to infer which
Clients are submitting reports. Depending on the particulars of the
deployment, this may be used to infer sensitive information about the Client.
This can be mitigated for the Aggregator by deploying an anonymizing proxy
(see <a href="#anon-proxy" class="auto internal xref">Section 8.4</a>), or in general by requiring Clients to submit reports at
regular intervals independently of the measurement value such that the
existence of a report does not imply the occurrence of a sensitive event.<a href="#section-8-8.2.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-8-8.3">
          <p id="section-8-8.3.1">Aggregators can deny service by refusing to respond to collection requests or
aggregate share requests.<a href="#section-8-8.3.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-8-8.4">
          <p id="section-8-8.4.1">Some VDAFs could leak information to either Aggregator or the Collector
beyond what the protocol intended to learn. It may be possible to mitigate
such leakages using differential privacy (<a href="#dp" class="auto internal xref">Section 8.5</a>).<a href="#section-8-8.4.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<div id="sybil">
<section id="section-8.1">
        <h3 id="name-sybil-attacks">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-sybil-attacks" class="section-name selfRef">Sybil Attacks</a>
        </h3>
<p id="section-8.1-1">Several attacks on the security of the VDAF (<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-9" class="relref">Section 9</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>) involve
malicious Clients uploading reports that are valid under the chosen VDAF but
incorrect.<a href="#section-8.1-1" class="pilcrow">¶</a></p>
<p id="section-8.1-2">For example, a DAP deployment might be measuring the heights of a human
population and configure a variant of Prio3 to prove that measurements are
values in the range of 80-250 cm. A malicious Client would not be able to claim
a height of 400 cm, but they could submit multiple bogus reports inside the
acceptable range, which would yield incorrect averages. More generally, DAP
deployments are susceptible to Sybil attacks <span>[<a href="#Dou02" class="cite xref">Dou02</a>]</span>, especially when carried
out by the Leader.<a href="#section-8.1-2" class="pilcrow">¶</a></p>
<p id="section-8.1-3">In this type of attack, the adversary adds to a batch a number of reports that
skew the aggregate result in its favor. For example, sending known measurements
to the Aggregators can allow a Collector to shrink the effective anonymity set
by subtracting the known measurements from the aggregate result. The result may
reveal additional information about the honest measurements, leading to a
privacy violation; or the result may have some property that is desirable to the
adversary ("stats poisoning").<a href="#section-8.1-3" class="pilcrow">¶</a></p>
<p id="section-8.1-4">Depending on the deployment and the specific threat being mitigated, there are
different ways to address Sybil attacks, such as:<a href="#section-8.1-4" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.1-5">
<li id="section-8.1-5.1">
            <p id="section-8.1-5.1.1">Implementing Client authentication, as described in <a href="#client-auth" class="auto internal xref">Section 8.3</a>, likely
paired with rate-limiting uploads from individual Clients.<a href="#section-8.1-5.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-8.1-5.2">
            <p id="section-8.1-5.2.1">Removing Client-specific metadata on individual reports, such as through the
use of anonymizing proxies in the upload flow, as described in
<a href="#anon-proxy" class="auto internal xref">Section 8.4</a>.<a href="#section-8.1-5.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-8.1-5.3">
            <p id="section-8.1-5.3.1">Some mechanisms for differential privacy (<a href="#dp" class="auto internal xref">Section 8.5</a>) can help mitigate Sybil
attacks against privacy to some extent.<a href="#section-8.1-5.3.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
<div id="batch-selection">
<section id="section-8.2">
        <h3 id="name-batch-selection-attacks">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-batch-selection-attacks" class="section-name selfRef">Batch-selection Attacks</a>
        </h3>
<p id="section-8.2-1">Depending on the batch mode, the privacy of an individual Client may be
infringed upon by selection of the batch. For example, in the leader-selected
batch mode, the Leader is free to select the reports that compose a given batch
almost arbitrarily; a malicious Leader might choose a batch composed of reports
arriving from a single client. The aggregate derived from this batch might then
reveal information about that Client.<a href="#section-8.2-1" class="pilcrow">¶</a></p>
<p id="section-8.2-2">The mitigations for this attack are similar to those used for Sybil attacks
(<a href="#sybil" class="auto internal xref">Section 8.1</a>):<a href="#section-8.2-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.2-3">
<li id="section-8.2-3.1">
            <p id="section-8.2-3.1.1">Implementing Client authentication, as described in <a href="#client-auth" class="auto internal xref">Section 8.3</a>, and
having each aggregator verify that each batch contains reports from a
suitable number of distinct clients.<a href="#section-8.2-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-8.2-3.2">
            <p id="section-8.2-3.2.1">Disassociating each report from the Client which generated it, via the use of
anonymizing proxies (<a href="#anon-proxy" class="auto internal xref">Section 8.4</a>) or similar techniques.<a href="#section-8.2-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-8.2-3.3">
            <p id="section-8.2-3.3.1">Differential privacy (<a href="#dp" class="auto internal xref">Section 8.5</a>) can help mitigate the impact of this attack.<a href="#section-8.2-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li id="section-8.2-3.4">
            <p id="section-8.2-3.4.1">Deployment-specific mitigations may also be possible: for example, if every
Client is sending reports at a given rate, it may be possible for aggregators
to bound the accepted age of reports such that the number of aggregatable
reports from a given Client is small enough to effectively mitigate this
attack.<a href="#section-8.2-3.4.1" class="pilcrow">¶</a></p>
</li>
        </ol>
</section>
</div>
<div id="client-auth">
<section id="section-8.3">
        <h3 id="name-client-authentication">
<a href="#section-8.3" class="section-number selfRef">8.3. </a><a href="#name-client-authentication" class="section-name selfRef">Client Authentication</a>
        </h3>
<p id="section-8.3-1">In settings where it is practical for each Client to have an identity
provisioned (e.g., a user logged into a backend service or a hardware device
programmed with an identity), Client authentication can help Aggregators (or an
authenticating proxy deployed between Clients and the Aggregators; see
<a href="#anon-proxy" class="auto internal xref">Section 8.4</a>) ensure that all reports come from authentic Clients. Note that
because the Helper never handles messages directly from the Clients, reports
would need to include an extension (<a href="#report-extensions" class="auto internal xref">Section 4.4.3</a>) to convey
authentication information to the Helper. For example, a deployment might
include a Privacy Pass token (<span>[<a href="#RFC9576" class="cite xref">RFC9576</a>]</span>) in a report extension to allow both
Aggregators to independently verify the Client's identity.<a href="#section-8.3-1" class="pilcrow">¶</a></p>
<p id="section-8.3-2">However, in some deployments, it will not be practical to require Clients to
authenticate, so Client authentication is not mandatory in DAP. For example, a
widely distributed application that does not require its users to log in to any
service has no obvious way to authenticate its report uploads.<a href="#section-8.3-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="anon-proxy">
<section id="section-8.4">
        <h3 id="name-anonymizing-proxies">
<a href="#section-8.4" class="section-number selfRef">8.4. </a><a href="#name-anonymizing-proxies" class="section-name selfRef">Anonymizing Proxies</a>
        </h3>
<p id="section-8.4-1">Client reports may be transmitted alongside auxiliary information such as
source IP, HTTP user agent, or Client authentication information (in
deployments which use it, see <a href="#client-auth" class="auto internal xref">Section 8.3</a>). This metadata can be used by
Aggregators to identify participating Clients or permit some attacks on
verifiability. This auxiliary information can be removed by having Clients
submit reports to an anonymizing proxy server which would then use Oblivious
HTTP <span>[<a href="#RFC9458" class="cite xref">RFC9458</a>]</span> to forward reports to the DAP Leader. In this scenario, Client
authentication would be performed by the proxy rather than any of the
participants in the DAP protocol.<a href="#section-8.4-1" class="pilcrow">¶</a></p>
<p id="section-8.4-2">The report itself may contain deanonymizing information that cannot be removed
by a proxy:<a href="#section-8.4-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8.4-3.1">
            <p id="section-8.4-3.1.1">The report timestamp indicates when a report was generated and may help an
attacker to deduce which Client generated it. Truncating this timestamp as
described in <a href="#timestamps" class="auto internal xref">Section 4.1.1</a> can help.<a href="#section-8.4-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-8.4-3.2">
            <p id="section-8.4-3.2.1">The public extensions may help the attacker to profile the Client's
configuration.<a href="#section-8.4-3.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="dp">
<section id="section-8.5">
        <h3 id="name-differential-privacy">
<a href="#section-8.5" class="section-number selfRef">8.5. </a><a href="#name-differential-privacy" class="section-name selfRef">Differential Privacy</a>
        </h3>
<p id="section-8.5-1">DAP deployments can choose to ensure their aggregate results achieve
differential privacy (<span>[<a href="#Vad16" class="cite xref">Vad16</a>]</span>). A simple approach would require the
Aggregators to add two-sided noise (e.g. sampled from a two-sided geometric
distribution) to aggregate shares. Since each Aggregator is adding noise
independently, privacy can be guaranteed even if all but one of the Aggregators
is malicious. Differential privacy is a strong privacy definition, and protects
users in extreme circumstances: even if an adversary has prior knowledge of
every measurement in a batch except for one, that one measurement is still
formally protected.<a href="#section-8.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="task-parameters">
<section id="section-8.6">
        <h3 id="name-task-parameters">
<a href="#section-8.6" class="section-number selfRef">8.6. </a><a href="#name-task-parameters" class="section-name selfRef">Task Parameters</a>
        </h3>
<p id="section-8.6-1">Distribution of DAP task parameters is out of band from DAP itself and thus not
discussed in this document. This section examines the security tradeoffs
involved in the selection of the DAP task parameters. Generally, attacks
involving crafted DAP task parameters can be mitigated by having the Aggregators
refuse shared parameters that are trivially insecure (e.g., a minimum batch size
of 1 report).<a href="#section-8.6-1" class="pilcrow">¶</a></p>
<div id="predictable-or-enumerable-task-ids">
<section id="section-8.6.1">
          <h4 id="name-predictable-or-enumerable-t">
<a href="#section-8.6.1" class="section-number selfRef">8.6.1. </a><a href="#name-predictable-or-enumerable-t" class="section-name selfRef">Predictable or Enumerable Task IDs</a>
          </h4>
<p id="section-8.6.1-1">This specification imposes no requirements on task IDs except that they be
globally unique. One way to achieve this is to use random task IDs, but
deployments can also use schemes like <span>[<a href="#I-D.draft-ietf-ppm-dap-taskprov-03" class="cite xref">I-D.draft-ietf-ppm-dap-taskprov-03</a>]</span>
where task IDs are deterministically generated from some set of task parameters.<a href="#section-8.6.1-1" class="pilcrow">¶</a></p>
<p id="section-8.6.1-2">In such settings, deployments should consider whether an Aggregator
acknowledging the existence of a task (by accepting report uploads or
aggregation jobs, for example) could unintentionally leak information such as a
label describing the task, the identities of participating Aggregators or the
fact that some measurement is being taken at all.<a href="#section-8.6.1-2" class="pilcrow">¶</a></p>
<p id="section-8.6.1-3">Such enumeration attacks can be mitigated by incorporating unpredictable values
into the task ID derivation. They do not, however, affect the core security
goals of VDAFs (<span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-9" class="relref">Section 9</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span>).<a href="#section-8.6.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="verification-key">
<section id="section-8.6.2">
          <h4 id="name-vdaf-verification-key-requi">
<a href="#section-8.6.2" class="section-number selfRef">8.6.2. </a><a href="#name-vdaf-verification-key-requi" class="section-name selfRef">VDAF Verification Key Requirements</a>
          </h4>
<p id="section-8.6.2-1">Knowledge of the verification key would allow a Client to forge a report with
invalid values that will nevertheless pass verification. Therefore, the
verification key must be kept secret from Clients.<a href="#section-8.6.2-1" class="pilcrow">¶</a></p>
<p id="section-8.6.2-2">Furthermore, for a given report, it may be possible to craft a verification key
which leaks information about that report's measurement during verification.
Therefore, the verification key for a task <span class="bcp14">SHOULD</span> be chosen before any reports
are generated. To achieve this, the current design and analysis assume that
the verification key is fixed for the lifetime of the task.
One way to ensure that the verification key is generated
independently from any given report is to derive the key based on the task ID
and some previously agreed upon secret (verify_key_seed) between Aggregators,
as follows:<a href="#section-8.6.2-2" class="pilcrow">¶</a></p>
<div class="lang-pseudocode sourcecode" id="section-8.6.2-3">
<pre>
vdaf_verify_key = HKDF-Expand(
    HKDF-Extract(
        "verify_key",    # salt
        verify_key_seed, # IKM
    ),
    task_id,             # info
    VERIFY_KEY_SIZE,     # L
)
</pre><a href="#section-8.6.2-3" class="pilcrow">¶</a>
</div>
<p id="section-8.6.2-4">Here, VERIFY_KEY_SIZE is the length of the verification key, and HKDF-Extract
and HKDF-Expand are as defined in <span>[<a href="#RFC5869" class="cite xref">RFC5869</a>]</span>.<a href="#section-8.6.2-4" class="pilcrow">¶</a></p>
<p id="section-8.6.2-5">This requirement comes from current security analysis for existing VDAFs. In
particular, the security proofs for Prio3 require that the verification key is
chosen independently of the generated reports.<a href="#section-8.6.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="batch-parameters">
<section id="section-8.6.3">
          <h4 id="name-batch-parameters">
<a href="#section-8.6.3" class="section-number selfRef">8.6.3. </a><a href="#name-batch-parameters" class="section-name selfRef">Batch Parameters</a>
          </h4>
<p id="section-8.6.3-1">An important parameter of a DAP deployment is the minimum batch size. If a batch
includes too few reports, then the aggregate result can reveal information
about individual measurements. Aggregators enforce the agreed-upon minimum
batch size during collection, but implementations <span class="bcp14">SHOULD</span> also opt out of
participating in a DAP task if the minimum batch size is too small. This
document does not specify how to choose an appropriate minimum batch size, but
an appropriate value may be determined from the differential privacy (<a href="#dp" class="auto internal xref">Section 8.5</a>)
parameters in use, if any.<a href="#section-8.6.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="relaxing-report-processing-rules">
<section id="section-8.6.4">
          <h4 id="name-relaxing-report-processing-">
<a href="#section-8.6.4" class="section-number selfRef">8.6.4. </a><a href="#name-relaxing-report-processing-" class="section-name selfRef">Relaxing Report Processing Rules</a>
          </h4>
<p id="section-8.6.4-1">DAP Aggregators enforce several rules for report processing related to the
privacy of individual measurements:<a href="#section-8.6.4-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.6.4-2">
<li id="section-8.6.4-2.1">
              <p id="section-8.6.4-2.1.1">Each report may be aggregated at most once (<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>)<a href="#section-8.6.4-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.6.4-2.2">
              <p id="section-8.6.4-2.2.1">A batch bucket may be collected at most once (reports pertaining to
collected buckets are rejected; see <a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>)<a href="#section-8.6.4-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.6.4-2.3">
              <p id="section-8.6.4-2.3.1">A batch may only be collected if the number of reports aggregated exceeds
the minimum batch size (<a href="#collect-flow" class="auto internal xref">Section 4.6</a>)<a href="#section-8.6.4-2.3.1" class="pilcrow">¶</a></p>
</li>
          </ol>
<p id="section-8.6.4-3">It may be desirable to relax these rules in some applications. It may also be
safe to do so when DAP is combined with other privacy enhancements such as
differential privacy. When applications wish to relax any of one of these
requirements, they:<a href="#section-8.6.4-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8.6.4-4">
<li id="section-8.6.4-4.1">
              <p id="section-8.6.4-4.1.1"><span class="bcp14">MUST</span> adhere to the VDAF's requirements for aggregating a report more than
once. See <span><a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18#section-5.3" class="relref">Section 5.3</a> of [<a href="#VDAF" class="cite xref">VDAF</a>]</span> for details.<a href="#section-8.6.4-4.1.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-8.6.4-4.2">
              <p id="section-8.6.4-4.2.1"><span class="bcp14">SHOULD</span> define a mechanism by which each party explicitly opts into the
change in report processing rules, e.g., via a report extension
(<a href="#report-extensions" class="auto internal xref">Section 4.4.3</a>). This helps prevent an implementation from
relaxing the rules by mistake.<a href="#section-8.6.4-4.2.1" class="pilcrow">¶</a></p>
</li>
          </ol>
</section>
</div>
<div id="task-configuration-agreement-and-consistency">
<section id="section-8.6.5">
          <h4 id="name-task-configuration-agreemen">
<a href="#section-8.6.5" class="section-number selfRef">8.6.5. </a><a href="#name-task-configuration-agreemen" class="section-name selfRef">Task Configuration Agreement and Consistency</a>
          </h4>
<p id="section-8.6.5-1">In order to execute a DAP task, it is necessary for all parties to ensure they
agree on the configuration of the task. However, it is possible for a party to
participate in the execution of DAP without knowing all of the task's
parameters. For example, a Client can upload a report (<a href="#upload-flow" class="auto internal xref">Section 4.4</a>) without
knowing the minimum batch size that is enforced by the Aggregators during
collection (<a href="#collect-flow" class="auto internal xref">Section 4.6</a>).<a href="#section-8.6.5-1" class="pilcrow">¶</a></p>
<p id="section-8.6.5-2">Depending on the deployment model, agreement can require that task parameters
are visible to all parties such that each party can choose whether to
participate based on the value of any parameter. This includes the parameters
enumerated in <a href="#task-configuration" class="auto internal xref">Section 4.2</a> and any additional parameters implied by
report extensions <a href="#report-extensions" class="auto internal xref">Section 4.4.3</a> used by the task. Since meaningful
privacy requires that multiple Clients contribute to a task, they should also
share a consistent view of the task configuration.<a href="#section-8.6.5-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="infrastructure-diversity">
<section id="section-8.7">
        <h3 id="name-infrastructure-diversity">
<a href="#section-8.7" class="section-number selfRef">8.7. </a><a href="#name-infrastructure-diversity" class="section-name selfRef">Infrastructure Diversity</a>
        </h3>
<p id="section-8.7-1">DAP deployments should ensure that Aggregators do not have common dependencies
that would enable a single vendor to reassemble measurements. For example, if
all participating Aggregators stored unencrypted input shares on the same cloud
object storage service, then that cloud vendor would be able to reassemble all
the input shares and defeat privacy.<a href="#section-8.7-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="iana">
<section id="section-9">
      <h2 id="name-iana-considerations">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-9-1">This document requests registry of a new media type (<a href="#iana-media-type" class="auto internal xref">Section 9.1</a>),
creation of new codepoint registries (<a href="#iana-codepoints" class="auto internal xref">Section 9.2</a>), and registration of
an IETF URN sub-namespace (<a href="#urn-space" class="auto internal xref">Section 9.3</a>).<a href="#section-9-1" class="pilcrow">¶</a></p>
<p id="section-9-2">(RFC EDITOR: In the remainder of this section, replace "RFC XXXX" with the RFC
number assigned to this document.)<a href="#section-9-2" class="pilcrow">¶</a></p>
<div id="iana-media-type">
<section id="section-9.1">
        <h3 id="name-protocol-message-media-type">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-protocol-message-media-type" class="section-name selfRef">Protocol Message Media Type</a>
        </h3>
<p id="section-9.1-1">This specification defines a new media type used for all protocol messages:
<code>application/ppm-dap</code>. Specific message types are distinguished using a
<code>message</code> parameter.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<p id="section-9.1-2">This specification defines the following protocol messages, along with their
corresponding <code>message</code> value:<a href="#section-9.1-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-9.1-3.1">
            <p id="section-9.1-3.1.1">HpkeConfigList <a href="#hpke-config" class="auto internal xref">Section 4.4.1</a>: "hpke-config-list"<a href="#section-9.1-3.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.2">
            <p id="section-9.1-3.2.1">UploadRequest <a href="#upload-request" class="auto internal xref">Section 4.4.2</a>: "upload-req"<a href="#section-9.1-3.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.3">
            <p id="section-9.1-3.3.1">UploadErrors <a href="#upload-request" class="auto internal xref">Section 4.4.2</a>: "upload-errors"<a href="#section-9.1-3.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.4">
            <p id="section-9.1-3.4.1">AggregationJobInitReq <a href="#leader-init" class="auto internal xref">Section 4.5.2.1</a>: "aggregation-job-init-req"<a href="#section-9.1-3.4.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.5">
            <p id="section-9.1-3.5.1">AggregationJobResp <a href="#aggregation-helper-init" class="auto internal xref">Section 4.5.2.2</a>: "aggregation-job-resp"<a href="#section-9.1-3.5.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.6">
            <p id="section-9.1-3.6.1">AggregationJobContinueReq <a href="#aggregation-leader-continuation" class="auto internal xref">Section 4.5.3.1</a>: "aggregation-job-continue-req"<a href="#section-9.1-3.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.7">
            <p id="section-9.1-3.7.1">AggregateShareReq <a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a>: "aggregate-share-req"<a href="#section-9.1-3.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.8">
            <p id="section-9.1-3.8.1">AggregateShare <a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a>: "aggregate-share"<a href="#section-9.1-3.8.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.9">
            <p id="section-9.1-3.9.1">CollectionJobReq <a href="#collect-init" class="auto internal xref">Section 4.6.1</a>: "collection-job-req"<a href="#section-9.1-3.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-9.1-3.10">
            <p id="section-9.1-3.10.1">CollectionJobResp <a href="#collect-init" class="auto internal xref">Section 4.6.1</a>: "collection-job-resp"<a href="#section-9.1-3.10.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-9.1-4">For example, a request whose body consists of an <code>AggregationJobInitReq</code> could
have the header
<code>Content-Type: application/ppm-dap;message=aggregation-job-init-req</code>.<a href="#section-9.1-4" class="pilcrow">¶</a></p>
<p id="section-9.1-5">Protocol message format evolution is supported through the definition of new
formats that are identified by <code>message</code> values. The messages above are specific
to this specification. When a new major enhancement is proposed that results in
newer IETF specification for DAP, a new media type will be defined. In other
words, newer versions of DAP will not be backward compatible with this version
of DAP.<a href="#section-9.1-5" class="pilcrow">¶</a></p>
<p id="section-9.1-6">(RFC EDITOR: Remove this paragraph.) HTTP requests with DAP media types <span class="bcp14">MAY</span>
express an optional parameter 'version', following <span><a href="https://rfc-editor.org/rfc/rfc9110#section-8.3" class="relref">Section 8.3</a> of [<a href="#RFC9110" class="cite xref">RFC9110</a>]</span>.
Value of this parameter indicates current draft version of the protocol the
component is using. This <span class="bcp14">MAY</span> be used as a hint by the receiver of the request
to do compatibility checks between client and server.
For example, A report submission to leader from a client that supports
draft-ietf-ppm-dap-09 could have the header
<code>Content-Type: application/ppm-dap;message=upload-req;version=09</code>.<a href="#section-9.1-6" class="pilcrow">¶</a></p>
<p id="section-9.1-7">The "Media Types" registry at https://www.iana.org/assignments/media-types will
be (RFC EDITOR: replace "will be" with "has been") updated to include the
<code>application/ppm-dap</code> media type.<a href="#section-9.1-7" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-9.1-8">
          <dt id="section-9.1-8.1">Type name:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.2">
            <p id="section-9.1-8.2.1">application<a href="#section-9.1-8.2.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.3">Subtype name:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.4">
            <p id="section-9.1-8.4.1">ppm-dap<a href="#section-9.1-8.4.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.5">Required parameters:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.6">
            <p id="section-9.1-8.6.1">message<a href="#section-9.1-8.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.7">Optional parameters:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.8">
            <p id="section-9.1-8.8.1">None<a href="#section-9.1-8.8.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.9">Encoding considerations:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.10">
            <p id="section-9.1-8.10.1">only "8bit" or "binary" is permitted<a href="#section-9.1-8.10.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.11">Security considerations:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.12">
            <p id="section-9.1-8.12.1">see <a href="#sec-considerations" class="auto internal xref">Section 8</a> of the published specification<a href="#section-9.1-8.12.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.13">Interoperability considerations:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.14">
            <p id="section-9.1-8.14.1">N/A<a href="#section-9.1-8.14.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.15">Published specification:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.16">
            <p id="section-9.1-8.16.1">RFC XXXX<a href="#section-9.1-8.16.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.17">Applications that use this media type:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.18">
            <p id="section-9.1-8.18.1">N/A<a href="#section-9.1-8.18.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.19">Fragment identifier considerations:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.20">
            <p id="section-9.1-8.20.1">N/A<a href="#section-9.1-8.20.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.21">Additional information:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.22">
            <span class="break"></span><dl class="dlParallel" id="section-9.1-8.22.1">
              <dt id="section-9.1-8.22.1.1">Magic number(s):</dt>
              <dd style="margin-left: 1.5em" id="section-9.1-8.22.1.2">N/A<a href="#section-9.1-8.22.1.2" class="pilcrow">¶</a>
</dd>
              <dd class="break"></dd>
<dt id="section-9.1-8.22.1.3">Deprecated alias names for this type:</dt>
              <dd style="margin-left: 1.5em" id="section-9.1-8.22.1.4">N/A<a href="#section-9.1-8.22.1.4" class="pilcrow">¶</a>
</dd>
              <dd class="break"></dd>
<dt id="section-9.1-8.22.1.5">File extension(s):</dt>
              <dd style="margin-left: 1.5em" id="section-9.1-8.22.1.6">N/A<a href="#section-9.1-8.22.1.6" class="pilcrow">¶</a>
</dd>
              <dd class="break"></dd>
<dt id="section-9.1-8.22.1.7">Macintosh file type code(s):</dt>
              <dd style="margin-left: 1.5em" id="section-9.1-8.22.1.8">N/A<a href="#section-9.1-8.22.1.8" class="pilcrow">¶</a>
</dd>
            <dd class="break"></dd>
</dl>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.23">Person and email address to contact for further information:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.24">
            <p id="section-9.1-8.24.1">PPM WG mailing list (ppm@ietf.org)<a href="#section-9.1-8.24.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.25">Intended usage:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.26">
            <p id="section-9.1-8.26.1">COMMON<a href="#section-9.1-8.26.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.27">Restrictions on usage:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.28">
            <p id="section-9.1-8.28.1">N/A<a href="#section-9.1-8.28.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.29">Author:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.30">
            <p id="section-9.1-8.30.1">see Authors' Addresses section of the published specification<a href="#section-9.1-8.30.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
<dt id="section-9.1-8.31">Change controller:</dt>
          <dd style="margin-left: 1.5em" id="section-9.1-8.32">
            <p id="section-9.1-8.32.1">IETF<a href="#section-9.1-8.32.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
</dl>
</section>
</div>
<div id="iana-codepoints">
<section id="section-9.2">
        <h3 id="name-dap-type-registries">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-dap-type-registries" class="section-name selfRef">DAP Type Registries</a>
        </h3>
<p id="section-9.2-1">This document also requests creation of a new "Distributed Aggregation Protocol
(DAP)" page. This page will contain several new registries, described in the
following sections. All registries are administered under the Specification
Required policy <span>[<a href="#RFC8126" class="cite xref">RFC8126</a>]</span>.<a href="#section-9.2-1" class="pilcrow">¶</a></p>
<div id="batch-mode-reg">
<section id="section-9.2.1">
          <h4 id="name-batch-modes-registry">
<a href="#section-9.2.1" class="section-number selfRef">9.2.1. </a><a href="#name-batch-modes-registry" class="section-name selfRef">Batch Modes Registry</a>
          </h4>
<p id="section-9.2.1-1">A new registry will be (RFC EDITOR: change "will be" to "has been") created
called "DAP Batch Mode Identifiers" (<a href="#batch-modes" class="auto internal xref">Section 5</a>). This registry should
contain the following columns:<a href="#section-9.2.1-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-9.2.1-2">
            <dt id="section-9.2.1-2.1">Value:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.1-2.2">
              <p id="section-9.2.1-2.2.1">The one-byte identifier for the batch mode<a href="#section-9.2.1-2.2.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-9.2.1-2.3">Name:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.1-2.4">
              <p id="section-9.2.1-2.4.1">The name of the batch mode<a href="#section-9.2.1-2.4.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-9.2.1-2.5">Reference:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.1-2.6">
              <p id="section-9.2.1-2.6.1">Where the batch mode is defined<a href="#section-9.2.1-2.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
</dl>
<p id="section-9.2.1-3">The initial contents of this registry listed in <a href="#batch-mode-id" class="auto internal xref">Table 2</a>.<a href="#section-9.2.1-3" class="pilcrow">¶</a></p>
<span id="name-initial-contents-of-the-dap"></span><div id="batch-mode-id">
<table class="center" id="table-2">
            <caption>
<a href="#table-2" class="selfRef">Table 2</a>:
<a href="#name-initial-contents-of-the-dap" class="selfRef">Initial contents of the DAP Batch Mode Identifiers registry.</a>
            </caption>
<thead>
              <tr>
                <th class="text-left" rowspan="1" colspan="1">Value</th>
                <th class="text-left" rowspan="1" colspan="1">Name</th>
                <th class="text-left" rowspan="1" colspan="1">Reference</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x00</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>reserved</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#batch-modes" class="auto internal xref">Section 5</a> of RFC XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x01</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>time_interval</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#time-interval-batch-mode" class="auto internal xref">Section 5.1</a> of RFC XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x02</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>leader_selected</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#leader-selected-batch-mode" class="auto internal xref">Section 5.2</a> of RFC XXXX</td>
              </tr>
            </tbody>
          </table>
</div>
</section>
</div>
<div id="report-extension-registry">
<section id="section-9.2.2">
          <h4 id="name-report-extension-registry">
<a href="#section-9.2.2" class="section-number selfRef">9.2.2. </a><a href="#name-report-extension-registry" class="section-name selfRef">Report Extension Registry</a>
          </h4>
<p id="section-9.2.2-1">A new registry will be (RFC EDITOR: change "will be" to "has been") created
called "DAP Report Extension Identifiers" for extensions to the report structure
(<a href="#report-extensions" class="auto internal xref">Section 4.4.3</a>). This registry should contain the following columns:<a href="#section-9.2.2-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-9.2.2-2">
            <dt id="section-9.2.2-2.1">Value:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.2-2.2">
              <p id="section-9.2.2-2.2.1">The two-byte identifier for the upload extension<a href="#section-9.2.2-2.2.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-9.2.2-2.3">Name:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.2-2.4">
              <p id="section-9.2.2-2.4.1">The name of the upload extension<a href="#section-9.2.2-2.4.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-9.2.2-2.5">Reference:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.2-2.6">
              <p id="section-9.2.2-2.6.1">Where the upload extension is defined<a href="#section-9.2.2-2.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
</dl>
<p id="section-9.2.2-3">The initial contents of this registry are listed in <a href="#upload-extension-id" class="auto internal xref">Table 3</a>.<a href="#section-9.2.2-3" class="pilcrow">¶</a></p>
<span id="name-initial-contents-of-the-dap-"></span><div id="upload-extension-id">
<table class="center" id="table-3">
            <caption>
<a href="#table-3" class="selfRef">Table 3</a>:
<a href="#name-initial-contents-of-the-dap-" class="selfRef">Initial contents of the DAP Report Extension Identifiers registry.</a>
            </caption>
<thead>
              <tr>
                <th class="text-left" rowspan="1" colspan="1">Value</th>
                <th class="text-left" rowspan="1" colspan="1">Name</th>
                <th class="text-left" rowspan="1" colspan="1">Reference</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x0000</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>reserved</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">RFC XXXX</td>
              </tr>
            </tbody>
          </table>
</div>
</section>
</div>
<div id="report-error-reg">
<section id="section-9.2.3">
          <h4 id="name-report-error-registry">
<a href="#section-9.2.3" class="section-number selfRef">9.2.3. </a><a href="#name-report-error-registry" class="section-name selfRef">Report Error Registry</a>
          </h4>
<p id="section-9.2.3-1">A new registry will be (RFC EDITOR: change "will be" to "has been") created
called "DAP Report Error Identifiers" for reasons for rejecting reports during
the aggregation interaction (<a href="#aggregation-helper-init" class="auto internal xref">Section 4.5.2.2</a>).<a href="#section-9.2.3-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-9.2.3-2">
            <dt id="section-9.2.3-2.1">Value:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.3-2.2">
              <p id="section-9.2.3-2.2.1">The one-byte identifier of the report error<a href="#section-9.2.3-2.2.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-9.2.3-2.3">Name:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.3-2.4">
              <p id="section-9.2.3-2.4.1">The name of the report error<a href="#section-9.2.3-2.4.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-9.2.3-2.5">Reference:</dt>
            <dd style="margin-left: 1.5em" id="section-9.2.3-2.6">
              <p id="section-9.2.3-2.6.1">Where the report error is defined<a href="#section-9.2.3-2.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
</dl>
<p id="section-9.2.3-3">The initial contents of this registry are listed below in <a href="#report-error-id" class="auto internal xref">Table 4</a>.<a href="#section-9.2.3-3" class="pilcrow">¶</a></p>
<span id="name-initial-contents-of-the-dap-r"></span><div id="report-error-id">
<table class="center" id="table-4">
            <caption>
<a href="#table-4" class="selfRef">Table 4</a>:
<a href="#name-initial-contents-of-the-dap-r" class="selfRef">Initial contents of the DAP Report Error Identifiers registry.</a>
            </caption>
<thead>
              <tr>
                <th class="text-left" rowspan="1" colspan="1">Value</th>
                <th class="text-left" rowspan="1" colspan="1">Name</th>
                <th class="text-left" rowspan="1" colspan="1">Reference</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x00</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>reserved</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x01</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>batch_collected</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x02</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>report_replayed</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x03</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>report_dropped</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x04</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>hpke_unknown_config_id</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x05</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>hpke_decrypt_error</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x06</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>vdaf_verify_error</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x07</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>task_expired</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x08</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>invalid_message</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x09</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>report_too_early</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x0A</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>task_not_started</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
              <tr>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>0x0B</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <code>outdated_config</code>
</td>
                <td class="text-left" rowspan="1" colspan="1">
                  <a href="#basic-definitions" class="auto internal xref">Section 4.1</a> of RFX XXXX</td>
              </tr>
            </tbody>
          </table>
</div>
</section>
</div>
<div id="guidance-for-designated-experts">
<section id="section-9.2.4">
          <h4 id="name-guidance-for-designated-exp">
<a href="#section-9.2.4" class="section-number selfRef">9.2.4. </a><a href="#name-guidance-for-designated-exp" class="section-name selfRef">Guidance for Designated Experts</a>
          </h4>
<p id="section-9.2.4-1">When reviewing requests to extend a DAP registry, experts should ensure that a
document exists that defines the newly registered items and review the document
to ensure it meets the criteria for extending DAP specified in
<a href="#extending-this-doc" class="auto internal xref">Section 10</a>.<a href="#section-9.2.4-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="urn-space">
<section id="section-9.3">
        <h3 id="name-urn-sub-namespace-for-dap-u">
<a href="#section-9.3" class="section-number selfRef">9.3. </a><a href="#name-urn-sub-namespace-for-dap-u" class="section-name selfRef">URN Sub-namespace for DAP (urn:ietf:params:ppm:dap)</a>
        </h3>
<p id="section-9.3-1">The following value will be (RFC EDITOR: change "will be" to "has been")
registered in the "IETF URN Sub-namespace for Registered Protocol
Parameter Identifiers" registry, following the template in <span>[<a href="#RFC3553" class="cite xref">RFC3553</a>]</span>:<a href="#section-9.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-9.3-2">
<pre>
Registry name:  dap

Specification:  RFC XXXX

Repository:  http://www.iana.org/assignments/dap

Index value:  No transformation needed.
</pre><a href="#section-9.3-2" class="pilcrow">¶</a>
</div>
<p id="section-9.3-3">The initial contents of this namespace are the types and descriptions in
<a href="#urn-space-errors" class="auto internal xref">Table 1</a>, with the Reference field set to RFC XXXX.<a href="#section-9.3-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="extending-this-doc">
<section id="section-10">
      <h2 id="name-extending-this-document">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-extending-this-document" class="section-name selfRef">Extending this Document</a>
      </h2>
<p id="section-10-1">The behavior of DAP may be extended or modified by future documents defining
one or more of the following:<a href="#section-10-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-10-2">
<li id="section-10-2.1">
          <p id="section-10-2.1.1">a new batch mode (<a href="#batch-modes" class="auto internal xref">Section 5</a>)<a href="#section-10-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-10-2.2">
          <p id="section-10-2.2.1">a new report extension (<a href="#report-extensions" class="auto internal xref">Section 4.4.3</a>)<a href="#section-10-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-10-2.3">
          <p id="section-10-2.3.1">a new report error (<a href="#aggregation-helper-init" class="auto internal xref">Section 4.5.2.2</a>)<a href="#section-10-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li id="section-10-2.4">
          <p id="section-10-2.4.1">a new entry in the URN sub-namespace for DAP (<a href="#urn-space-errors" class="auto internal xref">Table 1</a>)<a href="#section-10-2.4.1" class="pilcrow">¶</a></p>
</li>
      </ol>
<p id="section-10-3">Each of these requires registration of a codepoint or other value; see
<a href="#iana" class="auto internal xref">Section 9</a>. No other considerations are required except in the following cases:<a href="#section-10-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-4.1">
          <p id="section-10-4.1.1">When a document defines a new batch mode, it <span class="bcp14">MUST</span> include a section titled
"DAP Batch Mode Considerations" specifying the following:<a href="#section-10-4.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10-4.1.2.1">
              <p id="section-10-4.1.2.1.1">The value of the <code>config</code> field of <code>Query</code>, <code>PartialBatchSelector</code>, and
<code>BatchSelector</code><a href="#section-10-4.1.2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-10-4.1.2.2">
              <p id="section-10-4.1.2.2.1">Batch buckets (<a href="#batch-buckets" class="auto internal xref">Section 4.5.3.3</a>): how reports are assigned to batch
buckets; how each bucket is identified; and how batch buckets are mapped
to batches.<a href="#section-10-4.1.2.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-10-4.1.3">
See <a href="#batch-modes" class="auto internal xref">Section 5</a> for examples.<a href="#section-10-4.1.3" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-10-4.2">
          <p id="section-10-4.2.1">When a document defines a new report extension, it <span class="bcp14">SHOULD</span> include in its
"Security Considerations" section some discussion of how the extension
impacts the security of DAP with respect to the threat model in
<a href="#sec-considerations" class="auto internal xref">Section 8</a>.<a href="#section-10-4.2.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<div id="sec-combined-references">
<section id="section-11">
      <h2 id="name-references">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<div id="sec-normative-references">
<section id="section-11.1">
        <h3 id="name-normative-references">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="HPKE">[HPKE]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Bhargavan, K.</span>, <span class="refAuthor">Lipp, B.</span>, and <span class="refAuthor">C. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="seriesInfo">RFC 9180</span>, <span class="seriesInfo">DOI 10.17487/RFC9180</span>, <time datetime="2022-02" class="refDate">February 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9180">https://www.rfc-editor.org/rfc/rfc9180</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="POSIX">[POSIX]</dt>
        <dd>
<span class="refTitle">"IEEE Standard for Information Technology--Portable Operating System Interface (POSIX(TM)) Base Specifications, Issue 7"</span>, <span class="refContent">IEEE</span>, <span class="seriesInfo">DOI 10.1109/ieeestd.2018.8277153</span>, <span class="seriesInfo">ISBN ["9781504445429"]</span>, <time datetime="2018-01" class="refDate">January 2018</time>, <span>&lt;<a href="https://doi.org/10.1109/ieeestd.2018.8277153">https://doi.org/10.1109/ieeestd.2018.8277153</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3553">[RFC3553]</dt>
        <dd>
<span class="refAuthor">Mealling, M.</span>, <span class="refAuthor">Masinter, L.</span>, <span class="refAuthor">Hardie, T.</span>, and <span class="refAuthor">G. Klyne</span>, <span class="refTitle">"An IETF URN Sub-namespace for Registered Protocol Parameters"</span>, <span class="seriesInfo">BCP 73</span>, <span class="seriesInfo">RFC 3553</span>, <span class="seriesInfo">DOI 10.17487/RFC3553</span>, <time datetime="2003-06" class="refDate">June 2003</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc3553">https://www.rfc-editor.org/rfc/rfc3553</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4648">[RFC4648]</dt>
        <dd>
<span class="refAuthor">Josefsson, S.</span>, <span class="refTitle">"The Base16, Base32, and Base64 Data Encodings"</span>, <span class="seriesInfo">RFC 4648</span>, <span class="seriesInfo">DOI 10.17487/RFC4648</span>, <time datetime="2006-10" class="refDate">October 2006</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc4648">https://www.rfc-editor.org/rfc/rfc4648</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7807">[RFC7807]</dt>
        <dd>
<span class="refAuthor">Nottingham, M.</span> and <span class="refAuthor">E. Wilde</span>, <span class="refTitle">"Problem Details for HTTP APIs"</span>, <span class="seriesInfo">RFC 7807</span>, <span class="seriesInfo">DOI 10.17487/RFC7807</span>, <time datetime="2016-03" class="refDate">March 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc7807">https://www.rfc-editor.org/rfc/rfc7807</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8126">[RFC8126]</dt>
        <dd>
<span class="refAuthor">Cotton, M.</span>, <span class="refAuthor">Leiba, B.</span>, and <span class="refAuthor">T. Narten</span>, <span class="refTitle">"Guidelines for Writing an IANA Considerations Section in RFCs"</span>, <span class="seriesInfo">BCP 26</span>, <span class="seriesInfo">RFC 8126</span>, <span class="seriesInfo">DOI 10.17487/RFC8126</span>, <time datetime="2017-06" class="refDate">June 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8126">https://www.rfc-editor.org/rfc/rfc8126</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08" class="refDate">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8446">https://www.rfc-editor.org/rfc/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8792">[RFC8792]</dt>
        <dd>
<span class="refAuthor">Watsen, K.</span>, <span class="refAuthor">Auerswald, E.</span>, <span class="refAuthor">Farrel, A.</span>, and <span class="refAuthor">Q. Wu</span>, <span class="refTitle">"Handling Long Lines in Content of Internet-Drafts and RFCs"</span>, <span class="seriesInfo">RFC 8792</span>, <span class="seriesInfo">DOI 10.17487/RFC8792</span>, <time datetime="2020-06" class="refDate">June 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8792">https://www.rfc-editor.org/rfc/rfc8792</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9110">[RFC9110]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span>, <span class="refAuthor">Nottingham, M., Ed.</span>, and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"HTTP Semantics"</span>, <span class="seriesInfo">STD 97</span>, <span class="seriesInfo">RFC 9110</span>, <span class="seriesInfo">DOI 10.17487/RFC9110</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9110">https://www.rfc-editor.org/rfc/rfc9110</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9111">[RFC9111]</dt>
        <dd>
<span class="refAuthor">Fielding, R., Ed.</span>, <span class="refAuthor">Nottingham, M., Ed.</span>, and <span class="refAuthor">J. Reschke, Ed.</span>, <span class="refTitle">"HTTP Caching"</span>, <span class="seriesInfo">STD 98</span>, <span class="seriesInfo">RFC 9111</span>, <span class="seriesInfo">DOI 10.17487/RFC9111</span>, <time datetime="2022-06" class="refDate">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9111">https://www.rfc-editor.org/rfc/rfc9111</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9457">[RFC9457]</dt>
        <dd>
<span class="refAuthor">Nottingham, M.</span>, <span class="refAuthor">Wilde, E.</span>, and <span class="refAuthor">S. Dalal</span>, <span class="refTitle">"Problem Details for HTTP APIs"</span>, <span class="seriesInfo">RFC 9457</span>, <span class="seriesInfo">DOI 10.17487/RFC9457</span>, <time datetime="2023-07" class="refDate">July 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9457">https://www.rfc-editor.org/rfc/rfc9457</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9458">[RFC9458]</dt>
        <dd>
<span class="refAuthor">Thomson, M.</span> and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Oblivious HTTP"</span>, <span class="seriesInfo">RFC 9458</span>, <span class="seriesInfo">DOI 10.17487/RFC9458</span>, <time datetime="2024-01" class="refDate">January 2024</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9458">https://www.rfc-editor.org/rfc/rfc9458</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="SHS">[SHS]</dt>
        <dd>
<span class="refTitle">"Secure hash standard"</span>, <span class="refContent">National Institute of Standards and Technology (U.S.)</span>, <span class="seriesInfo">DOI 10.6028/nist.fips.180-4</span>, <time datetime="2015" class="refDate">2015</time>, <span>&lt;<a href="https://doi.org/10.6028/nist.fips.180-4">https://doi.org/10.6028/nist.fips.180-4</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="VDAF">[VDAF]</dt>
      <dd>
<span class="refAuthor">Barnes, R.</span>, <span class="refAuthor">Cook, D.</span>, <span class="refAuthor">Patton, C.</span>, and <span class="refAuthor">P. Schoppmann</span>, <span class="refTitle">"Verifiable Distributed Aggregation Functions"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-vdaf-18</span>, <time datetime="2026-01-30" class="refDate">30 January 2026</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18">https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-vdaf-18</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
<div id="sec-informative-references">
<section id="section-11.2">
        <h3 id="name-informative-references">
<a href="#section-11.2" class="section-number selfRef">11.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="Dou02">[Dou02]</dt>
        <dd>
<span class="refAuthor">Douceur, J. R.</span>, <span class="refTitle">"The Sybil Attack"</span>, <span class="refContent">International Workshop on Peer-to-Peer Systems (IPTPS)</span>, <time datetime="2002" class="refDate">2002</time>, <span>&lt;<a href="https://doi.org/10.1007/3-540-45748-8_24">https://doi.org/10.1007/3-540-45748-8_24</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="DPRS23">[DPRS23]</dt>
        <dd>
<span class="refAuthor">Davis, H.</span>, <span class="refAuthor">Patton, C.</span>, <span class="refAuthor">Rosulek, M.</span>, and <span class="refAuthor">P. Schoppmann</span>, <span class="refTitle">"Verifiable Distributed Aggregation Functions"</span>, <span class="refContent">Privacy Enhancing Technologies Symposium (PETS)</span>, <time datetime="2024-09-25" class="refDate">25 September 2024</time>, <span>&lt;<a href="https://ia.cr/2023/130/20240925:184929">https://ia.cr/2023/130/20240925:184929</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.draft-ietf-ppm-dap-taskprov-03">[I-D.draft-ietf-ppm-dap-taskprov-03]</dt>
        <dd>
<span class="refAuthor">Wang, S.</span> and <span class="refAuthor">C. Patton</span>, <span class="refTitle">"Task Binding and In-Band Provisioning for DAP"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-ppm-dap-taskprov-03</span>, <time datetime="2025-09-05" class="refDate">5 September 2025</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-taskprov-03">https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-taskprov-03</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="OAuth2">[OAuth2]</dt>
        <dd>
<span class="refAuthor">Hardt, D., Ed.</span>, <span class="refTitle">"The OAuth 2.0 Authorization Framework"</span>, <span class="seriesInfo">RFC 6749</span>, <span class="seriesInfo">DOI 10.17487/RFC6749</span>, <time datetime="2012-10" class="refDate">October 2012</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc6749">https://www.rfc-editor.org/rfc/rfc6749</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC5869">[RFC5869]</dt>
        <dd>
<span class="refAuthor">Krawczyk, H.</span> and <span class="refAuthor">P. Eronen</span>, <span class="refTitle">"HMAC-based Extract-and-Expand Key Derivation Function (HKDF)"</span>, <span class="seriesInfo">RFC 5869</span>, <span class="seriesInfo">DOI 10.17487/RFC5869</span>, <time datetime="2010-05" class="refDate">May 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc5869">https://www.rfc-editor.org/rfc/rfc5869</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9421">[RFC9421]</dt>
        <dd>
<span class="refAuthor">Backman, A., Ed.</span>, <span class="refAuthor">Richer, J., Ed.</span>, and <span class="refAuthor">M. Sporny</span>, <span class="refTitle">"HTTP Message Signatures"</span>, <span class="seriesInfo">RFC 9421</span>, <span class="seriesInfo">DOI 10.17487/RFC9421</span>, <time datetime="2024-02" class="refDate">February 2024</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9421">https://www.rfc-editor.org/rfc/rfc9421</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9576">[RFC9576]</dt>
        <dd>
<span class="refAuthor">Davidson, A.</span>, <span class="refAuthor">Iyengar, J.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"The Privacy Pass Architecture"</span>, <span class="seriesInfo">RFC 9576</span>, <span class="seriesInfo">DOI 10.17487/RFC9576</span>, <time datetime="2024-06" class="refDate">June 2024</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc9576">https://www.rfc-editor.org/rfc/rfc9576</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="Vad16">[Vad16]</dt>
      <dd>
<span class="refAuthor">Vadhan, S.</span>, <span class="refTitle">"The Complexity of Differential Privacy"</span>, <time datetime="2016" class="refDate">2016</time>, <span>&lt;<a href="https://privacytools.seas.harvard.edu/files/privacytools/files/complexityprivacy_1.pdf">https://privacytools.seas.harvard.edu/files/privacytools/files/complexityprivacy_1.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
<div id="http-resources-reference">
<section id="appendix-A">
      <h2 id="name-http-resources-reference">
<a href="#appendix-A" class="section-number selfRef">Appendix A. </a><a href="#name-http-resources-reference" class="section-name selfRef">HTTP Resources Reference</a>
      </h2>
<p id="appendix-A-1">This appendix enumerates all the HTTP resources this document describes, the
HTTP methods that they support and media-types that may occur in requests and
responses. It is organized by the protocol role that serves the resource.<a href="#appendix-A-1" class="pilcrow">¶</a></p>
<p id="appendix-A-2">This section is intended to act as a reference and checklist for implementers.
The HTTP methods and media-types described in this appendix are not
authoritative. See the section that each resource refers to for detailed
specifications.<a href="#appendix-A-2" class="pilcrow">¶</a></p>
<div id="aggregator">
<section id="appendix-A.1">
        <h3 id="name-aggregator">
<a href="#appendix-A.1" class="section-number selfRef">A.1. </a><a href="#name-aggregator" class="section-name selfRef">Aggregator</a>
        </h3>
<div id="hpke-configurations">
<section id="appendix-A.1.1">
          <h4 id="name-hpke-configurations">
<a href="#appendix-A.1.1" class="section-number selfRef">A.1.1. </a><a href="#name-hpke-configurations" class="section-name selfRef">HPKE Configurations</a>
          </h4>
<p id="appendix-A.1.1-1">Aggregator HPKE configurations to which Clients will encrypt report shares.<a href="#appendix-A.1.1-1" class="pilcrow">¶</a></p>
<p id="appendix-A.1.1-2">Resource URL: <code>{aggregator}/hpke_config</code><a href="#appendix-A.1.1-2" class="pilcrow">¶</a></p>
<p id="appendix-A.1.1-3">HTTP methods: GET<a href="#appendix-A.1.1-3" class="pilcrow">¶</a></p>
<p id="appendix-A.1.1-4">Request media-type <code>message</code> values: N/A<a href="#appendix-A.1.1-4" class="pilcrow">¶</a></p>
<p id="appendix-A.1.1-5">Response media-type <code>message</code> values: <code>hpke-config-list</code><a href="#appendix-A.1.1-5" class="pilcrow">¶</a></p>
<p id="appendix-A.1.1-6">Reference: <a href="#hpke-config" class="auto internal xref">Section 4.4.1</a><a href="#appendix-A.1.1-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="leader">
<section id="appendix-A.2">
        <h3 id="name-leader">
<a href="#appendix-A.2" class="section-number selfRef">A.2. </a><a href="#name-leader" class="section-name selfRef">Leader</a>
        </h3>
<div id="reports">
<section id="appendix-A.2.1">
          <h4 id="name-reports">
<a href="#appendix-A.2.1" class="section-number selfRef">A.2.1. </a><a href="#name-reports" class="section-name selfRef">Reports</a>
          </h4>
<p id="appendix-A.2.1-1">Reports being uploaded to the Leader by the Client.<a href="#appendix-A.2.1-1" class="pilcrow">¶</a></p>
<p id="appendix-A.2.1-2">Resource URL: <code>{leader}/tasks/{task-id}/reports</code><a href="#appendix-A.2.1-2" class="pilcrow">¶</a></p>
<p id="appendix-A.2.1-3">HTTP methods: POST<a href="#appendix-A.2.1-3" class="pilcrow">¶</a></p>
<p id="appendix-A.2.1-4">Request media-type <code>message</code> values: <code>upload-req</code><a href="#appendix-A.2.1-4" class="pilcrow">¶</a></p>
<p id="appendix-A.2.1-5">Response media-type <code>message</code> values: <code>upload-errors</code><a href="#appendix-A.2.1-5" class="pilcrow">¶</a></p>
<p id="appendix-A.2.1-6">Reference: <a href="#upload-request" class="auto internal xref">Section 4.4.2</a><a href="#appendix-A.2.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="collection-jobs">
<section id="appendix-A.2.2">
          <h4 id="name-collection-jobs">
<a href="#appendix-A.2.2" class="section-number selfRef">A.2.2. </a><a href="#name-collection-jobs" class="section-name selfRef">Collection Jobs</a>
          </h4>
<p id="appendix-A.2.2-1">A Collector's request to collect reports identified by some query.<a href="#appendix-A.2.2-1" class="pilcrow">¶</a></p>
<p id="appendix-A.2.2-2">Resource URL: <code>{leader}/tasks/{task-id}/collection_jobs/{collection-job-id}</code><a href="#appendix-A.2.2-2" class="pilcrow">¶</a></p>
<p id="appendix-A.2.2-3">HTTP methods: PUT, GET<a href="#appendix-A.2.2-3" class="pilcrow">¶</a></p>
<p id="appendix-A.2.2-4">Request media-type <code>message</code> values: <code>collection-job-req</code><a href="#appendix-A.2.2-4" class="pilcrow">¶</a></p>
<p id="appendix-A.2.2-5">Response media-type <code>message</code> values: <code>collection-job-resp</code><a href="#appendix-A.2.2-5" class="pilcrow">¶</a></p>
<p id="appendix-A.2.2-6">Reference: <a href="#collect-flow" class="auto internal xref">Section 4.6</a><a href="#appendix-A.2.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="helper">
<section id="appendix-A.3">
        <h3 id="name-helper">
<a href="#appendix-A.3" class="section-number selfRef">A.3. </a><a href="#name-helper" class="section-name selfRef">Helper</a>
        </h3>
<div id="aggregation-jobs">
<section id="appendix-A.3.1">
          <h4 id="name-aggregation-jobs">
<a href="#appendix-A.3.1" class="section-number selfRef">A.3.1. </a><a href="#name-aggregation-jobs" class="section-name selfRef">Aggregation Jobs</a>
          </h4>
<p id="appendix-A.3.1-1">An aggregation job created by the Leader.<a href="#appendix-A.3.1-1" class="pilcrow">¶</a></p>
<p id="appendix-A.3.1-2">Resource URL: <code>/tasks/{task-id}/aggregation_jobs/{aggregation-job-id}</code><a href="#appendix-A.3.1-2" class="pilcrow">¶</a></p>
<p id="appendix-A.3.1-3">HTTP methods: PUT, POST, GET<a href="#appendix-A.3.1-3" class="pilcrow">¶</a></p>
<p id="appendix-A.3.1-4">Request media-type <code>message</code> values: <code>aggregation-job-init-req</code>,
<code>aggregation-job-continue-req</code><a href="#appendix-A.3.1-4" class="pilcrow">¶</a></p>
<p id="appendix-A.3.1-5">Response media-type <code>message</code> values: <code>aggregation-job-resp</code><a href="#appendix-A.3.1-5" class="pilcrow">¶</a></p>
<p id="appendix-A.3.1-6">Reference: <a href="#aggregate-flow" class="auto internal xref">Section 4.5</a><a href="#appendix-A.3.1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="aggregate-shares">
<section id="appendix-A.3.2">
          <h4 id="name-aggregate-shares">
<a href="#appendix-A.3.2" class="section-number selfRef">A.3.2. </a><a href="#name-aggregate-shares" class="section-name selfRef">Aggregate Shares</a>
          </h4>
<p id="appendix-A.3.2-1">The Helper's share of an aggregation over the reports identified by the
Collector's query.<a href="#appendix-A.3.2-1" class="pilcrow">¶</a></p>
<p id="appendix-A.3.2-2">Resource URL: <code>{helper}/tasks/{task-id}/aggregate_shares/{aggregate-share-id}</code><a href="#appendix-A.3.2-2" class="pilcrow">¶</a></p>
<p id="appendix-A.3.2-3">HTTP methods: PUT, GET<a href="#appendix-A.3.2-3" class="pilcrow">¶</a></p>
<p id="appendix-A.3.2-4">Request media-type <code>message</code> values: <code>aggregate-share-req</code><a href="#appendix-A.3.2-4" class="pilcrow">¶</a></p>
<p id="appendix-A.3.2-5">Response media-type <code>message</code> values: <code>aggregate-share</code><a href="#appendix-A.3.2-5" class="pilcrow">¶</a></p>
<p id="appendix-A.3.2-6">Reference: <a href="#collect-aggregate" class="auto internal xref">Section 4.6.3</a><a href="#appendix-A.3.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="contributors">
<section id="appendix-B">
      <h2 id="name-contributors">
<a href="#name-contributors" class="section-name selfRef">Contributors</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Josh Aas</span></div>
<div dir="auto" class="left"><span class="org">ISRG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:josh@abetterinternet.org" class="email">josh@abetterinternet.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Junye Chen</span></div>
<div dir="auto" class="left"><span class="org">Apple</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:junyec@apple.com" class="email">junyec@apple.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">David Cook</span></div>
<div dir="auto" class="left"><span class="org">ISRG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:dcook@divviup.org" class="email">dcook@divviup.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Suman Ganta</span></div>
<div dir="auto" class="left"><span class="org">Apple</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:sganta2@apple.com" class="email">sganta2@apple.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Ameer Ghani</span></div>
<div dir="auto" class="left"><span class="org">ISRG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:inahga@divviup.org" class="email">inahga@divviup.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Kristine Guo</span></div>
<div dir="auto" class="left"><span class="org">Apple</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:kristine_guo@apple.com" class="email">kristine_guo@apple.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Charlie Harrison</span></div>
<div dir="auto" class="left"><span class="org">Google</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:csharrison@chromium.org" class="email">csharrison@chromium.org</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">J.C. Jones</span></div>
<div dir="auto" class="left"><span class="org">ISRG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@insufficient.coffee" class="email">ietf@insufficient.coffee</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Alex Koshelev</span></div>
<div dir="auto" class="left"><span class="org">Meta</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:koshelev@meta.com" class="email">koshelev@meta.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Peter Saint-Andre</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:stpeter@gmail.com" class="email">stpeter@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Shivan Sahib</span></div>
<div dir="auto" class="left"><span class="org">Brave</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:shivankaulsahib@gmail.com" class="email">shivankaulsahib@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Phillipp Schoppmann</span></div>
<div dir="auto" class="left"><span class="org">Google</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:schoppmann@google.com" class="email">schoppmann@google.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Martin Thomson</span></div>
<div dir="auto" class="left"><span class="org">Mozilla</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:mt@mozilla.com" class="email">mt@mozilla.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Shan Wang</span></div>
<div dir="auto" class="left"><span class="org">Apple</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:shan_wang@apple.com" class="email">shan_wang@apple.com</a>
</div>
</address>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-C">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Tim Geoghegan</span></div>
<div dir="auto" class="left"><span class="org">ISRG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:timgeog+ietf@gmail.com" class="email">timgeog+ietf@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher Patton</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:chrispatton+ietf@gmail.com" class="email">chrispatton+ietf@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Brandon Pitman</span></div>
<div dir="auto" class="left"><span class="org">ISRG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:bran@bran.land" class="email">bran@bran.land</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Eric Rescorla</span></div>
<div dir="auto" class="left"><span class="org">Independent</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ekr@rtfm.com" class="email">ekr@rtfm.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher A. Wood</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:caw@heapingbits.net" class="email">caw@heapingbits.net</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
